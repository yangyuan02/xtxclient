!function(){"use strict";var videoPlayer=angular.module("angular-chat",["ChatModel"]);videoPlayer.directive("chatBox",["$rootScope","$templateCache","$compile","$stateParams","$location","ChatModel","CommonProvider","appConfig",function($rootScope,$templateCache,$compile,$stateParams,$location,ChatModel,CommonProvider,appConfig){return{restrict:"A",replace:!0,scope:{roomid:"=roomId",isPlayback:"=isPlayback"},templateUrl:"partials/home/course/chatbox.html",link:function($scope,element,attrs){if($scope.messages=[],$scope.historys=[],$scope.section=$stateParams.section_id||!1,$scope.room={id:$scope.roomid,user:$rootScope.user,uid:$rootScope.user.id,pwd:$rootScope.user.phone,playback:$scope.isPlayback||!1,faces:Easemob.im.EMOTIONS,logined:!1,occupants:[],error:!1},$scope.chat={content:"",emotion:{show:!1},pictype:["jpg","gif","png","bmp"],notification:!1},$scope.imagePreview=function(image){return $rootScope.modal.imagePreview(image)},!$scope.room.id||!$scope.room.uid||!$scope.room.pwd){if($scope.room.playback||($scope.room.error=!0),$scope.room.playback){$scope.messages.push({msg_type:"status",content:"历史讨论记录"});var getMoreHistory=function(params){var params=params||{};CommonProvider.promise({model:ChatModel,method:"message",params:{section_id:$scope.section,page:params.page||1,per_page:10},success:function(messages){0==messages.pagination.total&&$scope.messages.push({msg_type:"status",content:"无历史讨论"}),$scope.historys=messages;for(var current_user,messages=messages.result,occupants=angular.copy($scope.room.occupants),i=0;i<messages.length;i++)current_user=Number(messages[i].from),$scope.room.occupants.contain(current_user)||$scope.room.occupants.push(current_user),messages[i].date=messages[i].ext.weichat.date||moment(messages[i].send_time).format("YYYY-MM-DD HH:mm:ss"),"txt"==messages[i].msg_type&&(messages[i].data=Easemob.im.Utils.parseLink(Easemob.im.Utils.parseEmotions(messages[i].msg))),"img"==messages[i].msg_type&&(messages[i].url=appConfig.fileUrl+messages[i].url,messages[i].data='<a href="" onclick="angular.element(this).scope().imagePreview(\''+messages[i].url+'\');return false;"><img src="'+messages[i].url+'"></a>');occupants.toString()!=$scope.room.occupants.toString()&&$scope.room.occupants.length&&$scope.$emit("chatRoomUserChanged",$scope.room.occupants),$scope.messages=$scope.messages.concat(messages)}})};getMoreHistory(),$("#J_chat_lists").scroll(function(){if(this.scrollTop+this.offsetHeight>=this.scrollHeight){var historys=$scope.historys;if(historys.pagination.current_page<historys.pagination.total_page)getMoreHistory({page:historys.pagination.current_page+1});else{if("status"==$scope.messages.last().msg_type)return!1;$scope.$apply(function(){$scope.messages.push({msg_type:"status",content:"没有更多记录"})})}}})}return!1}var emitOccupants=function(){var occupants=$scope.room.occupants;occupants.length&&$scope.$emit("chatRoomUserChanged",occupants)};$("body").click(function(event){var is_emotion_box="J_emotion_box"==$(event.toElement).attr("id")||$(event.toElement).hasClass("chat-tool-btn")||$(event.toElement).hasClass("icon")||$(event.toElement).parents("#J_emotion_box").length>0;!is_emotion_box&&$scope.chat.emotion.show&&$scope.$apply(function(){$scope.chat.emotion.show=!1})}),$scope.authorizeNotification=function(){Notification.requestPermission(function(permission){$scope.chat.notification=permission})},$scope.showNotification=function(message){if("granted"!=$scope.chat.notification)return!1;if(message.from==$scope.room.uid)return!1;new Notification("收到来自学天下直播室的新消息",{dir:"auto",lang:"",body:message.msg||message.content||(0==message.data.indexOf("<img")?"[表情]":"<"==message.data[0]?"[图片]":message.data),tag:message})},$scope.addEmotion=function(key){$scope.chat.content+=key,$scope.chat.emotion.show=!1};var conn=new Easemob.im.Connection({multiResources:Easemob.im.config.multiResources,https:Easemob.im.config.https,url:Easemob.im.config.xmppURL}),login=function(){conn.open({user:$scope.room.uid.toString(),pwd:$scope.room.pwd,appKey:"xuetianxia#xuetianxia-chat"})};login();var appendMsgTimer,logout=function(){conn.close(),conn.clear()},joinRoom=function(){conn.joinChatRoom({roomId:$scope.room.id}),queryOccupants()},queryOccupants=function(){conn.queryRoomOccupants({roomId:$scope.room.id,success:function(members){var occupants=[];if(members)for(var i=0;i<members.length;i++){var jid=members[i].jid;jid=jid.right(jid.length-jid.find("easemob.com/")),occupants.push(Number(jid))}$scope.room.occupants=occupants,emitOccupants()}})},appendMsg=function(message){$scope.messages.push(message);var listAutoToBottom=function(){$scope.showNotification(message);var $lists=$("#J_chat_lists");$lists[0]&&$lists[0].scrollHeight&&$lists.animate({scrollTop:$lists[0].scrollHeight},"slow")};return appendMsgTimer&&clearTimeout(appendMsgTimer),message.click?appendMsgTimer=setTimeout(listAutoToBottom,300):void(appendMsgTimer=setTimeout(listAutoToBottom,800))},appendStatusMsg=function(message){appendMsg({content:message,msg_type:"status"})};$scope.sendTextMessage=function(msg){if(!msg)return!1;var message={to:$scope.room.id,msg:msg,ext:{weichat:{date:moment().format("YYYY-MM-DD HH:mm:ss"),user:{name:$scope.room.user.name,gravatar:$scope.room.user.gravatar}}},type:"groupchat",roomType:"chatroom"};conn.sendTextMessage(message),message.data=Easemob.im.Utils.parseLink(Easemob.im.Utils.parseEmotions(msg)),message.date=message.ext.weichat.date||moment().format("YYYY-MM-DD HH:mm:ss"),message.from=$scope.room.uid,message.click=!0,$scope.chat.content="",appendMsg(message)},$scope.sendPicMessage=function(){var fileObj=Easemob.im.Helper.getFileUrl("J_emotion_pic");if(Easemob.im.Helper.isCanUploadFileAsync&&(null==fileObj.url||""==fileObj.url))return console.warn("未选择图片");var filetype=fileObj.filetype,filename=fileObj.filename;if(!Easemob.im.Helper.isCanUploadFileAsync||$scope.chat.pictype.contain(filetype)){var options={type:"groupchat",roomType:"chatroom",to:$scope.room.id,ext:{weichat:{date:moment().format("YYYY-MM-DD HH:mm:ss"),user:{name:$scope.room.user.name,gravatar:$scope.room.user.gravatar}}},fileInputId:"J_emotion_pic",filename:filename,apiUrl:Easemob.im.config.apiURL,onFileUploadError:function(error){console.log(error)},onFileUploadComplete:function(data){var img_src=fileObj.url||data.uri+"/"+data.entities[0].uuid,send_date=data.timestamp?moment(data.timestamp).format("YYYY-MM-DD HH:mm:ss"):moment().format("YYYY-MM-DD HH:mm:ss");appendMsg({click:!0,type:"groupchat",roomType:"chatroom",from:$scope.room.uid,to:$scope.room.id,data:'<a href="" onclick="angular.element(this).scope().imagePreview(\''+img_src+'\');return false;"><img src="'+img_src+'"></a>',date:send_date,ext:{weichat:{date:send_date,user:{name:$scope.room.user.name,gravatar:$scope.room.user.gravatar}}}}),$scope.$apply()}};conn.sendPicture(options)}else $rootScope.modal.error({message:"不支持此图片类型"+filetype,info:"图片格式不支持"})};var handleTextMessage=function(message){var new_msg=angular.copy(message);$scope.$apply(function(){new_msg.ext=new_msg.ext||{},new_msg.ext.weichat=new_msg.ext.weichat||{},new_msg.date=new_msg.ext.weichat.date||moment().format("YYYY-MM-DD HH:mm:ss");var message_content=new_msg.data,new_message_content="";if("string"!=typeof message_content)for(var i=0;i<message_content.length;i++){var msg=message_content[i],type=msg.type,data=msg.data;switch(type){case"emotion":new_message_content+='<img src="'+data+'"/>';break;case"pic":case"audio":case"video":break;case"txt":new_message_content+=data;break;default:new_message_content+=data}}else new_message_content+=message_content;new_msg.data=new_message_content,appendMsg(new_msg)})},handlePicMessage=function(_message){var message={};message.ext=_message.ext||{},message.ext.weichat=message.ext.weichat||{},message.date=message.ext.weichat.date||moment().format("YYYY-MM-DD HH:mm:ss"),message.data='<a href="" onclick="angular.element(this).scope().imagePreview(\''+_message.url+'\');return false;"><img src="'+_message.url+'"></a>',message.from=_message.from,message.to=_message.to,message.type="groupchat",message.roomType="chatroom",appendMsg(message),$scope.$apply()};$("#J_chat_textarea").keydown(function(event){if((event.altKey||event.ctrlKey||event.shiftKey)&&13==event.keyCode)event.returnValue=!0;else if(13==event.keyCode)return event.returnValue=!1,$scope.$apply(function(){$scope.sendTextMessage($scope.chat.content)}),!1}),conn.listen({onOpened:function(){$scope.room.logined=!0,appendStatusMsg("服务器连接成功"),conn.setPresence(),conn.isOpened()&&conn.heartBeat(conn),joinRoom()},onClosed:function(){appendStatusMsg("连接关闭")},onTextMessage:function(message){handleTextMessage(message)},onEmotionMessage:function(message){handleTextMessage(message)},onPictureMessage:function(message){handlePicMessage(message)},onAudioMessage:function(message){},onLocationMessage:function(message){},onFileMessage:function(message){},onVideoMessage:function(message){},onPresence:function(message){var jid=message.fromJid;jid=jid.right(jid.length-jid.find("easemob.com/"));var originUid=Number(jid);originUid&&!$scope.room.occupants.contain(originUid)&&($scope.room.occupants.push(originUid),emitOccupants());var msg=jid==$scope.room.uid?"加入聊天室成功":"新用户加入聊天室";appendStatusMsg(msg)},onRoster:function(message){},onInviteMessage:function(message){},onError:function(err){appendStatusMsg(err.msg),1==err.type&&login()}}),$(window).bind("beforeunload",function(){conn&&logout()}),$scope.$on("$locationChangeStart",function(){conn&&logout()})}}}])}(),function(){angular.module("angular.validation",["angular.validation.provider","angular.validation.directive"])}.call(this),function(){angular.module("angular.validation.provider",[]).provider("$validation",function(){var $injector,$scope,$http,$q,$timeout,_this=this,setup=function(injector){$injector=injector,$scope=$injector.get("$rootScope"),$http=$injector.get("$http"),$q=$injector.get("$q"),$timeout=$injector.get("$timeout")},expression={},defaultMsg={};this.setExpression=function(obj){return angular.extend(expression,obj),_this},this.getExpression=function(exprs){return expression[exprs]},this.setDefaultMsg=function(obj){return angular.extend(defaultMsg,obj),_this},this.getDefaultMsg=function(msg){return defaultMsg[msg]},this.setErrorHTML=function(func){return func.constructor===Function?(_this.getErrorHTML=func,_this):void 0},this.getErrorHTML=function(message){return'<p class="validation-invalid">'+message+"</p>"},this.setSuccessHTML=function(func){return func.constructor===Function?(_this.getSuccessHTML=func,_this):void 0},this.getSuccessHTML=function(message){return'<p class="validation-valid">'+message+"</p>"},this.showSuccessMessage=!0,this.showErrorMessage=!0,this.checkValid=function(form){return void 0===form.$valid?!1:form&&form.$valid===!0},this.validate=function(form){var deferred=$q.defer(),idx=0;if(void 0===form)return console.error("This is not a regular Form name scope"),deferred.reject("This is not a regular Form name scope"),deferred.promise;if(form.validationId)$scope.$broadcast(form.$name+"submit-"+form.validationId,idx++);else if(form.constructor===Array)for(var k in form)$scope.$broadcast(form[k].$name+"submit-"+form[k].validationId,idx++);else for(var i in form)"$"!==i[0]&&form[i].hasOwnProperty("$dirty")&&$scope.$broadcast(i+"submit-"+form[i].validationId,idx++);return deferred.promise.success=function(fn){return deferred.promise.then(function(value){fn(value)}),deferred.promise},deferred.promise.error=function(fn){return deferred.promise.then(null,function(value){fn(value)}),deferred.promise},$timeout(function(){_this.checkValid(form)?deferred.resolve("success"):deferred.reject("error")}),deferred.promise},this.validCallback=null,this.invalidCallback=null,this.reset=function(form){if(void 0===form)return void console.error("This is not a regular Form name scope");if(form.validationId)$scope.$broadcast(form.$name+"reset-"+form.validationId);else if(form.constructor===Array)for(var k in form)$scope.$broadcast(form[k].$name+"reset-"+form[k].validationId);else for(var i in form)"$"!==i[0]&&form[i].hasOwnProperty("$dirty")&&$scope.$broadcast(i+"reset-"+form[i].validationId)},this.$get=["$injector",function($injector){return setup($injector),{setErrorHTML:this.setErrorHTML,getErrorHTML:this.getErrorHTML,setSuccessHTML:this.setSuccessHTML,getSuccessHTML:this.getSuccessHTML,setExpression:this.setExpression,getExpression:this.getExpression,setDefaultMsg:this.setDefaultMsg,getDefaultMsg:this.getDefaultMsg,showSuccessMessage:this.showSuccessMessage,showErrorMessage:this.showErrorMessage,checkValid:this.checkValid,validate:this.validate,validCallback:this.validCallback,invalidCallback:this.invalidCallback,reset:this.reset}}]})}.call(this),function(){angular.module("angular.validation.directive",["angular.validation.provider"]).directive("validator",["$injector",function($injector){var $validationProvider=$injector.get("$validation"),$q=$injector.get("$q"),$timeout=$injector.get("$timeout"),validFunc=function(element,validMessage,validation,scope,ctrl){var messageElem,messageToShow=validMessage||$validationProvider.getDefaultMsg(validation).success;return messageElem=scope.messageId?angular.element(document.querySelector("#"+scope.messageId)):element.next(),$validationProvider.showSuccessMessage&&messageToShow&&messageElem.html($validationProvider.getSuccessHTML(messageToShow)),ctrl.$setValidity(ctrl.$name,!0),scope.validCallback&&scope.validCallback({message:messageToShow}),$validationProvider.validCallback&&$validationProvider.validCallback(element),!0},invalidFunc=function(element,validMessage,validation,scope,ctrl){var messageElem,messageToShow=validMessage||$validationProvider.getDefaultMsg(validation).error;return messageElem=scope.messageId?angular.element(document.querySelector("#"+scope.messageId)):element.next(),$validationProvider.showErrorMessage&&messageToShow&&messageElem.html($validationProvider.getErrorHTML(messageToShow)),ctrl.$setValidity(ctrl.$name,!1),scope.invalidCallback&&scope.invalidCallback({message:messageToShow}),$validationProvider.invalidCallback&&$validationProvider.invalidCallback(element),!1},focusElements={},checkValidation=function(scope,element,attrs,ctrl,validation,value){var validators=validation.slice(0),validatorExpr=validators[0].trim(),paramIndex=validatorExpr.indexOf("="),validator=-1===paramIndex?validatorExpr:validatorExpr.substr(0,paramIndex),validatorParam=-1===paramIndex?null:validatorExpr.substr(paramIndex+1),leftValidation=validators.slice(1),successMessage=validator+"SuccessMessage",errorMessage=validator+"ErrorMessage",expression=$validationProvider.getExpression(validator),valid={success:function(){return validFunc(element,attrs[successMessage],validator,scope,ctrl),leftValidation.length?checkValidation(scope,element,attrs,ctrl,leftValidation,value):!0},error:function(){return invalidFunc(element,attrs[errorMessage],validator,scope,ctrl)}};return void 0===expression?(console.error('You are using undefined validator "%s"',validator),leftValidation.length?checkValidation(scope,element,attrs,ctrl,leftValidation,value):void 0):expression.constructor===Function?$q.all([$validationProvider.getExpression(validator)(value,scope,element,attrs,validatorParam)]).then(function(data){return data&&data.length>0&&data[0]?valid.success():valid.error()},function(){return valid.error()}):expression.constructor===RegExp&&void 0!==value&&null!==value&&$validationProvider.getExpression(validator).test(value)?valid.success():valid.error()},s4=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)},guid=function(){return s4()+s4()+s4()+s4()};return{restrict:"A",require:"ngModel",scope:{model:"=ngModel",initialValidity:"=initialValidity",validCallback:"&",invalidCallback:"&",messageId:"@"},link:function(scope,element,attrs,ctrl){var initialValidity,watch=function(){},validation=attrs.validator.split(","),uid=ctrl.validationId=guid();"boolean"==typeof scope.initialValidity&&(initialValidity=scope.initialValidity),scope.messageId||element.after('<span class="validation-msg"></span>'),ctrl.$setValidity(ctrl.$name,initialValidity),scope.$on(ctrl.$name+"reset-"+uid,function(){watch(),$timeout(function(){ctrl.$setViewValue(""),ctrl.$setPristine(),ctrl.$setValidity(ctrl.$name,void 0),ctrl.$render(),scope.messageId?angular.element(document.querySelector("#"+scope.messageId)).html(""):element.next().html("")})}),function(){return scope.$on(ctrl.$name+"submit-"+uid,function(event,index){var value=ctrl.$viewValue,isValid=!1;isValid=checkValidation(scope,element,attrs,ctrl,validation,value),"submit"===attrs.validMethod&&(watch(),watch=scope.$watch("model",function(value,oldValue){value!==oldValue&&(void 0!==value&&null!==value||(value=""),isValid=checkValidation(scope,element,attrs,ctrl,validation,value))}));var setFocus=function(isValid){isValid?delete focusElements[index]:(focusElements[index]=element[0],$timeout(function(){focusElements[Math.min.apply(null,Object.keys(focusElements))].focus()},0))};isValid.constructor===Object?isValid.then(setFocus):setFocus(isValid)}),"blur"===attrs.validMethod?void element.bind("blur",function(){var value=ctrl.$viewValue;scope.$apply(function(){checkValidation(scope,element,attrs,ctrl,validation,value)})}):void("submit"!==attrs.validMethod&&"submit-only"!==attrs.validMethod&&scope.$watch("model",function(value){if(ctrl.$pristine&&ctrl.$viewValue)ctrl.$setViewValue(ctrl.$viewValue);else if(ctrl.$pristine)return void(scope.messageId?angular.element(document.querySelector("#"+scope.messageId)).html(""):element.next().html(""));checkValidation(scope,element,attrs,ctrl,validation,value)}))}(),$timeout(function(){attrs.$observe("noValidationMessage",function(value){var el;el=scope.messageId?angular.element(document.querySelector("#"+scope.messageId)):element.next(),"true"==value||value===!0?el.css("display","none"):"false"!=value&&value!==!1||el.css("display","block")})})}}}]).directive("validationSubmit",["$injector",function($injector){var $validationProvider=$injector.get("$validation"),$timeout=$injector.get("$timeout"),$parse=$injector.get("$parse");return{priority:1,require:"?ngClick",link:function(scope,element,attrs){var form=$parse(attrs.validationSubmit)(scope);$timeout(function(){element.off("click"),element.on("click",function(e){e.preventDefault(),$validationProvider.validate(form).success(function(){$parse(attrs.ngClick)(scope)})})})}}}]).directive("validationReset",["$injector",function($injector){var $validationProvider=$injector.get("$validation"),$timeout=$injector.get("$timeout"),$parse=$injector.get("$parse");return{link:function(scope,element,attrs){var form=$parse(attrs.validationReset)(scope);$timeout(function(){element.on("click",function(e){e.preventDefault(),$validationProvider.reset(form)})})}}}])}.call(this),function(){angular.module("angular.validation.rule",["angular.validation"]).config(["$validationProvider",function($validationProvider){var expression={price:function(value,scope,element,attrs,param){return Number(value)>=0},required:function(value,scope,element,attrs,param){return void 0!==value&&""!==value},url:/((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/,email:/^([\w-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([\w-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/,mobile:/^(13[0-9]{9})|(18[0-9]{9})|(15[0-9]{9})|(14[57][0-9]{8})|(17[0-9]{9})$/,number:/^\d+\.?\d*$/,minlength:function(value,scope,element,attrs,param){return"number"==typeof value?value.toString().length>=param:value.length>=param},maxlength:function(value,scope,element,attrs,param){return"number"==typeof value?value.toString().length<=param:value.length<=param},pwdVerify:function(value,scope,element,attrs,param){if(!(param.indexOf(".")>0))return value==scope.$parent[param];for(var paramArrays=param.split("."),params=new Object,i=0;i<paramArrays.length-1;i++)params[paramArrays[i]]=paramArrays[i+1];for(var key in params)return value==scope.$parent[key][params[key]]},min:function(value,scope,element,attrs,param){return parseInt(value)>=parseInt(param)},max:function(value,scope,element,attrs,param){return parseInt(value)<=parseInt(param)},custom:function(value,scope,element,attrs,param){if(param.indexOf("(")>0&&param.indexOf(")")>0){var fun_before=param.indexOf("("),fun_after=param.indexOf(")"),fun=param.substring(0,fun_before),pam=param.substring(fun_before+1,fun_after);return!!eval("scope.$parent."+fun+"("+scope.$parent[pam]+");")}return"!"==param[0]?!scope.$parent[param.substr(1)]:!!scope.$parent[param]}},defaultMsg={price:{error:"请输入价格",success:" "},required:{error:"此项必填",success:" "},url:{error:"URL格式不正确",success:" "},email:{error:"邮箱格式不正确",success:" "},mobile:{error:"手机号码不正确",success:" "},number:{error:"格式应为数字",success:" "},minlength:{error:"长度不正确",success:" "},maxlength:{error:"长度不正确",success:" "},pwdVerify:{error:"两次密码不相符",success:" "},min:{error:"不可少于最小值限制",success:" "},max:{error:"不可超过最大值限制",success:" "},custom:{error:"不符合要求",success:" "}};$validationProvider.setExpression(expression).setDefaultMsg(defaultMsg)}])}.call(this),angular.module("angular.bootstrap.rating",[]).constant("uibRatingConfig",{max:5,stateOn:null,stateOff:null,titles:["one","two","three","four","five"]}).controller("UibRatingController",["$scope","$attrs","uibRatingConfig",function($scope,$attrs,ratingConfig){var ngModelCtrl={$setViewValue:angular.noop};this.init=function(ngModelCtrl_){ngModelCtrl=ngModelCtrl_,ngModelCtrl.$render=this.render,ngModelCtrl.$formatters.push(function(value){return angular.isNumber(value)&&value<<0!==value&&(value=Math.round(value)),value}),this.stateOn=angular.isDefined($attrs.stateOn)?$scope.$parent.$eval($attrs.stateOn):ratingConfig.stateOn,this.stateOff=angular.isDefined($attrs.stateOff)?$scope.$parent.$eval($attrs.stateOff):ratingConfig.stateOff;var tmpTitles=angular.isDefined($attrs.titles)?$scope.$parent.$eval($attrs.titles):ratingConfig.titles;this.titles=angular.isArray(tmpTitles)&&tmpTitles.length>0?tmpTitles:ratingConfig.titles;var ratingStates=angular.isDefined($attrs.ratingStates)?$scope.$parent.$eval($attrs.ratingStates):new Array(angular.isDefined($attrs.max)?$scope.$parent.$eval($attrs.max):ratingConfig.max);$scope.range=this.buildTemplateObjects(ratingStates)},this.buildTemplateObjects=function(states){for(var i=0,n=states.length;n>i;i++)states[i]=angular.extend({index:i},{stateOn:this.stateOn,stateOff:this.stateOff,title:this.getTitle(i)},states[i]);return states},this.getTitle=function(index){return index>=this.titles.length?index+1:this.titles[index]},$scope.rate=function(value){!$scope.readonly&&value>=0&&value<=$scope.range.length&&(ngModelCtrl.$setViewValue(ngModelCtrl.$viewValue===value?0:value),ngModelCtrl.$render())},$scope.enter=function(value){$scope.readonly||($scope.value=value),$scope.onHover({value:value})},$scope.reset=function(){$scope.value=ngModelCtrl.$viewValue,$scope.onLeave()},$scope.onKeydown=function(evt){/(37|38|39|40)/.test(evt.which)&&(evt.preventDefault(),evt.stopPropagation(),$scope.rate($scope.value+(38===evt.which||39===evt.which?1:-1)))},this.render=function(){$scope.value=ngModelCtrl.$viewValue}}]).directive("uibRating",function(){return{restrict:"EA",require:["uibRating","ngModel"],scope:{readonly:"=?",onHover:"&",onLeave:"&"},controller:"UibRatingController",templateUrl:"partials/template/rating/angular-rating.html",replace:!0,link:function(scope,element,attrs,ctrls){attrs.readonly||angular.element(element).css("cursor","pointer");var ratingCtrl=ctrls[0],ngModelCtrl=ctrls[1];ratingCtrl.init(ngModelCtrl)}}}).directive("commentRating",function(){return{restrict:"EA",require:["commentRating","ngModel"],scope:{readonly:"=?",onHover:"&",onLeave:"&"},controller:"UibRatingController",templateUrl:"partials/home/course/comment.html",replace:!0,link:function(scope,element,attrs,ctrls){scope.type=attrs.type,scope.sizeWide=attrs.sizeWide||!1;var ratingCtrl=ctrls[0],ngModelCtrl=ctrls[1];ratingCtrl.init(ngModelCtrl)}}}),angular.module("angular.modal",[]).factory("templateEngine",["$rootScope","$http","$templateCache","$compile",function($rootScope,$http,$templateCache,$compile){return function(params){return params.template?(params.success(params.template),!1):void $http.get(params.template_url,{cache:$templateCache}).success(function(tplContent){params.success(tplContent)}).error(function(){params.error()})}}]).factory("$modal",["$rootScope","templateEngine","$compile","$window","$document","$timeout","$interval",function($rootScope,templateEngine,$compile,$window,$document,$timeout,$interval){var modal_center=function(){var vertical_center=function(){var e_height=$("#J_modal_dialog").height(),w_height=$(window).height(),m_height=(w_height-e_height)/2;$("#J_modal_dialog").css("marginTop",m_height+"px")};vertical_center(),$(window).resize(vertical_center)},modal={timer_text:"",lazytime:0,callback:"",openCallback:"",onsubmit:"",oncancel:"",modal_promise:"",init:function(param){var _self=this,type=param.type,title=param.title||"提示信息",message=param.message||"",info=param.info||"",lazytime=param.lazytime||2,template_url=param.template_url,template=param.template,button=param.button||{confirm:"确定",cancel:"取消"},callback=param.callback,openCallback=param.openCallback,onsubmit=param.onsubmit,oncancel=param.oncancel,icon="",modal_class="",modal_body="",modal_info="",modal_footer="";_self.lazytime=lazytime,_self.callback=callback,_self.openCallback=openCallback,_self.onsubmit=onsubmit,_self.oncancel=oncancel,info&&(modal_info='<p class="info">'+info+"</p>");var appendModal=function(_modal){var template='<div id="J_modal_box" class="modal fade in show"><div id="J_modal_dialog" class="modal-dialog '+(_modal["class"]||"")+'"><div class="modal-content"><div class="modal-header"><button type="button" class="close" ng-click="modal.close()"><i class="icon icon-close h3"></i></button><h4 class="modal-title">'+title+"</h4></div>"+_modal.body+(_modal.footer||"")+'</div></div></div><div id="J_modal_backdrop" class="modal-backdrop fade"></div>',scope=$rootScope.$new(!0).$root,modal_html=$compile(template)(scope),append_modal=function(){$("#J_main_container").append(modal_html),setTimeout(function(){$("#J_modal_backdrop").addClass("in"),modal_center()},10),_self.openCallback&&$timeout(_self.openCallback,40)};$("#J_modal_box").length&&setTimeout(append_modal,250),$("#J_modal_box").length||append_modal()};switch(type){case"success":case"error":case"warning":icon="icon-"+type,lazytime>0&&this.autoClose(),modal_class="modal-message",modal_body='<div id="J_modal_body" class="modal-body"><i class="icon '+icon+'"></i>'+message+modal_info+'<p class="info timer">'+lazytime+"秒后窗口将自动关闭</p></div>";break;case"confirm":icon="icon-warning",modal_class="modal-confirm",modal_body='<div id="J_modal_body" class="modal-body"><i class="icon '+icon+'"></i>'+message+modal_info+"</div>",modal_footer='<div class="modal-footer" id="J_modal_footer"><button type="button" class="btn btn-primary" ng-click="modal.submit()">'+button.confirm+'</button><button type="button" class="btn btn-default" ng-click="modal.cancel()">'+button.cancel+"</button></div>";break;case"custom":return void templateEngine({template_url:template_url,template:template,success:function(tplContent){modal_body='<div id="J_modal_body" class="modal-body clearfix">'+tplContent+"</div>",appendModal({"class":"modal-custom",body:modal_body})},error:function(){modal.init({type:"error",info:"加载错误",message:"由于网络原因加载失败"})}})}appendModal({"class":modal_class,body:modal_body,footer:modal_footer})},initImage:function(param){var url=param.url||"";if(!url)return modal.init({type:"error",info:"图片错误",message:"无效图片地址"}),!1;var img=new Image;img.onload=function(){var template='<div id="J_modal_box" class="modal modal-image fade in show"><div id="J_modal_dialog" class="modal-dialog"><div class="modal-content"><button type="button" class="close" ng-click="modal.close()"><i class="icon icon-close h3"></i></button><img src="'+url+'"></div></div></div><div id="J_modal_backdrop" class="modal-backdrop fade"></div>',scope=$rootScope.$new(!0).$root,modal_html=$compile(template)(scope);$("#J_main_container").append(modal_html),$timeout(function(){$("#J_modal_backdrop").addClass("in"),modal_center()},10)},img.onerror=function(){modal.init({type:"error",info:"图片错误",message:"图片加载失败"})},img.src=url},initLoading:function(param){if(!$("#J_loading_box").length){var loader=param.loader||"images/loader.gif",template='<div id="J_loading_box" class="modal modal-loading fade out show"><div class="loader"><img src="'+loader+'"></div>',scope=$rootScope.$new(!0).$root,loading_html=$compile(template)(scope);$("#J_main_container").append(loading_html),$timeout(function(){$("#J_loading_box").removeClass("out").addClass("in")},100)}},success:function(param){param.type="success",param.lazytime=param.lazytime||1,this.init(param)},error:function(param){param.type="error",param.lazytime=param.lazytime||2,this.init(param)},warning:function(param){param.type="warning",this.init(param)},confirm:function(param){param.type="confirm",this.init(param)},custom:function(param){param.type="custom",this.init(param)},loading:function(param){void 0==param&&(param={}),param.type="loading",this.initLoading(param)},image:function(param){param.type="image",this.initImage(param)},confirmSubmit:function(){var _self=this,onsubmit=this.onsubmit;_self.close(),"function"==typeof onsubmit?onsubmit():eval(onsubmit)},confirmCancel:function(){var _self=this,oncancel=this.oncancel;_self.close(),"function"==typeof oncancel?oncancel():eval(oncancel)},closeCallback:function(){var _self=this,callback=this.callback;"function"==typeof callback?callback():eval(callback),_self.close()},close:function(){$("#J_modal_box").removeClass("in"),$("#J_modal_backdrop").removeClass("in"),$("#J_modal_box").length||this.remove(),$("#J_modal_box").length&&$timeout(this.remove,250),$interval.cancel(this.modal_promise)},autoClose:function(){var _self=this,timer=_self.lazytime,modal_promise=$interval(function(){timer-=1,angular.element(document.getElementById("J_modal_body").querySelector(".timer")).html(timer+"秒后窗口将自动关闭"),0==timer&&(_self.closeCallback(),$interval.cancel(modal_promise),timer=_self.lazytime=0)},1e3);_self.modal_promise=modal_promise},remove:function(){angular.element(document.getElementById("J_modal_box")).remove(),angular.element(document.getElementById("J_modal_backdrop")).remove()},closeLoading:function(){$("#J_loading_box").length&&($("#J_loading_box").removeClass("in").addClass("out"),$timeout(function(){$("#J_loading_box").remove()},260))},closeAll:function(){var _self=this;_self.closeLoading(),_self.close()}};return modal}]),function(angular){var Module=angular.module("datePicker",[]);Module.constant("datePickerConfig",{template:"templates/datepicker.html",view:"month",views:["year","month","date","hours","minutes"],momentNames:{year:"year",month:"month",date:"day",hours:"hours",minutes:"minutes"},viewConfig:{year:["years","isSameYear"],month:["months","isSameMonth"],hours:["hours","isSameHour"],minutes:["minutes","isSameMinutes"]},step:5}),Module.filter("mFormat",function(){return function(m,format,tz){return moment.isMoment(m)?tz?moment.tz(m,tz).format(format):m.format(format):moment(m).format(format)}}),Module.directive("datePicker",["datePickerConfig","datePickerUtils",function(datePickerConfig,datePickerUtils){return{require:"?ngModel",template:'<div ng-include="template"></div>',scope:{model:"=datePicker",after:"=?",before:"=?"},link:function(scope,element,attrs,ngModel){function prepareViews(){scope.views=datePickerConfig.views.concat(),scope.view=attrs.view||datePickerConfig.view,scope.views=scope.views.slice(scope.views.indexOf(attrs.maxView||"year"),scope.views.indexOf(attrs.minView||"minutes")+1),1!==scope.views.length&&-1!==scope.views.indexOf(scope.view)||(scope.view=scope.views[0])}function getDate(name){return datePickerUtils.getDate(scope,attrs,name)}datePickerUtils.setParams(attrs.timezone);var arrowClick=!1,tz=scope.tz=attrs.timezone,createMoment=datePickerUtils.createMoment,eventIsForPicker=datePickerUtils.eventIsForPicker,step=parseInt(attrs.step||datePickerConfig.step,10),partial=!!attrs.partial,minDate=getDate("minDate"),maxDate=getDate("maxDate"),pickerID=element[0].id,now=scope.now=createMoment(),selected=scope.date=createMoment(scope.model||now),autoclose="true"===attrs.autoClose;
scope.model||selected.minute(Math.ceil(selected.minute()/step)*step).second(0),scope.template=attrs.template||datePickerConfig.template,scope.watchDirectChanges=void 0!==attrs.watchDirectChanges,scope.callbackOnSetDate=attrs.dateChange?datePickerUtils.findFunction(scope,attrs.dateChange):void 0,prepareViews(),scope.setView=function(nextView){-1!==scope.views.indexOf(nextView)&&(scope.view=nextView)},scope.selectDate=function(date){if(attrs.disabled)return!1;if(isSame(scope.date,date)&&(date=scope.date),date=clipDate(date),!date)return!1;scope.date=date;var nextView=scope.views[scope.views.indexOf(scope.view)+1];(!nextView||partial||scope.model)&&setDate(date),nextView?scope.setView(nextView):autoclose?(element.addClass("hidden"),scope.$emit("hidePicker")):prepareViewData()};function setDate(date){date&&(scope.model=date,ngModel&&ngModel.$setViewValue(date)),scope.$emit("setDate",scope.model,scope.view),scope.callbackOnSetDate&&scope.callbackOnSetDate(attrs.datePicker,scope.date)}function update(){var view=scope.view;datePickerUtils.setParams(tz),scope.model&&!arrowClick&&(scope.date=createMoment(scope.model),arrowClick=!1);var date=scope.date;switch(view){case"year":scope.years=datePickerUtils.getVisibleYears(date);break;case"month":scope.months=datePickerUtils.getVisibleMonths(date);break;case"date":scope.weekdays=scope.weekdays||datePickerUtils.getDaysOfWeek(),scope.weeks=datePickerUtils.getVisibleWeeks(date);break;case"hours":scope.hours=datePickerUtils.getVisibleHours(date);break;case"minutes":scope.minutes=datePickerUtils.getVisibleMinutes(date,step)}prepareViewData()}function watch(){return"date"!==scope.view?scope.view:scope.date?scope.date.month():null}scope.$watch(watch,update),scope.watchDirectChanges&&scope.$watch("model",function(){arrowClick=!1,update()});function prepareViewData(){var i,j,view=scope.view,date=scope.date,classes=[],classList="";if(datePickerUtils.setParams(tz),"date"===view){var week,weeks=scope.weeks;for(i=0;i<weeks.length;i++)for(week=weeks[i],classes.push([]),j=0;j<week.length;j++)classList="",datePickerUtils.isSameDay(date,week[j])&&(classList+="active"),isNow(week[j],view)&&(classList+=" now"),week[j].month()===date.month()&&inValidRange(week[j])||(classList+=" disabled"),classes[i].push(classList)}else{var params=datePickerConfig.viewConfig[view],dates=scope[params[0]],compareFunc=params[1];for(i=0;i<dates.length;i++)classList="",datePickerUtils[compareFunc](date,dates[i])&&(classList+="active"),isNow(dates[i],view)&&(classList+=" now"),inValidRange(dates[i])||(classList+=" disabled"),classes.push(classList)}scope.classes=classes}scope.next=function(delta){var date=moment(scope.date);switch(delta=delta||1,scope.view){case"year":case"month":date.year(date.year()+delta);break;case"date":date.month(date.month()+delta);break;case"hours":case"minutes":date.hours(date.hours()+delta)}date=clipDate(date),date&&(scope.date=date,setDate(date),arrowClick=!0,update())};function inValidRange(date){var valid=!0;return minDate&&minDate.isAfter(date)&&(valid=isSame(minDate,date)),maxDate&&maxDate.isBefore(date)&&(valid&=isSame(maxDate,date)),valid}function isSame(date1,date2){return!!date1.isSame(date2,datePickerConfig.momentNames[scope.view])}function clipDate(date){return minDate&&minDate.isAfter(date)?minDate:maxDate&&maxDate.isBefore(date)?maxDate:date}function isNow(date,view){var is=!0;switch(view){case"minutes":is&=~~(now.minutes()/step)===~~(date.minutes()/step);case"hours":is&=now.hours()===date.hours();case"date":is&=now.date()===date.date();case"month":is&=now.month()===date.month();case"year":is&=now.year()===date.year()}return is}scope.prev=function(delta){return scope.next(-delta||-1)},pickerID&&scope.$on("pickerUpdate",function(event,pickerIDs,data){if(eventIsForPicker(pickerIDs,pickerID)){var updateViews=!1,updateViewData=!1;angular.isDefined(data.minDate)&&(minDate=data.minDate?data.minDate:!1,updateViewData=!0),angular.isDefined(data.maxDate)&&(maxDate=data.maxDate?data.maxDate:!1,updateViewData=!0),angular.isDefined(data.minView)&&(attrs.minView=data.minView,updateViews=!0),angular.isDefined(data.maxView)&&(attrs.maxView=data.maxView,updateViews=!0),attrs.view=data.view||attrs.view,updateViews&&prepareViews(),updateViewData&&update()}})}}}]),angular.module("datePicker").factory("datePickerUtils",function(){var tz,createNewDate=function(year,month,day,hour,minute){var utc=Date.UTC(0|year,0|month,0|day,0|hour,0|minute);return tz?moment.tz(utc,tz):moment(utc)};return{getVisibleMinutes:function(m,step){var pushedDate,minute,year=m.year(),month=m.month(),day=m.date(),hour=m.hours(),offset=m.utcOffset()/60,minutes=[];for(minute=0;60>minute;minute+=step)pushedDate=createNewDate(year,month,day,hour-offset,minute),minutes.push(pushedDate);return minutes},getVisibleWeeks:function(m){m=moment(m);var startYear=m.year(),startMonth=m.month();m.date(1);var day=m.day();0===day?m.date(-5):m.date(m.date()-day),1===m.date()&&m.date(-6);for(var weeks=[];weeks.length<6&&!(m.year()===startYear&&m.month()>startMonth);)weeks.push(this.getDaysOfWeek(m)),m.add(7,"d");return weeks},getVisibleYears:function(d){var m=moment(d),year=m.year();m.year(year-year%10),year=m.year();for(var pushedDate,actualOffset,offset=m.utcOffset()/60,years=[],i=0;12>i;i++)pushedDate=createNewDate(year,0,1,0-offset),actualOffset=pushedDate.utcOffset()/60,actualOffset!==offset&&(pushedDate=createNewDate(year,0,1,0-actualOffset),offset=actualOffset),years.push(pushedDate),year++;return years},getDaysOfWeek:function(m){m=m?m:tz?moment.tz(tz).day(0):moment().day(0);for(var pushedDate,actualOffset,year=m.year(),month=m.month(),day=m.date(),days=[],offset=m.utcOffset()/60,i=0;7>i;i++)pushedDate=createNewDate(year,month,day,0-offset,0,!1),actualOffset=pushedDate.utcOffset()/60,actualOffset!==offset&&(pushedDate=createNewDate(year,month,day,0-actualOffset,0,!1)),days.push(pushedDate),day++;return days},getVisibleMonths:function(m){for(var pushedDate,actualOffset,year=m.year(),offset=m.utcOffset()/60,months=[],month=0;12>month;month++)pushedDate=createNewDate(year,month,1,0-offset,0,!1),actualOffset=pushedDate.utcOffset()/60,actualOffset!==offset&&(pushedDate=createNewDate(year,month,1,0-actualOffset,0,!1)),months.push(pushedDate);return months},getVisibleHours:function(m){var hour,pushedDate,actualOffset,year=m.year(),month=m.month(),day=m.date(),hours=[],offset=m.utcOffset()/60;for(hour=0;24>hour;hour++)pushedDate=createNewDate(year,month,day,hour-offset,0,!1),actualOffset=pushedDate.utcOffset()/60,actualOffset!==offset&&(pushedDate=createNewDate(year,month,day,hour-actualOffset,0,!1)),hours.push(pushedDate);return hours},isAfter:function(model,date){return model&&model.unix()>=date.unix()},isBefore:function(model,date){return model.unix()<=date.unix()},isSameYear:function(model,date){return model&&model.year()===date.year()},isSameMonth:function(model,date){return this.isSameYear(model,date)&&model.month()===date.month()},isSameDay:function(model,date){return this.isSameMonth(model,date)&&model.date()===date.date()},isSameHour:function(model,date){return this.isSameDay(model,date)&&model.hours()===date.hours()},isSameMinutes:function(model,date){return this.isSameHour(model,date)&&model.minutes()===date.minutes()},setParams:function(zone){tz=zone},findFunction:function(scope,name){var parentScope=scope;do if(parentScope=parentScope.$parent,angular.isFunction(parentScope[name]))return parentScope[name];while(parentScope.$parent);return!1},findParam:function(scope,name){var parentScope=scope;do if(parentScope=parentScope.$parent,parentScope[name])return parentScope[name];while(parentScope.$parent);return!1},createMoment:function(m){return tz?moment.tz(m,tz):moment.isMoment(m)?moment.unix(m.unix()):moment(m)},getDate:function(scope,attrs,name){var result=!1;return attrs[name]&&(result=this.createMoment(attrs[name]),result.isValid()||(result=this.findParam(scope,attrs[name]),result&&(result=this.createMoment(result)))),result},eventIsForPicker:function(targetIDs,pickerID){return angular.isArray(targetIDs)&&targetIDs.indexOf(pickerID)>-1||targetIDs===pickerID}}});var Module=angular.module("datePicker");Module.directive("dateRange",["$compile","datePickerUtils","dateTimeConfig",function($compile,datePickerUtils,dateTimeConfig){function getTemplate(attrs,id,model,min,max){return dateTimeConfig.template(angular.extend(attrs,{ngModel:model,minDate:min&&moment.isMoment(min)?min.format():!1,maxDate:max&&moment.isMoment(max)?max.format():!1}),id)}function randomName(){return"picker"+Math.random().toString().substr(2)}return{scope:{start:"=",end:"="},link:function(scope,element,attrs){var dateChange=null,pickerRangeID=element[0].id,pickerIDs=[randomName(),randomName()],createMoment=datePickerUtils.createMoment,eventIsForPicker=datePickerUtils.eventIsForPicker;scope.dateChange=function(modelName,newDate){dateChange&&dateChange(modelName,newDate)};function setMax(date){scope.$broadcast("pickerUpdate",pickerIDs[0],{maxDate:date})}function setMin(date){scope.$broadcast("pickerUpdate",pickerIDs[1],{minDate:date})}pickerRangeID&&scope.$on("pickerUpdate",function(event,targetIDs,data){eventIsForPicker(targetIDs,pickerRangeID)&&scope.$broadcast("pickerUpdate",pickerIDs,data)}),datePickerUtils.setParams(attrs.timezone),scope.start=createMoment(scope.start),scope.end=createMoment(scope.end),scope.$watchGroup(["start","end"],function(dates){setMin(dates[0]),setMax(dates[1])}),angular.isDefined(attrs.dateChange)&&(dateChange=datePickerUtils.findFunction(scope,attrs.dateChange)),attrs.onSetDate="dateChange";var template='<div><table><tr><td valign="top">'+getTemplate(attrs,pickerIDs[0],"start",!1,scope.end)+'</td><td valign="top">'+getTemplate(attrs,pickerIDs[1],"end",scope.start,!1)+"</td></tr></table></div>",picker=$compile(template)(scope);element.append(picker)}}}]);var PRISTINE_CLASS="ng-pristine",DIRTY_CLASS="ng-dirty",Module=angular.module("datePicker");Module.constant("dateTimeConfig",{template:function(attrs,id){return"<div "+(id?'id="'+id+'" ':"")+'date-picker="'+attrs.ngModel+'" '+(attrs.view?'view="'+attrs.view+'" ':"")+(attrs.maxView?'max-view="'+attrs.maxView+'" ':"")+(attrs.maxDate?'max-date="'+attrs.maxDate+'" ':"")+(attrs.autoClose?'auto-close="'+attrs.autoClose+'" ':"")+(attrs.template?'template="'+attrs.template+'" ':"")+(attrs.minView?'min-view="'+attrs.minView+'" ':"")+(attrs.minDate?'min-date="'+attrs.minDate+'" ':"")+(attrs.partial?'partial="'+attrs.partial+'" ':"")+(attrs.step?'step="'+attrs.step+'" ':"")+(attrs.onSetDate?'date-change="'+attrs.onSetDate+'" ':"")+(attrs.ngModel?'ng-model="'+attrs.ngModel+'" ':"")+(attrs.timezone?'timezone="'+attrs.timezone+'" ':"")+'class="date-picker-date-time"></div>'},format:"YYYY-MM-DD HH:mm",views:["date","year","month","hours","minutes"],autoClose:!1,position:"relative"}),Module.directive("dateTimeAppend",function(){return{link:function(scope,element){element.bind("click",function(){element.find("input")[0].focus()})}}}),Module.directive("dateTime",["$compile","$document","$filter","dateTimeConfig","$parse","datePickerUtils",function($compile,$document,$filter,dateTimeConfig,$parse,datePickerUtils){var body=$document.find("body"),dateFilter=$filter("mFormat");return{require:"ngModel",scope:!0,link:function(scope,element,attrs,ngModel){var template,format=attrs.format||dateTimeConfig.format,parentForm=element.inheritedData("$formController"),views=$parse(attrs.views)(scope)||dateTimeConfig.views.concat(),view=attrs.view||views[0],index=views.indexOf(view),dismiss=attrs.autoClose?$parse(attrs.autoClose)(scope):dateTimeConfig.autoClose,picker=null,pickerID=element[0].id,position=attrs.position||dateTimeConfig.position,container=null,minDate=null,minValid=null,maxDate=null,maxValid=null,timezone=attrs.timezone||!1,eventIsForPicker=datePickerUtils.eventIsForPicker,dateChange=null,shownOnce=!1;-1===index&&views.splice(index,1),views.unshift(view);function formatter(value){return dateFilter(value,format,timezone)}function parser(viewValue){return viewValue.length===format.length?viewValue:void 0}function setMin(date){minDate=date,attrs.minDate=date?date.format():date,minValid=moment.isMoment(date)}function setMax(date){maxDate=date,attrs.maxDate=date?date.format():date,maxValid=moment.isMoment(date)}ngModel.$formatters.push(formatter),ngModel.$parsers.unshift(parser),angular.isDefined(attrs.minDate)&&(setMin(datePickerUtils.findParam(scope,attrs.minDate)),ngModel.$validators.min=function(value){return minValid?moment.isMoment(value)&&(minDate.isSame(value)||minDate.isBefore(value)):!0}),angular.isDefined(attrs.maxDate)&&(setMax(datePickerUtils.findParam(scope,attrs.maxDate)),ngModel.$validators.max=function(value){return maxValid?moment.isMoment(value)&&(maxDate.isSame(value)||maxDate.isAfter(value)):!0}),angular.isDefined(attrs.dateChange)&&(dateChange=datePickerUtils.findFunction(scope,attrs.dateChange));function getTemplate(){template=dateTimeConfig.template(attrs)}function updateInput(event){event.stopPropagation(),ngModel.$pristine&&(ngModel.$dirty=!0,ngModel.$pristine=!1,element.removeClass(PRISTINE_CLASS).addClass(DIRTY_CLASS),parentForm&&parentForm.$setDirty(),ngModel.$render())}function clear(){picker&&(picker.remove(),picker=null),container&&(container.remove(),container=null)}pickerID&&scope.$on("pickerUpdate",function(event,pickerIDs,data){if(eventIsForPicker(pickerIDs,pickerID))if(picker);else{var validateRequired=!1;angular.isDefined(data.minDate)&&(setMin(data.minDate),validateRequired=!0),angular.isDefined(data.maxDate)&&(setMax(data.maxDate),validateRequired=!0),angular.isDefined(data.minView)&&(attrs.minView=data.minView),angular.isDefined(data.maxView)&&(attrs.maxView=data.maxView),attrs.view=data.view||attrs.view,validateRequired&&ngModel.$validate(),angular.isDefined(data.format)&&(format=attrs.format=data.format||dateTimeConfig.format,ngModel.$modelValue=-1),getTemplate()}});function showPicker(){if(!picker){if(picker=$compile(template)(scope),scope.$digest(),shownOnce||(scope.$on("setDate",function(event,date,view){updateInput(event),dateChange&&dateChange(attrs.ngModel,date),dismiss&&views[views.length-1]===view&&clear()}),scope.$on("hidePicker",function(){element.triggerHandler("blur")}),scope.$on("$destroy",clear),shownOnce=!0),"absolute"===position){var pos=angular.extend(element.offset(),{height:element[0].offsetHeight});picker.css({top:pos.top+pos.height,left:pos.left,display:"block",position:position}),body.append(picker)}else container=angular.element("<div date-picker-wrapper></div>"),element[0].parentElement.insertBefore(container[0],element[0]),container.append(picker),picker.css({top:element[0].offsetHeight+"px",display:"block"});picker.bind("mousedown",function(evt){evt.preventDefault()})}}element.bind("focus",showPicker),element.bind("blur",clear),getTemplate()}}}]),angular.module("datePicker").run(["$templateCache",function($templateCache){$templateCache.put("templates/datepicker.html",'<div ng-switch="view">\r\n  <div ng-switch-when="date" class="no-animation">\r\n    <table>\r\n      <thead>\r\n      <tr>\r\n        <th ng-click="prev()"><i class="icon icon-arrow-left"></i></th>\r\n        <th colspan="5" class="switch" ng-click="setView(\'month\')" ng-bind="date|mFormat:\'YYYY MMMM\':tz"></th>\r\n        <th ng-click="next()"><i class="icon icon-arrow-right"></i></th>\r\n      </tr>\r\n      <tr>\r\n        <th ng-repeat="day in weekdays" style="overflow: hidden" class="no-animation" ng-bind="day|mFormat:\'ddd\':tz"></th>\r\n      </tr>\r\n      </thead>\r\n      <tbody>\r\n      <tr ng-repeat="week in weeks" ng-init="$index2 = $index" class="no-animation">\r\n        <td ng-repeat="day in week" class="no-animation">\r\n          <span\r\n            ng-class="classes[$index2][$index]"\r\n            ng-click="selectDate(day)" ng-bind="day|mFormat:\'DD\':tz"></span>\r\n        </td>\r\n      </tr>\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n  <div ng-switch-when="year" class="no-animation">\r\n    <table>\r\n      <thead>\r\n      <tr>\r\n        <th ng-click="prev(10)"><i class="icon icon-arrow-left"></i></th>\r\n        <th colspan="5" class="switch"ng-bind="years[0].year()+\' - \'+years[years.length-1].year()"></th>\r\n        <th ng-click="next(10)"><i class="icon icon-arrow-right"></i></th>\r\n      </tr>\r\n      </thead>\r\n      <tbody>\r\n      <tr>\r\n        <td colspan="7">\r\n          <span ng-class="classes[$index]"\r\n                ng-repeat="year in years"\r\n                ng-click="selectDate(year)" ng-bind="year.year()"></span>\r\n        </td>\r\n      </tr>\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n  <div ng-switch-when="month" class="no-animation">\r\n    <table>\r\n      <thead>\r\n      <tr>\r\n        <th ng-click="prev()"><i class="icon icon-arrow-left"></i></th>\r\n        <th colspan="5" class="switch" ng-click="setView(\'year\')" ng-bind="date|mFormat:\'YYYY\':tz"></th>\r\n        <th ng-click="next()"><i class="icon icon-arrow-right"></i></th>\r\n      </tr>\r\n      </thead>\r\n      <tbody>\r\n      <tr>\r\n        <td colspan="7">\r\n          <span ng-repeat="month in months"\r\n                ng-class="classes[$index]"\r\n                ng-click="selectDate(month)"\r\n                ng-bind="month|mFormat:\'MMM\':tz" class="no-animation"></span>\r\n        </td>\r\n      </tr>\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n  <div ng-switch-when="hours" class="no-animation">\r\n    <table>\r\n      <thead>\r\n      <tr>\r\n        <th ng-click="prev(24)"><i class="icon icon-arrow-left"></i></th>\r\n        <th colspan="5" class="switch" ng-click="setView(\'date\')" ng-bind="date|mFormat:\'DD MMMM YYYY\':tz"></th>\r\n        <th ng-click="next(24)"><i class="icon icon-arrow-right"></i></th>\r\n      </tr>\r\n      </thead>\r\n      <tbody>\r\n      <tr>\r\n        <td colspan="7">\r\n          <span ng-repeat="hour in hours"\r\n                ng-class="classes[$index]"\r\n                ng-click="selectDate(hour)" ng-bind="hour|mFormat:\'HH:mm\':tz" class="no-animation"></span>\r\n        </td>\r\n      </tr>\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n  <div ng-switch-when="minutes" class="no-animation">\r\n    <table>\r\n      <thead>\r\n      <tr>\r\n        <th ng-click="prev()"><i class="icon icon-arrow-left"></i></th>\r\n        <th colspan="5" class="switch" ng-click="setView(\'hours\')" ng-bind="date|mFormat:\'DD MMMM YYYY\':tz"></th>\r\n        <th ng-click="next()"><i class="icon icon-arrow-right"></i></i></th>\r\n      </tr>\r\n      </thead>\r\n      <tbody>\r\n      <tr>\r\n        <td colspan="7">\r\n          <span ng-repeat="minute in minutes"\r\n                ng-class="classes[$index]"\r\n                ng-click="selectDate(minute)"\r\n                ng-bind="minute|mFormat:\'HH:mm\':tz" class="no-animation"></span>\r\n        </td>\r\n      </tr>\r\n      </tbody>\r\n    </table>\r\n  </div>\r\n</div>')}])}(angular),function(){"use strict";var videoPlayer=angular.module("angular-video-player",[]);videoPlayer.directive("videoPlayer",["$rootScope","$compile","$location",function($rootScope,$compile,$location){return{restrict:"A",replace:!0,scope:{data:"=data"},template:function(){var player=['<div class="video-player">','<video id="J_video_player" class="video-js vjs-default-skin"></video>',"</div>"].join("");return player},link:function($scope,element,attrs){$scope.status=0,videojs.addLanguage("zh-CN",{Play:"播放",Pause:"暂停","Current Time":"当前时间","Duration Time":"时长","Remaining Time":"剩余时间","Stream Type":"媒体流类型",LIVE:"直播",Loaded:"加载完毕",Progress:"进度",Fullscreen:"全屏","Non-Fullscreen":"退出全屏",Mute:"静音",Unmute:"取消静音","Playback Rate":"播放码率",Subtitles:"字幕","subtitles off":"字幕关闭",Captions:"内嵌字幕","captions off":"内嵌字幕关闭",Chapters:"节目段落","You aborted the media playback":"视频播放被终止","A network error caused the media download to fail part-way.":"网络错误导致视频下载中途失败, 请刷新重试。","The media could not be loaded, either because the server or network failed or because the format is not supported.":"视频因格式不支持或者服务器或网络的问题无法加载。","The media playback was aborted due to a corruption problem or because the media used features your browser did not support.":"由于视频文件损坏或是该视频使用了你的浏览器不支持的功能，播放终止。","No compatible source was found for this media.":"无法找到此视频兼容的源。","The media is encrypted and we do not have the keys to decrypt it.":"视频已加密，无法解密。"}),$scope.playerInit=function(video_data){$scope.status=1,$scope.player=null;var video_start=video_data.start||0,video_live=!(!video_data.is_live||2!=video_data.live_status),video_src=video_live?video_data.urls.hls.ORIGIN:video_data.urls;videojs.options.flash.swf="scripts/player/video-js.swf";var video_opts={controls:!0,autoplay:!0,preload:"auto",poster:"images/qrcode.png",wdith:"100%",height:"500",playbackRates:[.7,1,1.5,2],controlBar:{remainingTimeDisplay:!1,durationDisplay:{},currentTimeDisplay:{},volumeMenuButton:{inline:!1,vertical:!0}},language:"zh-CN",techOrder:["html5","flash"]};video_live||(video_opts.plugins={videoJsResolutionSwitcher:{"default":2,dynamicLabel:!0}}),$scope.player=videojs("J_video_player",video_opts,function(){video_live||(this.updateSrc([{type:"video/mp4",src:video_src.H,label:"原画",res:1},{type:"video/mp4",src:video_src.M,label:"高清",res:2},{type:"video/mp4",src:video_src.L,label:"流畅",res:3}]),this.on("resolutionchange",function(){$scope.$emit("videoPlayerResolution",this.src())})),video_live&&this.src({src:video_src,type:"application/x-mpegURL",withCredentials:!1}),this.on("play",function(){$scope.$emit("videoPlayerPlaying",!0)}),this.on("pause",function(){$scope.$emit("videoPlayerPause",!0)}),this.on("ended",function(){$scope.$emit("videoPlayerEnded",!0)}),this.on("loadeddata",function(){!video_live&&video_start&&this.currentTime(video_start),$scope.$emit("videoPlayerLoadeddata",!0)}),this.on("timeupdate",function(){$scope.$emit("videoPlayerTimeUpdate",this.currentTime())})}),$scope.$on("doVideoPlayerPause",function(){$scope.player.pause()}),$scope.$on("doVideoPlayerPlay",function(){$scope.player.play()}),$scope.$on("doVideoPlayerRefreshPlay",function(){$scope.player.currentTime(0),$scope.player.play()})},$scope.playerDispose=function(){$scope.player&&$scope.player.dispose&&$scope.player.dispose(),$scope.player=null},$scope.$watch("data",function(newData,oldData){newData||1!=$scope.status||$scope.playerDispose(),newData&&newData.urls&&0==$scope.status&&$scope.playerInit(newData)}),$scope.$on("$locationChangeStart",$scope.playerDispose)}}}])}(),function(window,angular){var module=angular.module("angular-sortable-view",[]);module.directive("svRoot",[function(){function shouldBeAfter(elem,pointer,isGrid){return isGrid?elem.x-pointer.x<0:elem.y-pointer.y<0}function getSortableElements(key){return ROOTS_MAP[key]}function removeSortableElements(key){delete ROOTS_MAP[key]}var sortingInProgress,ROOTS_MAP=Object.create(null);return{restrict:"A",controller:["$scope","$attrs","$interpolate","$parse",function($scope,$attrs,$interpolate,$parse){var mapKey=$interpolate($attrs.svRoot)($scope)||$scope.$id;ROOTS_MAP[mapKey]||(ROOTS_MAP[mapKey]=[]);var candidates,$placeholder,options,$helper,$original,$target,isGrid=!1,onSort=$parse($attrs.svOnSort);$attrs.svOnStart=$attrs.$$element[0].attributes["sv-on-start"],$attrs.svOnStart=$attrs.svOnStart&&$attrs.svOnStart.value,$attrs.svOnStop=$attrs.$$element[0].attributes["sv-on-stop"],$attrs.svOnStop=$attrs.svOnStop&&$attrs.svOnStop.value;var onStart=$parse($attrs.svOnStart),onStop=$parse($attrs.svOnStop);if(this.sortingInProgress=function(){return sortingInProgress},$attrs.svGrid){if(isGrid="true"===$attrs.svGrid?!0:"false"===$attrs.svGrid?!1:null,null===isGrid)throw"Invalid value of sv-grid attribute"}else $scope.$watchCollection(function(){return getSortableElements(mapKey)},function(collection){isGrid=!1;var array=collection.filter(function(item){return!item.container}).map(function(item){return{part:item.getPart().id,y:item.element[0].getBoundingClientRect().top}}),dict=Object.create(null);array.forEach(function(item){dict[item.part]?dict[item.part].push(item.y):dict[item.part]=[item.y]}),Object.keys(dict).forEach(function(key){dict[key].sort(),dict[key].forEach(function(item,index){index<dict[key].length-1&&item>0&&item===dict[key][index+1]&&(isGrid=!0)})})});this.$moveUpdate=function(opts,mouse,svElement,svOriginal,svPlaceholder,originatingPart,originatingIndex){var svRect=svElement[0].getBoundingClientRect();"element"===opts.tolerance&&(mouse={x:~~(svRect.left+svRect.width/2),y:~~(svRect.top+svRect.height/2)}),sortingInProgress=!0,candidates=[],$placeholder||(svPlaceholder?($placeholder=svPlaceholder.clone(),$placeholder.removeClass("ng-hide")):($placeholder=svOriginal.clone(),$placeholder.addClass("sv-visibility-hidden"),$placeholder.addClass("sv-placeholder"),$placeholder.css({height:svRect.height+"px",width:svRect.width+"px"})),svOriginal.after($placeholder),svOriginal.addClass("ng-hide"),$original=svOriginal,options=opts,$helper=svElement,onStart($scope,{$helper:{element:$helper},$part:originatingPart.model(originatingPart.scope),$index:originatingIndex,$item:originatingPart.model(originatingPart.scope)[originatingIndex]}),$scope.$root&&$scope.$root.$$phase||$scope.$apply()),$helper[0].reposition({x:mouse.x+document.body.scrollLeft-mouse.offset.x*svRect.width,y:mouse.y+document.body.scrollTop-mouse.offset.y*svRect.height}),getSortableElements(mapKey).forEach(function(se,index){if(null==opts.containment||elementMatchesSelector(se.element,opts.containment)||elementMatchesSelector(se.element,opts.containment+" *")){var rect=se.element[0].getBoundingClientRect(),center={x:~~(rect.left+rect.width/2),y:~~(rect.top+rect.height/2)};se.container||!se.element[0].scrollHeight&&!se.element[0].scrollWidth||candidates.push({element:se.element,q:(center.x-mouse.x)*(center.x-mouse.x)+(center.y-mouse.y)*(center.y-mouse.y),view:se.getPart(),targetIndex:se.getIndex(),after:shouldBeAfter(center,mouse,isGrid)}),se.container&&!se.element[0].querySelector("[sv-element]:not(.sv-placeholder):not(.sv-source)")&&candidates.push({element:se.element,q:(center.x-mouse.x)*(center.x-mouse.x)+(center.y-mouse.y)*(center.y-mouse.y),view:se.getPart(),targetIndex:0,container:!0})}});var pRect=$placeholder[0].getBoundingClientRect(),pCenter={x:~~(pRect.left+pRect.width/2),y:~~(pRect.top+pRect.height/2)};candidates.push({q:(pCenter.x-mouse.x)*(pCenter.x-mouse.x)+(pCenter.y-mouse.y)*(pCenter.y-mouse.y),element:$placeholder,placeholder:!0}),candidates.sort(function(a,b){return a.q-b.q}),candidates.forEach(function(cand,index){0!==index||cand.placeholder||cand.container?0===index&&cand.container?($target=cand,cand.element.append($placeholder)):cand.element.removeClass("sv-candidate"):($target=cand,cand.element.addClass("sv-candidate"),cand.after?cand.element.after($placeholder):insertElementBefore(cand.element,$placeholder))})},this.$drop=function(originatingPart,index,options){if($placeholder){if(options.revert){var placeholderRect=$placeholder[0].getBoundingClientRect(),helperRect=$helper[0].getBoundingClientRect(),distance=Math.sqrt(Math.pow(helperRect.top-placeholderRect.top,2)+Math.pow(helperRect.left-placeholderRect.left,2)),duration=+options.revert*distance/200;duration=Math.min(duration,+options.revert),["-webkit-","-moz-","-ms-","-o-",""].forEach(function(prefix){"undefined"!=typeof $helper[0].style[prefix+"transition"]&&($helper[0].style[prefix+"transition"]="all "+duration+"ms ease")}),setTimeout(afterRevert,duration),$helper.css({top:placeholderRect.top+document.body.scrollTop+"px",left:placeholderRect.left+document.body.scrollLeft+"px"})}else afterRevert();function afterRevert(){if(sortingInProgress=!1,$placeholder.remove(),$helper.remove(),$original.removeClass("ng-hide"),candidates=void 0,$placeholder=void 0,options=void 0,$helper=void 0,$original=void 0,onStop($scope,{$part:originatingPart.model(originatingPart.scope),$index:index,$item:originatingPart.model(originatingPart.scope)[index]}),$target){$target.element.removeClass("sv-candidate");var spliced=originatingPart.model(originatingPart.scope).splice(index,1),targetIndex=$target.targetIndex;$target.view===originatingPart&&$target.targetIndex>index&&targetIndex--,$target.after&&targetIndex++,$target.view.model($target.view.scope).splice(targetIndex,0,spliced[0]),$target.view===originatingPart&&index===targetIndex||onSort($scope,{$partTo:$target.view.model($target.view.scope),$partFrom:originatingPart.model(originatingPart.scope),$item:spliced[0],$indexTo:targetIndex,$indexFrom:index})}$target=void 0,$scope.$root&&$scope.$root.$$phase||$scope.$apply()}}},this.addToSortableElements=function(se){getSortableElements(mapKey).push(se)},this.removeFromSortableElements=function(se){var elems=getSortableElements(mapKey),index=elems.indexOf(se);index>-1&&(elems.splice(index,1),0===elems.length&&removeSortableElements(mapKey))}}]}}]),module.directive("svPart",["$parse",function($parse){return{restrict:"A",require:"^svRoot",controller:["$scope",function($scope){$scope.$ctrl=this,this.getPart=function(){return $scope.part},this.$drop=function(index,options){$scope.$sortableRoot.$drop($scope.part,index,options)}}],scope:!0,link:function($scope,$element,$attrs,$sortable){if(!$attrs.svPart)throw new Error("no model provided");var model=$parse($attrs.svPart);if(!model.assign)throw new Error("model not assignable");$scope.part={id:$scope.$id,element:$element,model:model,scope:$scope},$scope.$sortableRoot=$sortable;var sortablePart={element:$element,getPart:$scope.$ctrl.getPart,container:!0};$sortable.addToSortableElements(sortablePart),$scope.$on("$destroy",function(){$sortable.removeFromSortableElements(sortablePart)})}}}]),module.directive("svElement",["$parse",function($parse){return{restrict:"A",require:["^svPart","^svRoot"],controller:["$scope",function($scope){$scope.$ctrl=this}],link:function($scope,$element,$attrs,$controllers){$element.addClass("drag-element");var sortableElement={element:$element,getPart:$controllers[0].getPart,getIndex:function(){return $scope.$index}};$controllers[1].addToSortableElements(sortableElement),$scope.$on("$destroy",function(){$controllers[1].removeFromSortableElements(sortableElement)});var handle=$element;handle.on("mousedown touchstart",onMousedown),$scope.$watch("$ctrl.handle",function(customHandle){customHandle&&(handle.off("mousedown touchstart",onMousedown),handle=customHandle,handle.on("mousedown touchstart",onMousedown))});var helper;$scope.$watch("$ctrl.helper",function(customHelper){customHelper&&(helper=customHelper)});var placeholder;$scope.$watch("$ctrl.placeholder",function(customPlaceholder){customPlaceholder&&(placeholder=customPlaceholder)});var moveExecuted,html=(angular.element(document.body),angular.element(document.documentElement));function onMousedown(e){if(touchFix(e),!$controllers[1].sortingInProgress()&&(0==e.button||"mousedown"!==e.type)){moveExecuted=!1;var opts=$parse($attrs.svElement)($scope);if(opts=angular.extend({},{tolerance:"pointer",revert:200,containment:"html"},opts),opts.containment)var containmentRect=closestElement.call($element,opts.containment)[0].getBoundingClientRect();var clone,target=$element,clientRect=$element[0].getBoundingClientRect();helper||(helper=$controllers[0].helper),placeholder||(placeholder=$controllers[0].placeholder),helper?(clone=helper.clone(),clone.removeClass("ng-hide"),clone.css({left:clientRect.left+document.body.scrollLeft+"px",top:clientRect.top+document.body.scrollTop+"px"}),target.addClass("sv-visibility-hidden")):(clone=target.clone(),clone.addClass("sv-helper").css({left:clientRect.left+document.body.scrollLeft+"px",top:clientRect.top+document.body.scrollTop+"px",width:clientRect.width+"px"})),clone[0].reposition=function(coords){var targetLeft=coords.x,targetTop=coords.y,helperRect=clone[0].getBoundingClientRect(),body=document.body;containmentRect&&(targetTop<containmentRect.top+body.scrollTop&&(targetTop=containmentRect.top+body.scrollTop),targetTop+helperRect.height>containmentRect.top+body.scrollTop+containmentRect.height&&(targetTop=containmentRect.top+body.scrollTop+containmentRect.height-helperRect.height),
targetLeft<containmentRect.left+body.scrollLeft&&(targetLeft=containmentRect.left+body.scrollLeft),targetLeft+helperRect.width>containmentRect.left+body.scrollLeft+containmentRect.width&&(targetLeft=containmentRect.left+body.scrollLeft+containmentRect.width-helperRect.width)),this.style.left=targetLeft-body.scrollLeft+"px",this.style.top=targetTop-body.scrollTop+"px"};var pointerOffset={x:(e.clientX-clientRect.left)/clientRect.width,y:(e.clientY-clientRect.top)/clientRect.height};html.addClass("sv-sorting-in-progress"),html.on("mousemove touchmove",onMousemove).on("mouseup touchend touchcancel",function mouseup(e){html.off("mousemove touchmove",onMousemove),html.off("mouseup touchend",mouseup),html.removeClass("sv-sorting-in-progress"),moveExecuted&&$controllers[0].$drop($scope.$index,opts),$element.removeClass("sv-visibility-hidden")});function onMousemove(e){touchFix(e),moveExecuted||($element.parent().prepend(clone),moveExecuted=!0),$controllers[1].$moveUpdate(opts,{x:e.clientX,y:e.clientY,offset:pointerOffset},clone,$element,placeholder,$controllers[0].getPart(),$scope.$index)}}}}}}]),module.directive("svHandle",function(){return{require:"?^svElement",link:function($scope,$element,$attrs,$ctrl){$element.addClass("drag-handle"),$ctrl&&($ctrl.handle=$element.add($ctrl.handle))}}}),module.directive("svHelper",function(){return{require:["?^svPart","?^svElement"],link:function($scope,$element,$attrs,$ctrl){$element.addClass("sv-helper").addClass("ng-hide"),$ctrl[1]?$ctrl[1].helper=$element:$ctrl[0]&&($ctrl[0].helper=$element)}}}),module.directive("svPlaceholder",function(){return{require:["?^svPart","?^svElement"],link:function($scope,$element,$attrs,$ctrl){$element.addClass("sv-placeholder").addClass("ng-hide"),$ctrl[1]?$ctrl[1].placeholder=$element:$ctrl[0]&&($ctrl[0].placeholder=$element)}}}),angular.element(document.head).append(["<style>.sv-helper{position: fixed !important;z-index: 99999;margin: 0 !important;}.sv-candidate{}.sv-placeholder{}.sv-sorting-in-progress{-webkit-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;}.sv-visibility-hidden{visibility: hidden !important;opacity: 0 !important;}</style>"].join(""));function touchFix(e){if(!("clientX"in e||"clientY"in e)){var touches=e.touches||e.originalEvent.touches;touches&&touches.length&&(e.clientX=touches[0].clientX,e.clientY=touches[0].clientY),e.preventDefault()}}function getPreviousSibling(element){if(element=element[0],element.previousElementSibling)return angular.element(element.previousElementSibling);for(var sib=element.previousSibling;null!=sib&&1!=sib.nodeType;)sib=sib.previousSibling;return angular.element(sib)}function insertElementBefore(element,newElement){var prevSibl=getPreviousSibling(element);prevSibl.length>0?prevSibl.after(newElement):element.parent().prepend(newElement)}var dde=document.documentElement,matchingFunction=dde.matches?"matches":dde.matchesSelector?"matchesSelector":dde.webkitMatches?"webkitMatches":dde.webkitMatchesSelector?"webkitMatchesSelector":dde.msMatches?"msMatches":dde.msMatchesSelector?"msMatchesSelector":dde.mozMatches?"mozMatches":dde.mozMatchesSelector?"mozMatchesSelector":null;if(null==matchingFunction)throw"This browser doesn't support the HTMLElement.matches method";function elementMatchesSelector(element,selector){return element instanceof angular.element&&(element=element[0]),null!==matchingFunction?element[matchingFunction](selector):void 0}var closestElement=angular.element.prototype.closest||function(selector){for(var el=this[0].parentNode;el!==document.documentElement&&!el[matchingFunction](selector);)el=el.parentNode;return el[matchingFunction](selector)?angular.element(el):angular.element()};"function"!=typeof angular.element.prototype.add&&(angular.element.prototype.add=function(elem){var i,res=angular.element();for(elem=angular.element(elem),i=0;i<this.length;i++)res.push(this[i]);for(i=0;i<elem.length;i++)res.push(elem[i]);return res})}(window,window.angular),function(){angular.module("angular.loading",["cfp.loadingBarInterceptor"]),angular.module("chieffancypants.loadingBar",["cfp.loadingBarInterceptor"]),angular.module("cfp.loadingBarInterceptor",["cfp.loadingBar"]).config(["$httpProvider",function($httpProvider){var interceptor=["$q","$cacheFactory","$timeout","$rootScope","$log","cfpLoadingBar",function($q,$cacheFactory,$timeout,$rootScope,$log,cfpLoadingBar){var startTimeout,reqsTotal=0,reqsCompleted=0,latencyThreshold=cfpLoadingBar.latencyThreshold;function setComplete(){$timeout.cancel(startTimeout),cfpLoadingBar.complete(),reqsCompleted=0,reqsTotal=0}function isCached(config){var cache,defaultCache=$cacheFactory.get("$http"),defaults=$httpProvider.defaults;!config.cache&&!defaults.cache||config.cache===!1||"GET"!==config.method&&"JSONP"!==config.method||(cache=angular.isObject(config.cache)?config.cache:angular.isObject(defaults.cache)?defaults.cache:defaultCache);var cached=void 0!==cache?void 0!==cache.get(config.url):!1;return void 0!==config.cached&&cached!==config.cached?config.cached:(config.cached=cached,cached)}return{request:function(config){return config.ignoreLoadingBar||isCached(config)||($rootScope.$broadcast("cfpLoadingBar:loading",{url:config.url}),0===reqsTotal&&(startTimeout=$timeout(function(){cfpLoadingBar.start()},latencyThreshold)),reqsTotal++,cfpLoadingBar.set(reqsCompleted/reqsTotal)),config},response:function(response){return response&&response.config?(response.config.ignoreLoadingBar||isCached(response.config)||(reqsCompleted++,$rootScope.$broadcast("cfpLoadingBar:loaded",{url:response.config.url,result:response}),reqsCompleted>=reqsTotal?setComplete():cfpLoadingBar.set(reqsCompleted/reqsTotal)),response):($log.error("Broken interceptor detected: Config object not supplied in response:\n https://github.com/chieffancypants/angular-loading-bar/pull/50"),response)},responseError:function(rejection){return rejection&&rejection.config?(rejection.config.ignoreLoadingBar||isCached(rejection.config)||(reqsCompleted++,$rootScope.$broadcast("cfpLoadingBar:loaded",{url:rejection.config.url,result:rejection}),reqsCompleted>=reqsTotal?setComplete():cfpLoadingBar.set(reqsCompleted/reqsTotal)),$q.reject(rejection)):($log.error("Broken interceptor detected: Config object not supplied in rejection:\n https://github.com/chieffancypants/angular-loading-bar/pull/50"),$q.reject(rejection))}}}];$httpProvider.interceptors.push(interceptor)}]),angular.module("cfp.loadingBar",[]).provider("cfpLoadingBar",function(){this.autoIncrement=!0,this.includeSpinner=!0,this.includeBar=!0,this.latencyThreshold=100,this.startSize=.03,this.parentSelector="body",this.spinnerTemplate='<div id="loading-bar-spinner"><div class="spinner-icon"></div></div>',this.loadingBarTemplate='<div id="J_loading_bar"><div class="bar"><div class="peg"></div></div></div>',this.$get=["$injector","$document","$timeout","$rootScope",function($injector,$document,$timeout,$rootScope){var $animate,incTimeout,completeTimeout,$parentSelector=this.parentSelector,loadingBarContainer=angular.element(this.loadingBarTemplate),loadingBar=loadingBarContainer.find("div").eq(0),spinner=angular.element(this.spinnerTemplate),started=!1,status=0,autoIncrement=this.autoIncrement,includeSpinner=this.includeSpinner,includeBar=this.includeBar,startSize=this.startSize;function _start(){if($animate||($animate=$injector.get("$animate")),$timeout.cancel(completeTimeout),!started){var document=$document[0],parent=document.querySelector?document.querySelector($parentSelector):$document.find($parentSelector)[0];parent||(parent=document.getElementsByTagName("body")[0]);var $parent=angular.element(parent),$after=parent.lastChild&&angular.element(parent.lastChild);$rootScope.$broadcast("cfpLoadingBar:started"),started=!0,includeBar&&$animate.enter(loadingBarContainer,$parent,$after),includeSpinner&&$animate.enter(spinner,$parent,loadingBarContainer),_set(startSize)}}function _set(n){if(started){var pct=100*n+"%";loadingBar.css("width",pct),status=n,autoIncrement&&($timeout.cancel(incTimeout),incTimeout=$timeout(function(){_inc()},200))}}function _inc(){if(!(_status()>=1)){var rnd=0,stat=_status();rnd=stat>=0&&.25>stat?(3*Math.random()+3)/100:stat>=.25&&.65>stat?3*Math.random()/100:stat>=.65&&.9>stat?2*Math.random()/100:stat>=.9&&.99>stat?.005:0;var pct=_status()+rnd;_set(pct)}}function _status(){return status}function _complete(){return $animate||($animate=$injector.get("$animate")),$rootScope.$broadcast("cfpLoadingBar:completed"),_set(1),!1}return{start:_start,set:_set,status:_status,inc:_inc,complete:_complete,autoIncrement:this.autoIncrement,includeSpinner:this.includeSpinner,latencyThreshold:this.latencyThreshold,parentSelector:this.parentSelector,startSize:this.startSize}}]})}(),function(){var relatedSelect=angular.module("angular-related-select",[]);relatedSelect.controller("RSController",["$rootScope","$modal","$scope",function($rootScope,$modal,$scope){$scope.disSelects=[],$scope.ckdSelects=[],$scope.ckdSelectCates=[],$scope.ckdSelectId=0,$scope.$watch("allSelects",function(allSelects){if(!allSelects||!allSelects.length)return!1;if($scope.is_edit){if($scope.editSelectId){var allSelects=$scope.allSelects,editSelectId=$scope.editSelectId,select=allSelects.find(editSelectId,"id","children"),initCates=function(select){if(select.id){var parent=allSelects.parent(select.id,"id","children");parent&&($scope.disSelects.unshift(parent.children),$scope.ckdSelects.unshift(parent.id),initCates(parent))}};initCates(select),$scope.ckdSelects.shift(),$scope.ckdSelects.push(select.id);for(var i=0;i<$scope.ckdSelects.length;i++)$scope.ckdSelectCates.push($scope.disSelects[i].find($scope.ckdSelects[i],"id"))}}else $scope.disSelects.push(allSelects)}),$scope.selectChange=function(params){if(!params.id)return!1;$scope.disSelects.splice(params.index+1,$scope.disSelects.length-params.index+1),$scope.ckdSelects.splice(params.index+1,$scope.ckdSelects.length-params.index+1);var children=$scope.disSelects[params.index].find(params.id,"id").children;children&&children.length&&$scope.disSelects.push(children),$scope.ckdSelectId=$scope.ckdSelects[$scope.ckdSelects.length-1],$scope.selectChangeCallBack&&angular.isFunction($scope.selectChangeCallBack)&&$scope.selectChangeCallBack({ckdSelectId:$scope.ckdSelectId,disSelects:$scope.disSelects})}}]),relatedSelect.directive("relatedSelect",function(){return{restrict:"A",scope:{is_edit:"=isEdit",allSelects:"=selects",editSelectId:"=selectId",selectChangeCallBack:"=selectChange"},templateUrl:function(element,attrs){return attrs.templateUrl||"partials/template/related-select/related-select.html"},controller:"RSController",replace:!0,link:function(scope,element,attrs){}}})}(),function(angular){angular.module("ng-breadcrumbs",[]).factory("breadcrumbs",["$rootScope","$location","$route",function($rootScope,$location,$route){var BreadcrumbService={breadcrumbs:[],get:function(options){if(this.options=options||this.options,this.options)for(var key in this.options)if(this.options.hasOwnProperty(key))for(var index in this.breadcrumbs)if(this.breadcrumbs.hasOwnProperty(index)){var breadcrumb=this.breadcrumbs[index];breadcrumb.label===key&&(breadcrumb.label=this.options[key])}return this.breadcrumbs},generateBreadcrumbs:function(){var params,pathElements,param,routes=$route.routes,_this=this,pathObj={},path="",originalPath="";$route&&$route.current&&$route.current.originalPath&&(this.breadcrumbs=[],params=$route.current.params,pathElements=$route.current.originalPath.trim().split("/"),""===pathElements[1]&&pathElements.splice(1,1),angular.forEach(pathElements,function(pathElement,index){param=":"===pathElement[0]&&"undefined"!=typeof params[pathElement.slice(1,pathElement.length)]?params[pathElement.slice(1,pathElement.length)]:!1,pathObj[index]={path:param||pathElement,originalPath:pathElement},path=Object.keys(pathObj).map(function(k){return pathObj[k].path}).join("/")||"/",originalPath=Object.keys(pathObj).map(function(k){return pathObj[k].originalPath}).join("/")||"/",routes[originalPath]&&(routes[originalPath].label||param)&&!routes[originalPath].excludeBreadcrumb&&_this.breadcrumbs.push({path:path,originalPath:originalPath,label:routes[originalPath].label||param,param:param})}))}};return $rootScope.$on("$routeChangeSuccess",function(){BreadcrumbService.generateBreadcrumbs()}),$rootScope.$watch(function(){return BreadcrumbService.options},function(){BreadcrumbService.generateBreadcrumbs()}),BreadcrumbService.generateBreadcrumbs(),BreadcrumbService}])}(angular),angular.module("angular.bootstrap.carousel",[]).controller("CarouselController",["$scope","$element","$interval","$animate",function($scope,$element,$interval,$animate){$scope.active_slide_index=0;var currentInterval,isPlaying,self=this,slides=self.slides=$scope.slides=[],NEW_ANIMATE=angular.version.minor>=4,NO_TRANSITION="uib-noTransition",SLIDE_DIRECTION="uib-slideDirection",currentIndex=-1;self.currentSlide=null;var destroyed=!1;self.select=$scope.select=function(nextSlide,direction){var nextIndex=$scope.indexOfSlide(nextSlide);void 0===direction&&(direction=nextIndex>self.getCurrentIndex()?"next":"prev"),nextSlide&&nextSlide!==self.currentSlide&&!$scope.$currentTransition&&goNext(nextSlide,nextIndex,direction)};function goNext(slide,index,direction){destroyed||(angular.extend(slide,{direction:direction,active:!0}),angular.extend(self.currentSlide||{},{direction:direction,active:!1}),$animate.enabled()&&!$scope.noTransition&&!$scope.$currentTransition&&slide.$element&&self.slides.length>1&&(slide.$element.data(SLIDE_DIRECTION,slide.direction),self.currentSlide&&self.currentSlide.$element&&self.currentSlide.$element.data(SLIDE_DIRECTION,slide.direction),$scope.$currentTransition=!0,NEW_ANIMATE?$animate.on("addClass",slide.$element,function(element,phase){"close"===phase&&($scope.$currentTransition=null,$animate.off("addClass",element))}):slide.$element.one("$animate:close",function(){$scope.$currentTransition=null})),self.currentSlide=slide,currentIndex=index,$scope.active_slide_index=currentIndex,restartTimer())}$scope.$on("$destroy",function(){destroyed=!0});function getSlideByIndex(index){if(angular.isUndefined(slides[index].index))return slides[index];var i;slides.length;for(i=0;i<slides.length;++i)if(slides[i].index==index)return slides[i]}self.getCurrentIndex=function(){return self.currentSlide&&angular.isDefined(self.currentSlide.index)?+self.currentSlide.index:currentIndex},$scope.indexOfSlide=function(slide){return angular.isDefined(slide.index)?+slide.index:slides.indexOf(slide)},$scope.next=function(){var newIndex=(self.getCurrentIndex()+1)%slides.length;return 0===newIndex&&$scope.noWrap()?void $scope.pause():self.select(getSlideByIndex(newIndex),"next")},$scope.prev=function(){var newIndex=self.getCurrentIndex()-1<0?slides.length-1:self.getCurrentIndex()-1;return $scope.noWrap()&&newIndex===slides.length-1?void $scope.pause():self.select(getSlideByIndex(newIndex),"prev")},$scope.isActive=function(slide){return self.currentSlide===slide},$scope.$watch("interval",restartTimer),$scope.$on("$destroy",resetTimer);function restartTimer(){resetTimer();var interval=+$scope.interval;!isNaN(interval)&&interval>0&&(currentInterval=$interval(timerFn,interval))}function resetTimer(){currentInterval&&($interval.cancel(currentInterval),currentInterval=null)}function timerFn(){var interval=+$scope.interval;isPlaying&&!isNaN(interval)&&interval>0&&slides.length?$scope.next():$scope.pause()}$scope.play=function(){isPlaying||(isPlaying=!0,restartTimer())},$scope.pause=function(){$scope.noPause||(isPlaying=!1,resetTimer())},self.addSlide=function(slide,element){slide.$element=element,slides.push(slide),1===slides.length||slide.active?(self.select(slides[slides.length-1]),1===slides.length&&$scope.play()):slide.active=!1},self.removeSlide=function(slide){angular.isDefined(slide.index)&&slides.sort(function(a,b){return+a.index>+b.index});var index=slides.indexOf(slide);slides.splice(index,1),slides.length>0&&slide.active?index>=slides.length?self.select(slides[index-1]):self.select(slides[index]):currentIndex>index&&currentIndex--,0===slides.length&&(self.currentSlide=null)},$scope.$watch("noTransition",function(noTransition){$element.data(NO_TRANSITION,noTransition)})}]).directive("carousel",[function(){return{restrict:"EA",transclude:!0,replace:!0,controller:"CarouselController",controllerAs:"carousel",require:"carousel",templateUrl:function(element,attrs){return attrs.templateUrl||"partials/template/carousel/carousel.html"},scope:{interval:"=",noTransition:"=",noPause:"=",noWrap:"&"}}}]).directive("slide",function(){return{require:"^carousel",restrict:"EA",transclude:!0,replace:!0,templateUrl:function(element,attrs){return attrs.templateUrl||"partials/template/carousel/slide.html"},scope:{active:"=?",actual:"=?",index:"=?"},link:function(scope,element,attrs,carouselCtrl){carouselCtrl.addSlide(scope,element),scope.$on("$destroy",function(){carouselCtrl.removeSlide(scope)}),scope.$watch("active",function(active){active&&carouselCtrl.select(scope)})}}}).animation(".item",["$injector","$animate",function($injector,$animate){var NO_TRANSITION="uib-noTransition",SLIDE_DIRECTION="uib-slideDirection",$animateCss=null;$injector.has("$animateCss")&&($animateCss=$injector.get("$animateCss"));function removeClass(element,className,callback){element.removeClass(className),callback&&callback()}return{beforeAddClass:function(element,className,done){if("active"==className&&element.parent()&&!element.parent().data(NO_TRANSITION)){var stopped=!1,direction=element.data(SLIDE_DIRECTION),directionClass="next"==direction?"left":"right",removeClassFn=removeClass.bind(this,element,directionClass+" "+direction,done);return element.addClass(direction),$animateCss?$animateCss(element,{addClass:directionClass}).start().done(removeClassFn):$animate.addClass(element,directionClass).then(function(){stopped||removeClassFn(),done()}),function(){stopped=!0}}done()},beforeRemoveClass:function(element,className,done){if("active"===className&&element.parent()&&!element.parent().data(NO_TRANSITION)){var stopped=!1,direction=element.data(SLIDE_DIRECTION),directionClass="next"==direction?"left":"right",removeClassFn=removeClass.bind(this,element,directionClass,done);return $animateCss?$animateCss(element,{addClass:directionClass}).start().done(removeClassFn):$animate.addClass(element,directionClass).then(function(){stopped||removeClassFn(),done()}),function(){stopped=!0}}done()}}}]),angular.module("CollapseDirective",[]).directive("uibCollapse",["$animate","$injector",function($animate,$injector){var $animateCss=$injector.has("$animateCss")?$injector.get("$animateCss"):null;return{link:function(scope,element,attrs){function expand(){element.removeClass("collapse").addClass("collapsing").attr("aria-expanded",!0).attr("aria-hidden",!1),$animateCss?$animateCss(element,{addClass:"in",easing:"ease",to:{height:element[0].scrollHeight+"px"}}).start().done(expandDone):$animate.addClass(element,"in",{to:{height:element[0].scrollHeight+"px"}}).then(expandDone)}function expandDone(){element.removeClass("collapsing").addClass("collapse").css({height:"auto"})}function collapse(){return element.hasClass("collapse")||element.hasClass("in")?(element.css({height:element[0].scrollHeight+"px"}).removeClass("collapse").addClass("collapsing").attr("aria-expanded",!1).attr("aria-hidden",!0),void($animateCss?$animateCss(element,{removeClass:"in",to:{height:"0"}}).start().done(collapseDone):$animate.removeClass(element,"in",{to:{height:"0"}}).then(collapseDone))):collapseDone()}function collapseDone(){element.css({height:"0"}),element.removeClass("collapsing").addClass("collapse")}scope.$watch(attrs.uibCollapse,function(shouldCollapse){shouldCollapse?collapse():expand()})}}}]),angular.module("CollapseDirective").value("$collapseSuppressWarning",!1).directive("collapse",["$animate","$injector","$log","$collapseSuppressWarning",function($animate,$injector,$log,$collapseSuppressWarning){var $animateCss=$injector.has("$animateCss")?$injector.get("$animateCss"):null;return{link:function(scope,element,attrs){$collapseSuppressWarning||$log.warn("collapse is now deprecated. Use uib-collapse instead.");function expand(){element.removeClass("collapse").addClass("collapsing").attr("aria-expanded",!0).attr("aria-hidden",!1),$animateCss?$animateCss(element,{addClass:"in",easing:"ease",to:{height:element[0].scrollHeight+"px"}}).start().done(expandDone):$animate.addClass(element,"in",{to:{height:element[0].scrollHeight+"px"}}).then(expandDone)}function expandDone(){element.removeClass("collapsing").addClass("collapse").css({height:"auto"})}function collapse(){return element.hasClass("collapse")||element.hasClass("in")?(element.css({height:element[0].scrollHeight+"px"}).removeClass("collapse").addClass("collapsing").attr("aria-expanded",!1).attr("aria-hidden",!0),void($animateCss?$animateCss(element,{removeClass:"in",to:{height:"0"}}).start().done(collapseDone):$animate.removeClass(element,"in",{to:{height:"0"}}).then(collapseDone))):collapseDone()}function collapseDone(){element.css({height:"0"}),element.removeClass("collapsing").addClass("collapse")}scope.$watch(attrs.collapse,function(shouldCollapse){shouldCollapse?collapse():expand()})}}}]),angular.module("CourseListDirective",[]).directive("courseList",function($window){return{scope:{courses:"=courseList"},replace:!0,restrict:"A",templateUrl:"partials/home/course/list-item.html",link:function(scope,element,attrs){}}}),angular.module("FocusAddClassDirective",[]).directive("focusAddClass",function(){return{restrict:"A",scope:{autoRemove:"="},link:function(scope,element,attrs){var mainFunc=function(){var windowHeight=$(window).height(),domTopGauge=element[0].getBoundingClientRect().top,domHeight=element[0].clientHeight,domInCenter=domTopGauge+domHeight/2>0&&windowHeight>domTopGauge+domHeight/2;domInCenter&&element.addClass(attrs.focusAddClass),!domInCenter&&scope.autoRemove&&element.removeClass(attrs.focusAddClass)};mainFunc(),$(window).scroll(mainFunc)}}}).directive("autoScreenHeight",function(){return{restrict:"A",link:function(scope,element,attrs){var windowHeight,heightPercentage=Number(attrs.heightPercentage)||100,mainFunc=function(){windowHeight=$(window).height(),element.css("height",windowHeight/100*heightPercentage),100!=heightPercentage&&element.css("marginTop",windowHeight/100*((100-heightPercentage)/2)+"px")};mainFunc(),$(window).resize(mainFunc),$(window).scroll(function(){return!1})}}}),angular.module("LoadingDirective",[]).directive("loading",function(){return{restrict:"A",template:"<div></div><div></div><div></div>",link:function(scope,element,attrs){attrs.loading&&"A"!=attrs.loading?"B"==attrs.loading?(angular.element(element).attr("class","loading line-spin-fade"),angular.element(element).html("<div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div>")):"C"==attrs.loading&&(angular.element(element).attr("class","loading line-scale"),angular.element(element).html("<div></div><div></div><div></div><div></div><div></div>")):angular.element(element).attr("class","loading ball-beat")}}}),angular.module("PaginationDirective",[]).controller("PaginationController",["$scope","$attrs","$parse",function($scope,$attrs,$parse){var self=this,ngModelCtrl={$setViewValue:angular.noop},setNumPages=$attrs.numPages?$parse($attrs.numPages).assign:angular.noop;this.init=function(ngModelCtrl_,config){ngModelCtrl=ngModelCtrl_,this.config=config,ngModelCtrl.$render=function(){self.render()},$attrs.itemsPerPage?$scope.$parent.$watch($parse($attrs.itemsPerPage),function(value){self.itemsPerPage=parseInt(value,10),$scope.totalPages=self.calculateTotalPages()}):this.itemsPerPage=config.itemsPerPage,$scope.$watch("totalItems",function(){$scope.totalPages=self.calculateTotalPages()}),$scope.$watch("totalPages",function(value){setNumPages($scope.$parent,value),$scope.page>value?$scope.selectPage(value):ngModelCtrl.$render()})},this.calculateTotalPages=function(){var totalPages=this.itemsPerPage<1?1:Math.ceil($scope.totalItems/this.itemsPerPage);return Math.max(totalPages||0,1)},this.render=function(){$scope.page=parseInt(ngModelCtrl.$viewValue,10)||1},$scope.selectPage=function(page,evt){evt&&evt.preventDefault();var clickAllowed=!$scope.ngDisabled||!evt;clickAllowed&&$scope.page!==page&&page>0&&page<=$scope.totalPages&&(evt&&evt.target&&evt.target.blur(),ngModelCtrl.$setViewValue(page),ngModelCtrl.$render())},$scope.getText=function(key){return $scope[key+"Text"]||self.config[key+"Text"]},$scope.noPrevious=function(){return 1===$scope.page},$scope.noNext=function(){return $scope.page===$scope.totalPages}}]).constant("paginationConfig",{itemsPerPage:10,boundaryLinks:!1,directionLinks:!0,firstText:"首页",previousText:"上一页",nextText:"下一页",lastText:"末页",rotate:!0}).directive("pagination",["$parse","paginationConfig",function($parse,paginationConfig){return{restrict:"EA",scope:{totalItems:"=",firstText:"@",previousText:"@",nextText:"@",lastText:"@",ngDisabled:"="},require:["pagination","?ngModel"],controller:"PaginationController",controllerAs:"pagination",templateUrl:function(element,attrs){return attrs.templateUrl||"partials/template/pagination/pagination.html"},replace:!0,link:function(scope,element,attrs,ctrls){var paginationCtrl=ctrls[0],ngModelCtrl=ctrls[1];if(ngModelCtrl){var maxSize=angular.isDefined(attrs.maxSize)?scope.$parent.$eval(attrs.maxSize):paginationConfig.maxSize,rotate=angular.isDefined(attrs.rotate)?scope.$parent.$eval(attrs.rotate):paginationConfig.rotate;scope.boundaryLinks=angular.isDefined(attrs.boundaryLinks)?scope.$parent.$eval(attrs.boundaryLinks):paginationConfig.boundaryLinks,scope.directionLinks=angular.isDefined(attrs.directionLinks)?scope.$parent.$eval(attrs.directionLinks):paginationConfig.directionLinks,paginationCtrl.init(ngModelCtrl,paginationConfig),attrs.maxSize&&scope.$parent.$watch($parse(attrs.maxSize),function(value){maxSize=parseInt(value,10),paginationCtrl.render()});function makePage(number,text,isActive){return{number:number,text:text,active:isActive}}function getPages(currentPage,totalPages){var pages=[],startPage=1,endPage=totalPages,isMaxSized=angular.isDefined(maxSize)&&totalPages>maxSize;isMaxSized&&(rotate?(startPage=Math.max(currentPage-Math.floor(maxSize/2),1),endPage=startPage+maxSize-1,endPage>totalPages&&(endPage=totalPages,startPage=endPage-maxSize+1)):(startPage=(Math.ceil(currentPage/maxSize)-1)*maxSize+1,endPage=Math.min(startPage+maxSize-1,totalPages)));for(var number=startPage;endPage>=number;number++){var page=makePage(number,number,number===currentPage);pages.push(page)}if(isMaxSized&&!rotate){if(startPage>1){var previousPageSet=makePage(startPage-1,"...",!1);pages.unshift(previousPageSet)}if(totalPages>endPage){var nextPageSet=makePage(endPage+1,"...",!1);pages.push(nextPageSet)}}return pages}var originalRender=paginationCtrl.render;paginationCtrl.render=function(){originalRender(),scope.page>0&&scope.page<=scope.totalPages&&(scope.pages=getPages(scope.page,scope.totalPages))}}}}}]).constant("pagerConfig",{itemsPerPage:10,previousText:"« 上一页",nextText:"下一页 »",align:!0}).directive("pager",["pagerConfig",function(pagerConfig){return{restrict:"EA",scope:{totalItems:"=",previousText:"@",nextText:"@",ngDisabled:"="},require:["pager","?ngModel"],controller:"PaginationController",controllerAs:"pagination",templateUrl:function(element,attrs){return attrs.templateUrl||"partials/template/pagination/pager.html"},replace:!0,link:function(scope,element,attrs,ctrls){var paginationCtrl=ctrls[0],ngModelCtrl=ctrls[1];ngModelCtrl&&(scope.align=angular.isDefined(attrs.align)?scope.$parent.$eval(attrs.align):pagerConfig.align,paginationCtrl.init(ngModelCtrl,pagerConfig))}}}]),angular.module("Qupload",["angular.modal","FileService"]).service("$qupload",["$http","$q","$localStorage",function($http,$q,$localStorage){function utf16to8(str){var out,i,len,c;for(out="",len=str.length,i=0;len>i;i++)c=str.charCodeAt(i),c>=1&&127>=c?out+=str.charAt(i):c>2047?(out+=String.fromCharCode(224|c>>12&15),out+=String.fromCharCode(128|c>>6&63),out+=String.fromCharCode(128|c>>0&63)):(out+=String.fromCharCode(192|c>>6&31),out+=String.fromCharCode(128|c>>0&63));return out}var base64EncodeChars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_";function base64encode(str){var out,i,len,c1,c2,c3;for(len=str.length,i=0,out="";len>i;){if(c1=255&str.charCodeAt(i++),i==len){out+=base64EncodeChars.charAt(c1>>2),out+=base64EncodeChars.charAt((3&c1)<<4),out+="==";break}if(c2=str.charCodeAt(i++),i==len){out+=base64EncodeChars.charAt(c1>>2),out+=base64EncodeChars.charAt((3&c1)<<4|(240&c2)>>4),out+=base64EncodeChars.charAt((15&c2)<<2),out+="=";break}c3=str.charCodeAt(i++),out+=base64EncodeChars.charAt(c1>>2),out+=base64EncodeChars.charAt((3&c1)<<4|(240&c2)>>4),out+=base64EncodeChars.charAt((15&c2)<<2|(192&c3)>>6),out+=base64EncodeChars.charAt(63&c3)}return out}var uploadEndPoint="http://up.qiniu.com";window&&window.location&&"https:"===window.location.protocol&&(uploadEndPoint="https://up.qbox.me");var defaultsSetting={chunkSize:4194304,mkblkEndPoint:uploadEndPoint+"/mkblk/",mkfileEndPoint:uploadEndPoint+"/mkfile/",maxRetryTimes:3};if(this.support=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof FileList||!Blob.prototype.slice&&!Blob.prototype.webkitSlice&&!Blob.prototype.mozSlice),!this.support)return null;var fileHashKeyFunc=function(file){return file.name+file.lastModified+file.size+file.type};this.upload=function(config){var deferred=$q.defer(),promise=deferred.promise,file=config.file;if(file){var blockRet=(fileHashKeyFunc(file),$localStorage.fileHashKey);blockRet||(blockRet=[]);var xhr,blkCount=file.size+4194303>>22,getChunck=function(file,startByte,endByte){return file[file.slice?"slice":file.mozSlice?"mozSlice":file.webkitSlice?"webkitSlice":"slice"](startByte,endByte)},getBlkSize=function(file,blkCount,blkIndex){return blkIndex===blkCount-1?file.size-4194304*blkIndex:4194304},mkfile=function(file,blockRet){if(0!==blockRet.length){for(var b,body="",i=0;i<blockRet.length-1;i++)b=angular.fromJson(blockRet[i]),body+=b.ctx+",";b=angular.fromJson(blockRet[blockRet.length-1]),body+=b.ctx;var url=defaultsSetting.mkfileEndPoint+file.size;config&&config.key&&(url+="/key/"+base64encode(utf16to8(config.key))),$http({url:url,method:"POST",data:body,headers:{Authorization:"UpToken "+config.token,"Content-Type":"text/plain"}}).success(function(e){deferred.resolve(e),$localStorage.fileHashKey=""}).error(function(e){deferred.reject(e)})}},mkblk=function(file,i,retry){if(i===blkCount)return void mkfile(file,blockRet);if(!retry)return void deferred.reject("max retried,still failure");var blkSize=getBlkSize(file,blkCount,i),offset=4194304*i,chunck=getChunck(file,offset,offset+blkSize);xhr=new XMLHttpRequest,xhr.open("POST",defaultsSetting.mkblkEndPoint+blkSize,!0),xhr.setRequestHeader("Authorization","UpToken "+config.token),xhr.upload.addEventListener("progress",function(evt){if(evt.lengthComputable){var nevt={totalSize:file.size,loaded:evt.loaded+offset};deferred.notify(nevt)}}),xhr.upload.onerror=function(){mkblk(config.file,i,--retry)},xhr.onreadystatechange=function(response){response&&4===xhr.readyState&&200===xhr.status&&(200===xhr.status?(blockRet[i]=xhr.responseText,$localStorage.fileHashKey=blockRet,mkblk(config.file,++i,defaultsSetting.maxRetryTimes)):mkblk(config.file,i,--retry))},xhr.send(chunck)};return mkblk(config.file,blockRet.length,defaultsSetting.maxRetryTimes),promise.abort=function(){xhr.abort(),$localStorage.fileHashKey=""},promise.pause=function(){xhr.abort()},promise}}}]).controller("FileController",["$localStorage","$rootScope","$scope","$attrs","$parse","$qupload","$modal","FileService",function($localStorage,$rootScope,$scope,$attrs,$parse,$qupload,$modal,FileService){var self=this;$scope.$parent.$parent.is_upload=!1,$rootScope.uploading=!1,$scope.select_files=[],$scope.is_modal=!1,$scope.upload_precent=0,$scope.file={path:"",data:""},this.getUptoken=function(type,key){
var result="";if("file"==type)result=FileService.getFileUptoken({}).$promise;else if("video"==type){if(!key||""==key)return!1;result=FileService.getVideoUptoken({key:key}).$promise}return result},this.onUploaded=function(callback){"function"==typeof callback?callback($scope.file.data):eval(callback)},this.start=function(index,uptoken,key){$scope.select_files[index].progress={precent:0},$scope.select_files[index].upload=$qupload.upload({key:key,file:$scope.select_files[index].file,token:uptoken}),$scope.select_files[index].upload.then(function(response){if(1==response.code){$scope.$parent.$parent.is_upload=!1,$rootScope.uploading=!1,$scope.is_modal?alert("上传成功"):$modal.success({title:"操作成功",message:"上传成功"});var res=response.result;$scope.file.data=res,$scope.file.path=$rootScope.config.fileUrl+res.key,$scope.$parent.section&&($scope.$parent.section.status=1,$scope.video_status=1,$scope.videoStatusCheck())}else $scope.$parent.section&&($scope.$parent.section.status=-1,$scope.video_status=-1,$scope.videoStatusCheck()),$scope.is_modal?alert("上传失败"):$modal.error({title:"上传失败",message:response.message})},function(response){console.log(response),$rootScope.modal.closeLoading(),$scope.is_modal?alert("上传失败，上传发生了未知错误，请重试"):$modal.error({title:"上传错误",message:"上传发生了未知错误，请重试"}),$scope.$parent.section&&($scope.$parent.section.status=-1,$scope.video_status=-1,$scope.videoStatusCheck())},function(evt){$scope.$parent.$parent.is_upload=!0,$rootScope.uploading=!0,$scope.select_files[index].progress.precent=Math.floor(100*evt.loaded/evt.totalSize),$scope.upload_precent=Math.floor(100*evt.loaded/evt.totalSize),100==$scope.upload_precent&&($scope.video_text="正在处理")})},$scope.abort=function(index){$scope.select_files[index].upload.abort(),$scope.select_files.splice(index,1)},$scope.pause=function(index){$scope.select_files[index].upload.abort()},$scope.hoverEvent=function(action){var value=$scope.video_status;"over"==action&&0!=value?$scope.video_text="重新上传":$scope.videoStatusCheck()},$scope.videoStatusCheck=function(){var value=$scope.video_status;switch(value){case 0:$scope.video_text="上传视频";break;case 1:$scope.video_text="正在转码";break;case 2:$scope.video_text="等待审核";break;case 3:$scope.video_text="发布成功";break;case-1:$scope.video_text="上传失败";break;case-2:$scope.video_text="转码失败";break;case-3:$scope.video_text="审核失败";break;default:$scope.video_text="重新上传"}},$scope.$watch("video_status",function(video_status){$scope.videoStatusCheck()}),$scope.onFileSelect=function($files,type,key,default_params,is_modal){$scope.is_modal=is_modal;var fileUpload=function(){$localStorage.fileHashKey="";var update_type="video"==type?"video":"file",token=self.getUptoken(update_type,key);token.then(function(res){if(1==res.code)for(var offsetx=$scope.select_files.length,i=0;i<$files.length;i++)$scope.select_files[i+offsetx]={file:$files[i]},self.start(i+offsetx,res.result,key);else $modal.error({title:"上传错误",message:res.message})})},params={};if(default_params&&(params=default_params),"image"!=type||params.max_size||(params.max_size=5),0==$files.length)return!1;if(params.max_size&&$files[0].size>1048576*params.max_size)return is_modal?alert("上传错误"):$modal.error({title:"上传错误",message:"请上传"+params.max_size+"M大小以内的文件！"}),!1;if("image"==type){if(!($files[0].type.indexOf("image")>=0))return is_modal?alert("上传错误，请上传正确格式的图片"):$modal.error({title:"上传错误",message:"请上传正确格式的图片"}),!1;if(params.min_height||params.min_width){var reader=new FileReader;return reader.readAsDataURL($files[0]),reader.onload=function(element){var data=element.target.result,image=new Image;image.onload=function(){var img_width=image.width,img_height=image.height;return img_height<params.min_height||img_width<params.min_width?(is_modal?alert("上传错误，图片尺寸最小为"+params.min_width+"×"+params.min_height):$modal.error({title:"上传错误",message:"图片尺寸最小为"+params.min_width+"×"+params.min_height}),!1):void fileUpload()},image.src=data},!1}}if("video"==type){if(""==key)return!1;if($files[0].type.indexOf("video")<0)return is_modal?alert("上传错误，请上传正确视频格式的文件"):$modal.error({title:"上传错误",message:"请上传正确视频格式的文件"}),!1}fileUpload()}}]).directive("ngFileSelect",["$parse","$timeout",function($parse,$timeout){return{scope:{onUploaded:"&uploaded",disabled:"=ngDisabled"},controller:"FileController",restrict:"EA",templateUrl:function(element,attrs){return attrs.templateUrl||"partials/template/qupload/file.html"},transclude:!0,replace:!0,link:function(scope,element,attrs,ctrls){var fileSelect=$parse(attrs.ngFileSelect);angular.isDefined(attrs.defaultFile)?scope.$parent.$eval(attrs.defaultFile):"",angular.isDefined(attrs.defaultStatus)?scope.$parent.$eval(attrs.defaultStatus):"";if(scope.video_text="上传视频",scope.video_status=0,attrs.defaultStatus&&scope.$parent.$watch($parse(attrs.defaultStatus),function(value){scope.video_status=value}),attrs.defaultFile&&scope.$parent.$watch($parse(attrs.defaultFile),function(value){value&&(scope.file.path=value)}),void 0!=scope.disabled&&scope.$watch("disabled",function(){scope.disabled?(element.attr("disabled",!0),element.addClass("disabled"),element.parent().addClass("disabled")):(element.removeAttr("disabled"),element.removeClass("disabled"),element.parent().removeClass("disabled"))}),scope.$watch("file.data",function(){attrs.uploaded&&scope.$parent.$watch($parse(attrs.uploaded),function(callback){void 0!==callback&&ctrls.onUploaded(callback)})}),"input"!==element[0].tagName.toLowerCase()||"file"!==(element.attrs("type")&&element.attrs("type").toLowerCase())){for(var fileElem=angular.element('<input type="file">'),i=0;i<element[0].attributes.length;i++)fileElem.attr(element[0].attributes[i].name,element[0].attributes[i].value);element.append(fileElem),element=fileElem}element.bind("change",function(evt){var fileList,i,files=[];if(fileList=evt.__files_||evt.target.files,null!==fileList)for(i=0;i<fileList.length;i++)files.push(fileList.item(i));$timeout(function(){fileSelect(scope,{$files:files,$event:evt})})})}}}]),angular.module("ScrolledDirective",[]).directive("whenScrolled",function(){return function(scope,element,attrs){var raw=element[0];element.bind("scroll",function(){raw.scrollTop+raw.offsetHeight>=raw.scrollHeight&&scope.$apply(attrs.whenScrolled)})}}),angular.module("TabsDirective",[]).controller("TabsetController",["$scope",function($scope){var ctrl=this,tabs=ctrl.tabs=$scope.tabs=[];ctrl.select=function(selectedTab){angular.forEach(tabs,function(tab){tab.active&&tab!==selectedTab&&(tab.active=!1,tab.onDeselect(),selectedTab.selectCalled=!1)}),selectedTab.active=!0,selectedTab.selectCalled||(selectedTab.onSelect(),selectedTab.selectCalled=!0)},ctrl.addTab=function(tab){tabs.push(tab),1===tabs.length&&tab.active!==!1?tab.active=!0:tab.active?ctrl.select(tab):tab.active=!1},ctrl.removeTab=function(tab){var index=tabs.indexOf(tab);if(tab.active&&tabs.length>1&&!destroyed){var newActiveIndex=index==tabs.length-1?index-1:index+1;ctrl.select(tabs[newActiveIndex])}tabs.splice(index,1)},ctrl.changeTo=function(tab){var index=tabs.indexOf(tab),newActiveIndex=index;ctrl.select(tabs[newActiveIndex])};var destroyed;$scope.$on("$destroy",function(){destroyed=!0})}]).directive("tabset",function(){return{restrict:"EA",transclude:!0,replace:!0,scope:{type:"@"},controller:"TabsetController",templateUrl:"partials/template/tabs/tabset.html",link:function(scope,element,attrs){scope.vertical=angular.isDefined(attrs.vertical)?scope.$parent.$eval(attrs.vertical):!1,scope.justified=angular.isDefined(attrs.justified)?scope.$parent.$eval(attrs.justified):!1,scope.largesize=angular.isDefined(attrs.largesize)?scope.$parent.$eval(attrs.largesize):!1}}}).directive("tab",["$parse",function($parse){return{require:"^tabset",restrict:"EA",replace:!0,templateUrl:"partials/template/tabs/tab.html",transclude:!0,scope:{active:"=?",heading:"@",icon:"@",onSelect:"&select",onDeselect:"&deselect",changeTo:"&change"},controller:function(){},link:function(scope,elm,attrs,tabsetCtrl,transclude){scope.$watch("active",function(active){active&&tabsetCtrl.select(scope)}),scope.disabled=!1,attrs.disable&&scope.$parent.$watch($parse(attrs.disable),function(value){scope.disabled=!!value}),scope.select=function(){scope.disabled||(scope.active=!0)},tabsetCtrl.addTab(scope),scope.$on("$destroy",function(){tabsetCtrl.removeTab(scope)}),scope.$transcludeFn=transclude}}}]).directive("tabHeadingTransclude",function(){return{restrict:"A",require:"^tab",link:function(scope,elm,attrs,tabCtrl){scope.$watch("headingElement",function(heading){heading&&(elm.html(""),elm.append(heading))})}}}).directive("tabContentTransclude",function(){return{restrict:"A",require:"^tabset",link:function(scope,elm,attrs){var tab=scope.$eval(attrs.tabContentTransclude);tab.$transcludeFn(tab.$parent,function(contents){angular.forEach(contents,function(node){isTabHeading(node)?tab.headingElement=node:elm.append(node)})})}};function isTabHeading(node){return node.tagName&&(node.hasAttribute("tab-heading")||node.hasAttribute("data-tab-heading")||node.hasAttribute("x-tab-heading")||"tab-heading"===node.tagName.toLowerCase()||"data-tab-heading"===node.tagName.toLowerCase()||"x-tab-heading"===node.tagName.toLowerCase())}}),angular.module("TooltipDirective",[]).directive("tooltip",function($window){return{restrict:"A",scope:{toolpos:"@",tooltip:"@",title:"@",tooltit:"="},link:function($scope,$element,$attrs){var tooltip=function(){var self=this;this.tigger=$scope.tooltip||"normal",this.position=$scope.toolpos||"center",this.title=$scope.tooltit||$scope.title||"",this.display=!1,this.visible=function(option){if(self.title=$scope.tooltit||$scope.title||"",!self.title)return!1;document.getElementById("J_tooltip")&&angular.element(document.getElementById("J_tooltip")).remove(),$element.addClass("tooltip-active");var tooltip_template='<div id="J_tooltip" class="tooltip tooltip-hidden">';tooltip_template+='<div class="tooltip-inner">',tooltip_template+='<span class="tooltip-text">'+self.title+"</span>",tooltip_template+='<span class="tooltip-sulg"></span>',tooltip_template+="</div></div>",angular.element(document.body).append(tooltip_template);var tool_element=angular.element(document.getElementById("J_tooltip")),tool_position=function(){switch(self.position){case"center":return $element[0].getBoundingClientRect().left+$element[0].offsetWidth/2-document.getElementById("J_tooltip").offsetWidth/2+"px";case"left":return $element[0].getBoundingClientRect().left-document.getElementById("J_tooltip").offsetWidth/2+"px";case"right":return $element[0].getBoundingClientRect().left+$element[0].offsetWidth-document.getElementById("J_tooltip").offsetWidth/2+"px";default:return $element[0].getBoundingClientRect().left+$element[0].offsetWidth/2-document.getElementById("J_tooltip").offsetWidth/2+"px"}};tool_element.css("left",tool_position()),tool_element.css("top",$element[0].getBoundingClientRect().top-40+"px"),tool_element.removeClass("tooltip-hidden"),tool_element.addClass("tooltip-display"),self.display=!0,option&&option.autohide&&setTimeout(function(){$element.removeClass("tooltip-active"),tool_element.removeClass("tooltip-display"),tool_element.addClass("tooltip-hidden"),$scope.tooltit=""},600),self.scroll(),self.resize()},this.hidden=function(){$element.removeClass("tooltip-active");var tool_element=angular.element(document.getElementById("J_tooltip"));tool_element.removeClass("tooltip-display"),tool_element.addClass("tooltip-hidden"),setTimeout(function(){tool_element.remove()},500),self.display=!1},this.hover=function(){var title=$attrs.title;$element.bind("mouseover",function(){void 0!=$attrs.title&&""!=$attrs.title&&($element.attr("title",""),self.visible())}),$element.bind("mouseout",function(){$element.attr("title",title),self.hidden()})},this.focus=function(){"INPUT"==$element[0].tagName.toUpperCase()?($element.bind("focus",function(){self.visible()}),$element.bind("blur",function(){self.hidden()})):($element.bind("click",function(){self.display?self.hidden():self.visible()}),$element.bind("blur",function(){self.hidden()}))},this.event=function(){$scope.$watch("tooltit",function(){self.title=$scope.tooltit,self.visible({autohide:!0})})},this.bind=function(){switch(self.tigger){case"normal":self.hover();break;case"focus":self.focus();break;case"event":self.event()}},this.scroll=function(){angular.element($window).bind("scroll",function(){angular.element(document.getElementById("J_tooltip"))&&self.hidden()})},this.resize=function(){angular.element($window).bind("resize",function(){})}},_tooltip=new tooltip;_tooltip.bind()}}}),angular.module("TotopDirective",[]).directive("goToTop",function($window){return{replace:!0,restrict:"A",template:'<a href="" class="go-to-top"><i class="icon icon-to-top"></i></a>',link:function(scope,element,attrs){var window_height=$window.innerHeight;angular.element($window).bind("resize",function(){window_height=$window.innerHeight}),$window.pageYOffset<=window_height/2&&(element.removeClass("display"),element.addClass("none"),element.prev().addClass("is-top")),angular.element($window).bind("scroll",function(){$window.pageYOffset<=window_height/2?(element.removeClass("display"),element.addClass("none"),element.prev().addClass("is-top")):(element.removeClass("none"),element.addClass("display"),element.prev().removeClass("is-top"))}),element.bind("click",function(){var scrollTo=function(element,to,duration){if(!(0>=duration)){var difference=to-element.scrollTop,perTick=difference/duration*10;setTimeout(function(){element.scrollTop=element.scrollTop+perTick,element.scrollTop!=to&&scrollTo(element,to,duration-10)},10)}};scrollTo(document.body,0,300)})}}}),angular.module("ui.bootstrap.position",[]).factory("$position",["$document","$window",function($document,$window){function getStyle(el,cssprop){return el.currentStyle?el.currentStyle[cssprop]:$window.getComputedStyle?$window.getComputedStyle(el)[cssprop]:el.style[cssprop]}function isStaticPositioned(element){return"static"===(getStyle(element,"position")||"static")}var parentOffsetEl=function(element){for(var docDomEl=$document[0],offsetParent=element.offsetParent||docDomEl;offsetParent&&offsetParent!==docDomEl&&isStaticPositioned(offsetParent);)offsetParent=offsetParent.offsetParent;return offsetParent||docDomEl};return{position:function(element){var elBCR=this.offset(element),offsetParentBCR={top:0,left:0},offsetParentEl=parentOffsetEl(element[0]);offsetParentEl!=$document[0]&&(offsetParentBCR=this.offset(angular.element(offsetParentEl)),offsetParentBCR.top+=offsetParentEl.clientTop-offsetParentEl.scrollTop,offsetParentBCR.left+=offsetParentEl.clientLeft-offsetParentEl.scrollLeft);var boundingClientRect=element[0].getBoundingClientRect();return{width:boundingClientRect.width||element.prop("offsetWidth"),height:boundingClientRect.height||element.prop("offsetHeight"),top:elBCR.top-offsetParentBCR.top,left:elBCR.left-offsetParentBCR.left}},offset:function(element){var boundingClientRect=element[0].getBoundingClientRect();return{width:boundingClientRect.width||element.prop("offsetWidth"),height:boundingClientRect.height||element.prop("offsetHeight"),top:boundingClientRect.top+($window.pageYOffset||$document[0].documentElement.scrollTop),left:boundingClientRect.left+($window.pageXOffset||$document[0].documentElement.scrollLeft)}},positionElements:function(hostEl,targetEl,positionStr,appendToBody){var hostElPos,targetElWidth,targetElHeight,targetElPos,positionStrParts=positionStr.split("-"),pos0=positionStrParts[0],pos1=positionStrParts[1]||"center";hostElPos=appendToBody?this.offset(hostEl):this.position(hostEl),targetElWidth=targetEl.prop("offsetWidth"),targetElHeight=targetEl.prop("offsetHeight");var shiftWidth={center:function(){return hostElPos.left+hostElPos.width/2-targetElWidth/2},left:function(){return hostElPos.left},right:function(){return hostElPos.left+hostElPos.width}},shiftHeight={center:function(){return hostElPos.top+hostElPos.height/2-targetElHeight/2},top:function(){return hostElPos.top},bottom:function(){return hostElPos.top+hostElPos.height}};switch(pos0){case"right":targetElPos={top:shiftHeight[pos1](),left:shiftWidth[pos0]()};break;case"left":targetElPos={top:shiftHeight[pos1](),left:hostElPos.left-targetElWidth};break;case"bottom":targetElPos={top:shiftHeight[pos0](),left:shiftWidth[pos1]()};break;default:targetElPos={top:hostElPos.top-targetElHeight,left:shiftWidth[pos1]()}}return targetElPos}}}]),angular.module("TypeaheadDirective",["ui.bootstrap.position"]).factory("typeaheadParser",["$parse",function($parse){var TYPEAHEAD_REGEXP=/^\s*([\s\S]+?)(?:\s+as\s+([\s\S]+?))?\s+for\s+(?:([\$\w][\$\w\d]*))\s+in\s+([\s\S]+?)$/;return{parse:function(input){var match=input.match(TYPEAHEAD_REGEXP);if(!match)throw new Error('Expected typeahead specification in form of "_modelValue_ (as _label_)? for _item_ in _collection_" but got "'+input+'".');return{itemName:match[3],source:$parse(match[4]),viewMapper:$parse(match[2]||match[1]),modelMapper:$parse(match[1])}}}}]).directive("typeahead",["$compile","$parse","$q","$timeout","$document","$window","$rootScope","$position","typeaheadParser",function($compile,$parse,$q,$timeout,$document,$window,$rootScope,$position,typeaheadParser){var HOT_KEYS=[9,13,27,38,40],eventDebounceTime=200;return{require:["ngModel","^?ngModelOptions"],link:function(originalScope,element,attrs,ctrls){var modelCtrl=ctrls[0],ngModelOptions=ctrls[1],minLength=originalScope.$eval(attrs.typeaheadMinLength);minLength||0===minLength||(minLength=1);var hasFocus,selected,waitTime=originalScope.$eval(attrs.typeaheadWaitMs)||0,isEditable=originalScope.$eval(attrs.typeaheadEditable)!==!1,isLoadingSetter=$parse(attrs.typeaheadLoading).assign||angular.noop,onSelectCallback=$parse(attrs.typeaheadOnSelect),isSelectOnBlur=angular.isDefined(attrs.typeaheadSelectOnBlur)?originalScope.$eval(attrs.typeaheadSelectOnBlur):!1,isNoResultsSetter=$parse(attrs.typeaheadNoResults).assign||angular.noop,inputFormatter=attrs.typeaheadInputFormatter?$parse(attrs.typeaheadInputFormatter):void 0,appendToBody=attrs.typeaheadAppendToBody?originalScope.$eval(attrs.typeaheadAppendToBody):!1,focusFirst=originalScope.$eval(attrs.typeaheadFocusFirst)!==!1,selectOnExact=attrs.typeaheadSelectOnExact?originalScope.$eval(attrs.typeaheadSelectOnExact):!1,parsedModel=$parse(attrs.ngModel),invokeModelSetter=$parse(attrs.ngModel+"($$$p)"),$setModelValue=function(scope,newValue){return angular.isFunction(parsedModel(originalScope))&&ngModelOptions&&ngModelOptions.$options&&ngModelOptions.$options.getterSetter?invokeModelSetter(scope,{$$$p:newValue}):parsedModel.assign(scope,newValue)},parserResult=typeaheadParser.parse(attrs.typeahead),scope=originalScope.$new(),offDestroy=originalScope.$on("$destroy",function(){scope.$destroy()});scope.$on("$destroy",offDestroy);var popupId="typeahead-"+scope.$id+"-"+Math.floor(1e4*Math.random());element.attr({"aria-autocomplete":"list","aria-expanded":!1,"aria-owns":popupId});var popUpEl=angular.element("<div typeahead-popup></div>");popUpEl.attr({id:popupId,matches:"matches",active:"activeIdx",select:"select(activeIdx)","move-in-progress":"moveInProgress",query:"query",position:"position"}),angular.isDefined(attrs.typeaheadTemplateUrl)&&popUpEl.attr("template-url",attrs.typeaheadTemplateUrl),angular.isDefined(attrs.typeaheadPopupTemplateUrl)&&popUpEl.attr("popup-template-url",attrs.typeaheadPopupTemplateUrl);var resetMatches=function(){scope.matches=[],scope.activeIdx=-1,element.attr("aria-expanded",!1)},getMatchId=function(index){return popupId+"-option-"+index};scope.$watch("activeIdx",function(index){0>index?element.removeAttr("aria-activedescendant"):element.attr("aria-activedescendant",getMatchId(index))});var inputIsExactMatch=function(inputValue,index){return scope.matches.length>index&&inputValue?inputValue.toUpperCase()===scope.matches[index].label.toUpperCase():!1},getMatchesAsync=function(inputValue){var locals={$viewValue:inputValue};isLoadingSetter(originalScope,!0),isNoResultsSetter(originalScope,!1),$q.when(parserResult.source(originalScope,locals)).then(function(matches){var onCurrentRequest=inputValue===modelCtrl.$viewValue;if(onCurrentRequest&&hasFocus)if(matches&&matches.length>0){scope.activeIdx=focusFirst?0:-1,isNoResultsSetter(originalScope,!1),scope.matches.length=0;for(var i=0;i<matches.length;i++)locals[parserResult.itemName]=matches[i],scope.matches.push({id:getMatchId(i),label:parserResult.viewMapper(scope,locals),model:matches[i]});scope.query=inputValue,recalculatePosition(),element.attr("aria-expanded",!0),selectOnExact&&1===scope.matches.length&&inputIsExactMatch(inputValue,0)&&scope.select(0)}else resetMatches(),isNoResultsSetter(originalScope,!0);onCurrentRequest&&isLoadingSetter(originalScope,!1)},function(){resetMatches(),isLoadingSetter(originalScope,!1),isNoResultsSetter(originalScope,!0)})};appendToBody&&(angular.element($window).bind("resize",fireRecalculating),$document.find("body").bind("scroll",fireRecalculating));var timeoutEventPromise;scope.moveInProgress=!1;function fireRecalculating(){scope.moveInProgress||(scope.moveInProgress=!0,scope.$digest()),timeoutEventPromise&&$timeout.cancel(timeoutEventPromise),timeoutEventPromise=$timeout(function(){scope.matches.length&&recalculatePosition(),scope.moveInProgress=!1,scope.$digest()},eventDebounceTime)}function recalculatePosition(){scope.position=appendToBody?$position.offset(element):$position.position(element),scope.position.top+=element.prop("offsetHeight")}resetMatches(),scope.query=void 0;var timeoutPromise,scheduleSearchWithTimeout=function(inputValue){timeoutPromise=$timeout(function(){getMatchesAsync(inputValue)},waitTime)},cancelPreviousTimeout=function(){timeoutPromise&&$timeout.cancel(timeoutPromise)};modelCtrl.$parsers.unshift(function(inputValue){return hasFocus=!0,0===minLength||inputValue&&inputValue.length>=minLength?waitTime>0?(cancelPreviousTimeout(),scheduleSearchWithTimeout(inputValue)):getMatchesAsync(inputValue):(isLoadingSetter(originalScope,!1),cancelPreviousTimeout(),resetMatches()),isEditable?inputValue:inputValue?void modelCtrl.$setValidity("editable",!1):(modelCtrl.$setValidity("editable",!0),null)}),modelCtrl.$formatters.push(function(modelValue){var candidateViewValue,emptyViewValue,locals={};return isEditable||modelCtrl.$setValidity("editable",!0),inputFormatter?(locals.$model=modelValue,inputFormatter(originalScope,locals)):(locals[parserResult.itemName]=modelValue,candidateViewValue=parserResult.viewMapper(originalScope,locals),locals[parserResult.itemName]=void 0,emptyViewValue=parserResult.viewMapper(originalScope,locals),candidateViewValue!==emptyViewValue?candidateViewValue:modelValue)}),scope.select=function(activeIdx){var model,item,locals={};selected=!0,locals[parserResult.itemName]=item=scope.matches[activeIdx].model,model=parserResult.modelMapper(originalScope,locals),$setModelValue(originalScope,model),modelCtrl.$setValidity("editable",!0),modelCtrl.$setValidity("parse",!0),onSelectCallback(originalScope,{$item:item,$model:model,$label:parserResult.viewMapper(originalScope,locals)}),resetMatches(),scope.$eval(attrs.typeaheadFocusOnSelect)!==!1&&$timeout(function(){element[0].focus()},0,!1)},element.bind("keydown",function(evt){if(0!==scope.matches.length&&-1!==HOT_KEYS.indexOf(evt.which)){if(-1===scope.activeIdx&&(9===evt.which||13===evt.which))return resetMatches(),void scope.$digest();evt.preventDefault(),40===evt.which?(scope.activeIdx=(scope.activeIdx+1)%scope.matches.length,scope.$digest()):38===evt.which?(scope.activeIdx=(scope.activeIdx>0?scope.activeIdx:scope.matches.length)-1,scope.$digest()):13===evt.which||9===evt.which?scope.$apply(function(){scope.select(scope.activeIdx)}):27===evt.which&&(evt.stopPropagation(),resetMatches(),scope.$digest())}}),element.bind("blur",function(){isSelectOnBlur&&scope.matches.length&&-1!==scope.activeIdx&&!selected&&(selected=!0,scope.$apply(function(){scope.select(scope.activeIdx)})),hasFocus=!1,selected=!1});var dismissClickHandler=function(evt){element[0]!==evt.target&&3!==evt.which&&0!==scope.matches.length&&(resetMatches(),$rootScope.$$phase||scope.$digest())};$document.bind("click",dismissClickHandler),originalScope.$on("$destroy",function(){$document.unbind("click",dismissClickHandler),appendToBody&&$popup.remove(),popUpEl.remove()});var $popup=$compile(popUpEl)(scope);appendToBody?$document.find("body").append($popup):element.after($popup)}}}]).directive("typeaheadPopup",function(){return{restrict:"EA",scope:{matches:"=",query:"=",active:"=",position:"&",moveInProgress:"=",select:"&"},replace:!0,templateUrl:function(element,attrs){return attrs.popupTemplateUrl||"partials/template/typeahead/popup.html"},link:function(scope,element,attrs){scope.templateUrl=attrs.templateUrl,scope.isOpen=function(){return scope.matches.length>0},scope.isActive=function(matchIdx){return scope.active==matchIdx},scope.selectActive=function(matchIdx){scope.active=matchIdx},scope.selectMatch=function(activeIdx){scope.select({activeIdx:activeIdx})}}}}).directive("typeaheadMatch",["$templateRequest","$compile","$parse",function($templateRequest,$compile,$parse){return{restrict:"EA",scope:{index:"=",match:"=",query:"="},link:function(scope,element,attrs){var tplUrl=$parse(attrs.templateUrl)(scope.$parent)||"partials/template/typeahead/match.html";$templateRequest(tplUrl).then(function(tplContent){$compile(tplContent.trim())(scope,function(clonedElement){element.replaceWith(clonedElement)})})}}}]).filter("typeaheadHighlight",["$sce","$injector","$log",function($sce,$injector,$log){var isSanitizePresent;isSanitizePresent=$injector.has("$sanitize");function escapeRegexp(queryToEscape){return queryToEscape.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}function containsHtml(matchItem){return/<.*>/g.test(matchItem)}return function(matchItem,query){return!isSanitizePresent&&containsHtml(matchItem)&&$log.warn("Unsafe use of typeahead please use ngSanitize"),matchItem=query?(""+matchItem).replace(new RegExp(escapeRegexp(query),"gi"),"<strong>$&</strong>"):matchItem,isSanitizePresent||(matchItem=$sce.trustAsHtml(matchItem)),matchItem}}]),angular.module("Umeditor",[]).directive("umeditor",["$timeout",function($timeout){return{restrict:"EA",require:"ngModel",scope:{},link:function(scope,element,attrs,controller){var editor_id=attrs.id?attrs.id:"_editor"+Date.now();element[0].id=editor_id;var umeditor=UM.getEditor(editor_id);controller&&(umeditor.addListener("contentChange",function(){$timeout(function(argument){scope.$apply(function(){controller.$setViewValue(umeditor.getContent())})},0)}),controller.$render=function(){$timeout(function(){void 0!=controller.$viewValue&&umeditor.setContent(controller.$viewValue)},100)})}}}]),angular.module("MainController",["angular.modal","LinkModel","IndexModel","CategoryModel","TotopDirective","FeedbackModel"]).controller("MainController",["$rootScope","$scope","$stateParams","$state","$location","$localStorage","$anchorScroll","$modal","$window","$timeout","appConfig","CommonProvider","AuthProvider","LinkModel","IndexModel","CategoryModel","CommonModel","FeedbackModel",function($rootScope,$scope,$stateParams,$state,$location,$localStorage,$anchorScroll,$modal,$window,$timeout,appConfig,CommonProvider,AuthProvider,LinkModel,IndexModel,CategoryModel,CommonModel,FeedbackModel){$rootScope.config=appConfig,$scope.parseInt=parseInt,$rootScope.navBarHide=!1,$scope.$on("$stateChangeSuccess",function(){$rootScope.title=$state.current.data.title||$state.$current.parent.data.title||""}),$rootScope.modal={login:function(callback){$modal.custom({title:"登录/注册",template_url:"/partials/home/layout/login.html",callback:callback})},imagePreview:function(url){var img_url;img_url=url.indexOf("http")>=0?url:$rootScope.config.fileUrl+url,$modal.image({url:img_url})},submit:function(){$modal.confirmSubmit()},cancel:function(){$modal.confirmCancel()},loading:function(){$modal.loading()},closeLoading:function(){$modal.closeLoading()},close:function(){$modal.closeCallback()},error:function(config){$modal.error({message:config.message||"error",info:config.info||""})},feedback:function(){$modal.custom({title:"反馈信息",template_url:"/partials/home/layout/feedback.html"})}};var exclude_api=["partner","index","category","advertise","link","search/hot","follow","record"];$rootScope.$on("cfpLoadingBar:loading",function(event,data){exclude_api.containStr(data.url)&&$rootScope.modal.loading(),exclude_api.containStr(data.url)||$rootScope.modal.closeLoading()}),$rootScope.$on("cfpLoadingBar:completed",function(event,data){$rootScope.modal.closeLoading()}),$rootScope.postFeedback=function(feedback){return feedback.content?void CommonProvider.promise({model:FeedbackModel,method:"add",params:feedback,success:function(feedback){$rootScope.modal.close(),$modal.success({title:"反馈成功",message:"反馈成功，感谢你的支持"})},error:function(feedback){$modal.error({title:"反馈失败",message:feedback.message})}}):!1},$scope.logout=AuthProvider.logout,$rootScope.goTo=CommonProvider.goToDom,$rootScope.getThumbnail=CommonProvider.getThumbnail,$rootScope.share=CommonProvider.share,$rootScope.toTop=CommonProvider.toTop,$rootScope.checkLogin=function(option){$localStorage.token||("modal"==option?$modal.custom({title:"登录",template_url:"/partials/home/layout/login.html"}):$location.path("auth/login"))},$scope.getFriendLinks=function(){$localStorage.friendLinks&&($scope.friendLinks=$localStorage.friendLinks),CommonProvider.promise({model:LinkModel,method:"get",params:{role:"user",type:1,page:1,per_page:100},success:function(links){$localStorage.friendLinks=links.result,$scope.friendLinks=links.result}})},$scope.getArticleCates=function(){CommonProvider.promise({model:CategoryModel,method:"get",params:{role:"student",type:3,per_page:100},success:function(articleCates){$scope.articleCates=articleCates.result}})},$rootScope.getConfig=function(params){var get_config={};return params.group&&(get_config={role:"user",is_front:1,per_page:100,parge:1,group:params.group}),params.name&&(get_config.name=params.name),get_config.name||get_config.group?void CommonProvider.promise({model:CommonModel,method:get_config.name?"configByName":"config",params:get_config,success:function(config){params.success&&params.success(config)}}):!1},$rootScope.date=new Date,moment.locale("zh-cn",{relativeTime:{future:"%s",past:"%s",s:"刚刚",m:"1分钟前",mm:"%d分钟前",h:"1小时前",hh:"%d小时前",d:"1天前",dd:"%d天前",M:"1个月前",MM:"%d个月前",y:"1年前",yy:"%d年前"}}),$rootScope.moment=new moment,$rootScope.setTokenLimit=function(auto_login){var token_limit={};token_limit.start_time=(new Date).getTime()/1e3/60,auto_login&&(token_limit.end_time=$rootScope.date.getTime()/1e3/60+43200),auto_login||(token_limit.end_time=$rootScope.date.getTime()/1e3/60+1440),$localStorage.token_limit||($localStorage.token_limit={}),$localStorage.token_limit=token_limit},$rootScope.updateToken=function(){$localStorage.token&&($localStorage.token_limit?$localStorage.token_limit.end_time-$rootScope.date.getTime()/1e3/60<=60&&$rootScope.date.getTime()/1e3/60-$localStorage.token_limit.last_request<60&&($rootScope.date.getTime()/1e3/60-$localStorage.token_limit.last_token_request>10||!$localStorage.token_limit.last_token_request)&&($localStorage.token_limit.last_token_request=$rootScope.date.getTime()/1e3/60,Main.update_token({token:$localStorage.token},function(token){1==token.code?($localStorage.token=token.result,console.log("token就快过期，已执行了更换"),$localStorage.token_limit.start_time=$rootScope.date.getTime()/1e3/60,$localStorage.token_limit.end_time=$rootScope.date.getTime()/1e3/60+1440,$localStorage.token_limit.last_token_request=$rootScope.date.getTime()/1e3/60):console.log(token.message)})):$localStorage.token_limit={},$localStorage.token_limit.last_request=$rootScope.date.getTime()/1e3/60)},$rootScope.setTabActive=CommonProvider.setTabActive,$rootScope.setDomPosition=function(scope){$location.$$hash&&$rootScope.goTo($location.$$hash),$location.$$search.tab&&$rootScope.setTabActive(scope,$location.$$search.tab)}}]),angular.module("HeaderController",["SearchModel","TypeaheadDirective","SearchService"]).controller("HeaderController",["$rootScope","$scope","$state","$stateParams","$location","$localStorage","CommonProvider","SearchModel","SearchService",function($rootScope,$scope,$state,$stateParams,$location,$localStorage,CommonProvider,SearchModel,SearchService){
$scope.search||($scope.search={}),$scope.isActive={},$scope.searchBoxInit=function(){$scope.search.type=1,$scope.search.lists={},$scope.search.keyword="",$scope.search.hotwords={},$scope.getHotWords()},$scope.searchTypeChange=function(){$scope.search.type=1==$scope.search.type?2:1,$scope.search.keyword=""},$scope.searchSuggest=function(keyword){return CommonProvider.request({method:"get",service:new SearchService,params:{keyword:keyword,only_name:0,search_type:1==$scope.search.type?"course":"organization"}}).then(function(res){return res.result})},$scope.searchResult=function(keyword){keyword?1==$scope.search.type?$location.path("/course/search/"+$scope.search.keyword):$location.path("/organization/search/"+$scope.search.keyword):1==$scope.search.type?$location.path("/course"):$location.path("/organization")},$scope.getHotWords=function(){return $scope.search.hotwords.courses?!1:void CommonProvider.promise({model:SearchModel,method:"getHotWords",params:{out_type:"array"},success:function(hotwords){$scope.search.hotwords=hotwords.result}})},$scope.hotWordClick=function(keyword){$scope.search.keyword=keyword,1==$scope.search.type?$location.path("/course/search/"+$scope.search.keyword):$location.path("/organization/search/"+$scope.search.keyword)},$scope.getBaseConfig=function(){$rootScope.getConfig({group:1,success:function(_base_config){$localStorage.site_config=$localStorage.site_config||{},$localStorage.site_config.base=_base_config.result.toObject("name","value"),$rootScope.site_config=$localStorage.site_config}})},$scope.$on("$stateChangeSuccess",function(){$scope.isActive.index="index"==$state.current.name,$scope.isActive.course=$state.current.name.contain("course"),$scope.isActive.organization=$state.current.name.contain("organization"),$state.params.key?($scope.search.keyword=$state.params.key,$scope.search.type=$state.current.url.contain("course")?1:2):($scope.search.type=1,$scope.search.keyword="")})}]),angular.module("ArticleController",["ArticleModel"]).controller("ArticleController",["$rootScope","$scope","$state","$modal","$stateParams","$location","CommonProvider","ArticleModel",function($rootScope,$scope,$state,$modal,$stateParams,$location,CommonProvider,ArticleModel){$scope.currentArticle={},$scope.category_id=$stateParams.category_id||!1,$scope.article_id=$stateParams.article_id||!1,$scope.getArticleList=function(){CommonProvider.promise({model:ArticleModel,method:"get",params:{role:"user",category_id:$scope.category_id,per_page:100},success:function(articles){$scope.articles=articles.result,$scope.currentArticle=$scope.articles[0]}})},$scope.getRegistlicense=function(){Main.get_license({type:"user_register"},function(license){1==license.code?$scope.license=license.result:$modal.error({message:license.message})})}}]),angular.module("IndexController",["angular.modal","angular.bootstrap.carousel","FocusAddClassDirective","CategoryModel","AdvertiseModel"]).controller("IndexController",["$scope","$rootScope","$modal","$timeout","$location","$localStorage","appConfig","CommonProvider","CategoryModel","AdvertiseModel","IndexModel",function($scope,$rootScope,$modal,$timeout,$location,$localStorage,appConfig,CommonProvider,CategoryModel,AdvertiseModel,IndexModel){var active_partner_last_index,active_partner_first_index=0;$scope.initIndex=function(){CommonProvider.promise({model:AdvertiseModel,method:"get",params:{role:"user",type:1,per_page:100},success:function(advertise){$scope.banners=advertise.result}}),$localStorage.categories&&($scope.main_categories=$localStorage.categories),CommonProvider.promise({model:CategoryModel,method:"get",params:{role:"student",type:1},success:function(categories){$localStorage.categories=categories.result,$scope.main_categories=categories.result}}),$localStorage.indexCategories&&($scope.categories=$localStorage.indexCategories),CommonProvider.promise({model:IndexModel,method:"get",params:{role:"user"},success:function(index){$localStorage.indexCategories=index.result,$scope.categories=index.result}}),CommonProvider.promise({model:IndexModel,method:"partners",params:{role:"user",per_page:100},success:function(partners){$scope.partners=partners.result,$scope.activePartners=$scope.partners,active_partner_last_index=$scope.partners.length>=8?8:$scope.partners.length-1}})},$scope.toPrevPage=function(){$scope.activePartners=[];var active_partner_index=0;8>=active_partner_first_index&&(active_partner_first_index=$scope.partners.length);for(var i=active_partner_first_index-8;active_partner_first_index>i;i++){if(!$scope.partners[i]){active_partner_first_index=$scope.partners.length;break}$scope.activePartners[active_partner_index]=$scope.partners[i],active_partner_index+=1}active_partner_last_index=active_partner_first_index,active_partner_first_index-=8},$scope.toNextPage=function(){$scope.activePartners=[];var active_partner_index=0;active_partner_last_index>=$scope.partners.length&&(active_partner_last_index=0);for(var i=active_partner_last_index;active_partner_last_index+8>i;i++){if(!$scope.partners[i]){active_partner_last_index=0;break}$scope.activePartners[active_partner_index]=$scope.partners[i],active_partner_index+=1}active_partner_last_index=i},$scope.getAppDownload=function(){$rootScope.getConfig({name:"APP_DOWNLOAD",success:function(links){$scope.download_link=links.result.value}})}}]),angular.module("AuthController",["angular.validation","angular.validation.rule","AuthModel"]).controller("AuthController",["$rootScope","$scope","$location","$localStorage","$state","$timeout","$interval","$modal","$window","AuthModel","CommonProvider","AuthProvider","CommonModel",function($rootScope,$scope,$location,$localStorage,$state,$timeout,$interval,$modal,$window,AuthModel,CommonProvider,AuthProvider,CommonModel){$scope.thirdLoginInfo=$localStorage.thirdLoginInfo||!1,$scope.verify={text:"获取手机校验码",status:!1,verifyed:!1,phone:!1,warning:!1,message:""},$scope.auth={mode:"login",bind:!1,auto:!0,agree:!0,success:!1},$scope.user={auto_login:!0},$scope.login=AuthProvider.login,$scope.logout=AuthProvider.logout,$scope.register=function(params){CommonProvider.promise({model:AuthModel,method:"register",params:$scope.user,success:function(auth){return $localStorage.token=auth.result,$rootScope.setTokenLimit(),params.callback?(params.callback(auth),!1):void $modal.success({message:"注册成功",callback:function(){AuthProvider.init(),$location.path("/user/index")}})},error:function(auth){$modal.error({message:auth.message})}})},$scope.bindLogin=function(params){AuthProvider.login({user:$scope.user,callback:function(token){$scope.thirdBind({bind:!1,modal:params.modal||!1})}})},$scope.bindRegister=function(params){$scope.register({callback:function(token){$scope.thirdBind({bind:!1,modal:params.modal||!1})}})},$scope.forgot=function(){CommonProvider.promise({model:AuthModel,method:"forgot",params:$scope.user,success:function(auth){$scope.auth.success=!0,$timeout(function(){$location.path("/auth/login")},2e3)},error:function(auth){$modal.error({message:auth.message})}})},$scope.getVerifyCode=function(config){if(!$scope.user.phone)return!1;if($scope.user.phone&&11!=$scope.user.phone.length)return!1;if($scope.user.phone&&isNaN(parseInt($scope.user.phone)))return!1;if($scope.verify.status)return!1;$scope.verify.seconds=60;var timePromise,verifyTimimg=function(){return timePromise=$interval(function(){$scope.verify.seconds-=1,$scope.verify.status=!0,$scope.verify.text=$scope.verify.seconds+"秒后重新获取",0==$scope.verify.seconds&&($scope.verify.status=!1,$scope.verify.text="重新获取校验码")},1e3,$scope.verify.seconds)};CommonProvider.promise({model:CommonModel,method:"sms",params:{rule:"exist"==config.type?"check_mobile_exists":"check_mobile_unique",phone:$scope.user.phone},success:function(verify){config.modal&&($scope.verify.warning=!1),config.modal||$modal.success({message:verify.message}),verifyTimimg()},error:function(verify){config.modal?($scope.verify.warning=!0,$scope.verify.message=verify.message):$modal.error({message:verify.message})}})},$scope.getThirdAccounts=function(){CommonProvider.promise({model:AuthModel,method:"getThirds",success:function(accounts){$scope.third_accounts=accounts.result}})},$scope.thirdLogin=function(config){if(void 0==config.provider)return!1;var loginCodeCheckInterval,loginProviders={qq:{name:"qq",title:"QQ授权登录",author_ization_endpoint:"https://graph.qq.com/oauth2.0/authorize",required_url_params:{response_type:"code",state:"qq",client_id:"101277423",display:"default",scope:"get_user_info",redirect_uri:"http://xuetianxia.cn/partials/home/auth/relay.html"},oauth_type:"2.0",popup_options:{width:700,height:520}},weibo:{name:"weibo",title:"微博授权登录",author_ization_endpoint:"https://api.weibo.com/oauth2/authorize",required_url_params:{state:"weibo",client_id:"3912473749",display:"default",scope:"",redirect_uri:"http://xuetianxia.cn/partials/home/auth/relay.html"},oauth_type:"2.0",popup_options:{width:760,height:570}},wechat:{name:"wechat",title:"微信授权登录",author_ization_endpoint:"https://open.weixin.qq.com/connect/qrconnect",required_url_params:{state:"wechat",response_type:"code",appid:"wx0ed2dfdc25e8a274",scope:"snsapi_login",redirect_uri:"http://xuetianxia.cn/partials/home/auth/relay.html"},oauth_type:"2.0",popup_options:{width:730,height:530}}},getLoginStatus=function(type,code){CommonProvider.promise({model:AuthModel,method:"thirdLogin",params:{type:type,code:code},result:function(user){1==user.code?config.bind?$modal.error({message:"账户已被绑定",info:"您的账户已和“"+user.result.name+"”绑定，请更换账户",lazytime:5}):($localStorage.token=user.result,AuthProvider.init(function(){config.modal&&$rootScope.modal.close(),config.modal||$location.path("user/index")})):2==user.code?($localStorage.thirdLoginInfo=user.result,$scope.thirdLoginInfo=$localStorage.thirdLoginInfo,config.bind&&$scope.thirdBind(config),config.bind||(config.modal&&($scope.auth.bind=!0),config.modal||$location.path("auth/bind"))):$modal.error({message:"参数异常，请稍后重试"}),delete $localStorage.thirdLoginCode}})},checkLoginCode=function(){if($localStorage.thirdLoginCode){var thirdLoginCode=$localStorage.thirdLoginCode,type=loginProviders[config.provider].name,code=thirdLoginCode[loginProviders[config.provider].required_url_params.state];getLoginStatus(type,code),clearInterval(loginCodeCheckInterval)}},loginPopup=function(provider_name){var popup_config=loginProviders[provider_name];if(!popup_config)return!1;popup_config.popup_options.top=($window.outerHeight-popup_config.popup_options.height)/2,popup_config.popup_options.left=($window.outerWidth-popup_config.popup_options.width)/2;var popup_url=[popup_config.author_ization_endpoint,query_format(popup_config.required_url_params)].join("?"),popup_title=popup_config.title,popup_options=query_format(popup_config.popup_options,",");$window.open(popup_url,popup_title,popup_options),loginCodeCheckInterval=setInterval(checkLoginCode,1e3)},query_format=function(params,delimiter){var delimiter=delimiter||"&",str=[];return angular.forEach(params,function(value,key){str.push(encodeURIComponent(key)+"="+value)}),str.join(delimiter)};loginPopup(config.provider)},$scope.thirdBind=function(config){if($localStorage.thirdLoginInfo&&($scope.thirdLoginInfo=$localStorage.thirdLoginInfo),!$localStorage.thirdLoginInfo)return console.log("本地缺少用户基本信息");var third_type_code=$scope.thirdLoginInfo.type,third_type=function(){switch(third_type_code){case 1:return"weibo";case 2:return"qq";case 3:return"wechat";default:return""}};return third_type()?void CommonProvider.promise({model:AuthModel,method:"thirdBind",params:{type:third_type(),body:{open_id:$scope.thirdLoginInfo.open_id,randomstr:$scope.thirdLoginInfo.randomstr}},success:function(account){delete $localStorage.thirdLoginInfo,config.bind&&$modal.success({message:account.message,callback:$scope.getThirdAccounts}),config.bind||(config.modal&&(AuthProvider.init(),$modal.closeCallback()),config.modal||$location.path($rootScope.redirect||"user/index"))},error:function(account){config.modal&&console.log(account.message),config.modal||$modal.error({message:account.message})}}):!1},$scope.thirdUnbind=function(account){$modal.confirm({title:"请确认操作",message:"您确定要解除与"+account.type_name+"用户“"+account.name+"”的绑定吗？",button:{confirm:"确定",cancel:"取消"},onsubmit:function(){CommonProvider.promise({model:AuthModel,method:"thirdUnbind",params:{id:account.id},success:function(account){$modal.success({message:account.message}),$scope.getThirdAccounts()},error:function(){$modal.error({message:account.message})}})}})}}]),angular.module("CourseController",["angular.bootstrap.rating","CategoryModel","CourseModel","SectionModel","CommentModel","FavoriteModel","SearchModel"]).controller("CourseController",["$rootScope","$scope","$state","$stateParams","$location","$http","$localStorage","$window","$timeout","$interval","$modal","$filter","$sce","CommonProvider","CategoryModel","CourseModel","SectionModel","CommentModel","FavoriteModel","SearchModel",function($rootScope,$scope,$state,$stateParams,$location,$http,$localStorage,$window,$timeout,$interval,$modal,$filter,$sce,CommonProvider,CategoryModel,CourseModel,SectionModel,CommentModel,FavoriteModel,SearchModel){$scope.filter={sort_id:0,is_live:0},$scope.course_id=$stateParams.course_id||!1,$scope.category_id=$stateParams.category_id||"0",$scope.course={},$scope.course.relation=!1,$scope.sections={},$scope.sections.all=[],$scope.sections.free=[],$scope.sections.live=[],$scope.sections.current=0,$scope.sections.current_free=0,$scope.sections.last={},$scope.course.btn={primary:{text:"立即购买",show:!0},secondary:{text:"免费试听",show:!0,type:"audition"}},$scope.getCateList=function(){CommonProvider.promise({model:CategoryModel,method:"childrens",params:{category_id:$scope.category_id},success:function(categories){categories.result.children.length?($scope.categories=categories.result,$rootScope.categories=categories.result):$scope.categories=$rootScope.categories}})},$scope.getCourseList=function(page){if($rootScope.toTop(),$stateParams.key)return $scope.getSearchList(page),!1;var get_params={role:"student",category_id:$scope.category_id,sort_id:$scope.filter.sort_id||0,page:page||1,per_page:12};1==$scope.filter.is_live&&(get_params.is_live=1),CommonProvider.promise({model:CourseModel,method:"get",params:get_params,success:function(courses){$scope.courses=courses}})},$scope.getSearchList=function(page){$scope.keyword=$stateParams.key;var get_params={keyword:$stateParams.key,detail:1,only_name:1,search_type:"course",sort_id:$scope.filter.sort_id||0,page:page||1,per_page:12};1==$scope.filter.is_live&&(get_params.is_live=1),CommonProvider.promise({model:SearchModel,method:"get",params:get_params,success:function(courses){$scope.courses=courses}})},$scope.getListInit=function(){$scope.getCateList(),$scope.getCourseList()},$scope.sortChanged=function(sort_id){$scope.filter.sort_id=sort_id,$scope.getCourseList()},$scope.isLiveChanged=function(is_live){$scope.filter.is_live=Number(is_live),$scope.getCourseList()},$scope.getBasicInfo=function(){CommonProvider.promise({model:CourseModel,method:"item",params:{course_id:$scope.course_id},success:function(course){$scope.course.info=course.result,$rootScope.title=$scope.course.info.name,$rootScope.description=$scope.course.info.description,$rootScope.setDomPosition(angular.element("#detailTab div").scope()),$localStorage.categories&&($scope.categories=$localStorage.categories)},result:function(result){404==result.status&&$modal.error({message:"课程不存在",callback:function(){$location.path("course")}})}})},$scope.getSections=function(){CommonProvider.promise({model:SectionModel,method:"get",params:{course_id:$scope.course_id},success:function(chapters){$scope.course.chapters=chapters.result}})},$scope.getComments=function(params){CommonProvider.promise({model:CommentModel,method:"get",params:{course_id:$scope.course_id,per_page:10,page:params?params.page||1:1},success:function(comments){$scope.course.comments=comments}})},$scope.getRelated=function(page){CommonProvider.promise({model:CourseModel,method:"others",params:{page:page||1,per_page:8,course_id:$scope.course_id},success:function(related){$scope.course.related=related}})},$scope.refreshRelated=function(){if(!$scope.course.related)return!1;var pagination=$scope.course.related.pagination;return pagination.total>pagination.per_page&&(pagination.current_page<pagination.total_page?$scope.getRelated(pagination.current_page+1):pagination.current_page==pagination.total_page&&1!=pagination.current_page&&$scope.getRelated(1)),!1},$scope.getClassmates=function(page){CommonProvider.promise({model:CourseModel,method:"classmates",params:{course_id:$scope.course_id,page:page||1,per_page:12},success:function(classmates){$scope.course.classmates=classmates}})},$scope.refreshClassmates=function(){if(!$scope.course.classmates)return!1;var pagination=$scope.course.classmates.pagination;return pagination.total>pagination.per_page&&(pagination.current_page<pagination.total_page?$scope.getClassmates(pagination.current_page+1):pagination.current_page==pagination.total_page&&1!=pagination.current_page&&$scope.getClassmates(1)),!1},$scope.checkBtnStatus=function(){$scope.course.relation&&($scope.course.relation.author?($scope.course.btn.primary.text="课程预览",$scope.course.btn.secondary.show=!1):($scope.course.info&&!$scope.course.info.rel_price&&($scope.course.btn.primary.text="立即学习",$scope.course.btn.secondary.show=!1),-1==$scope.course.relation.trade_status&&($scope.course.btn.primary.text="立即购买",$scope.course.btn.secondary.text="免费试听",$scope.course.btn.secondary.type="audition"),0==$scope.course.relation.trade_status&&($scope.course.btn.secondary.text="继续试听",$scope.course.btn.secondary.type="audition"),1==$scope.course.relation.trade_status&&($scope.course.btn.primary.text="立即付款",$scope.course.btn.secondary.text="继续试听",$scope.course.btn.secondary.type="audition"),2==$scope.course.relation.trade_status&&($scope.course.relation.last_study_section_id?$scope.course.btn.primary.text="继续学习":$scope.course.btn.primary.text="开始学习",$scope.course.btn.secondary.text="立即评价",$scope.course.btn.secondary.show=!0,$scope.course.btn.secondary.type="evaluate"),3==$scope.course.relation.trade_status&&($scope.course.btn.primary.text="再次学习",$scope.course.btn.secondary.show=!1)))},$scope.getRelation=function(callback){return $localStorage.token?void CommonProvider.promise({model:CourseModel,method:"relation",params:$scope.course_id,success:function(relation){$scope.course.relation=relation.result,$scope.checkBtnStatus(),callback&&"function"==typeof callback&&callback()}}):!1},$scope.getDetail=function(){$scope.getBasicInfo(),$scope.getSections(),$scope.getComments(),$scope.getRelated(),$scope.getClassmates(),$scope.getRelation()},$scope.loginGetRelation=function(callback){$rootScope.modal.login(function(){callback?$scope.getRelation(function(){callback()}):$scope.getRelation()})},$scope.pushSections=function(section){$scope.sections.last=section,$scope.sections.all.push(section),section.is_free&&$scope.sections.free.push(section),section.is_live&&$scope.sections.live.push(section),section.id&&$scope.section_id&&section.id==$scope.section_id&&($scope.sections.current=$scope.sections.all.length-1,$scope.sections.free.length&&($scope.sections.current_free=$scope.sections.free.length-1)),$scope.sections.free.length||($scope.course.btn.secondary.show=!1)},$scope.addExperience=function(section_id){var section_id=section_id||$scope.sections.free[0].id;CommonProvider.promise({model:CourseModel,method:"operation",params:{method:"experience",course_id:$scope.course_id},success:function(){$location.path("/course/"+$scope.course_id+"/learn/"+section_id)}})},$scope.buy=function(params){if(!$scope.course.chapters.length||!$scope.course.chapters[0].children)return $modal.warning({message:"没有有效章节，无法购买"});if(!$scope.course.chapters[0].children.length)return $modal.warning({message:"没有有效章节，无法购买"});var section_id=params.section_id||$scope.course.chapters[0].children[0].id,course_id=params.course_id||$scope.course_id;CommonProvider.promise({model:CourseModel,method:"operation",params:{method:"buy",course_id:course_id},success:function(buy){params.is_free?$location.path("/course/"+course_id+"/learn/"+section_id):$location.path("/payment/"+course_id)},error:function(buy){$modal.error({message:buy.message})}})},$scope.primaryBtnEvent=function(){if($scope.course.relation)if($scope.course.relation.author)$scope.sections.all.length?$location.path("/course/"+$scope.course_id+"/learn/"+$scope.sections.all[0].id):$modal.error({message:"没有有效章节"});else switch($scope.course.relation.trade_status){case 0:case-1:$scope.buy({course_id:$scope.course_id,is_free:!$scope.course.info.rel_price});break;case 1:$location.path("/payment/"+$scope.course_id);break;case 2:$scope.course.relation.last_study_section_id?$location.path("/course/"+$scope.course_id+"/learn/"+$scope.course.relation.last_study_section_id):$location.path("/course/"+$scope.course_id+"/learn/"+$scope.sections.all[0].id);break;case 3:$scope.sections.all.length?$location.path("/course/"+$scope.course_id+"/learn/"+$scope.sections.all[0].id):$modal.error({message:"没有有效章节"});break;default:console.log("执行弹窗登录")}else $scope.loginGetRelation(function(){$scope.primaryBtnEvent()})},$scope.secondaryBtnEvent=function(){if($scope.course.relation)if("audition"==$scope.course.btn.secondary.type){if($scope.sections.free.length){if($scope.course.relation.trade_status<0)return void $scope.addExperience();$location.path("/course/"+$scope.course_id+"/learn/"+$scope.course.relation.last_study_section_id||$scope.sections.free[0].id)}}else $rootScope.goTo("detailTab"),$rootScope.setTabActive(angular.element("#detailTab ul").scope(),3);else $scope.loginGetRelation(function(){$scope.secondaryBtnEvent()})},$scope.sectionClickEvent=function(section){if($scope.course.relation){if($scope.course.relation.author||2==$scope.course.relation.trade_status||3==$scope.course.relation.trade_status)return $location.path("/course/"+$scope.course_id+"/learn/"+section.id),!1;if(section.is_free)return void($scope.course.relation.trade_status<0?$scope.addExperience(section.id):$location.path("/course/"+$scope.course_id+"/learn/"+section.id));if($scope.course.relation.trade_status<1)return $scope.buy({course_id:$scope.course_id,is_free:!$scope.course.info.rel_price,section_id:section.id}),!1;1==$scope.course.relation.trade_status&&$location.path("/payment/"+$scope.course_id)}else $scope.loginGetRelation(function(){$scope.sectionClickEvent(section)})},$scope.addFav=function(course_id){var course_id=course_id||$scope.course.info.id,doAddFav=function(){return $scope.course.relation.follow?!1:void CommonProvider.promise({model:FavoriteModel,method:"add",params:{type:"course",target_id:course_id},success:function(fav){$scope.course.relation.follow=!0,$scope.course.info.follow_count+=1},error:function(fav){$modal.error({message:fav.message})}})};$rootScope.user?doAddFav():$scope.loginGetRelation(function(){$scope.addFav()})},$scope.postComment=function(comment){CommonProvider.promise({model:CommentModel,method:"post",params:{role:"student",body:{course_id:$scope.course_id,content:comment.content,description_score:comment.score.description,quality_score:comment.score.quality,satisfaction_score:comment.score.satisfaction}},success:function(_comment){comment.content=null,_comment.result.user={},_comment.result.user.id=$rootScope.user.id,_comment.result.user.name=$rootScope.user.name,_comment.result.user.gravatar=$rootScope.user.gravatar,$scope.course.comments.result.unshift(_comment.result),$scope.course.comments.pagination.total+=1,$scope.course.relation.trade_status=3},error:function(_comment){$modal.error({message:_comment.message})}})}}]),angular.module("LearnController",["angular.bootstrap.rating","angular-video-player","angular-chat","angular-related-select","CategoryModel","CourseModel","SectionModel","CommentModel","FavoriteModel","NoteModel","QuestionModel","SearchModel"]).controller("LearnController",["$rootScope","$scope","$state","$stateParams","$location","$http","$localStorage","$window","$timeout","$interval","$modal","$filter","$sce","CommonProvider","CategoryModel","CourseModel","SectionModel","CommentModel","FavoriteModel","NoteModel","QuestionModel","SearchModel",function($rootScope,$scope,$state,$stateParams,$location,$http,$localStorage,$window,$timeout,$interval,$modal,$filter,$sce,CommonProvider,CategoryModel,CourseModel,SectionModel,CommentModel,FavoriteModel,NoteModel,QuestionModel,SearchModel){$scope.course_id=$stateParams.course_id||!1,$scope.section_id=$stateParams.section_id||!1,$scope.player={},$scope.course={},$scope.course.info={},$scope.course.relation=!1,$scope.section={},$scope.sections={},$scope.sections.all=[],$scope.sections.free=[],$scope.sections.current=0,$scope.sections.current_free=0,$scope.sections.last={},$scope.section.player={},$scope.section.player.ended=!1,$scope.section.player.mask={show:!1,refresh:!1,title:"",btn:{show:!1,text:"下一节",style:1,click:function(){}}},$scope.getBasicInfo=function(){CommonProvider.promise({model:CourseModel,method:"item",params:{course_id:$scope.course_id},success:function(course){$scope.course.info=course.result,$rootScope.title=$scope.course.info.name,$rootScope.description=$scope.course.info.description,$rootScope.setDomPosition(angular.element("#detailTab div").scope()),$localStorage.categories&&($scope.categories=$localStorage.categories)},result:function(result){404==result.status&&$modal.error({message:"课程不存在",callback:function(){$location.path("course")}})}})},$scope.getSections=function(){CommonProvider.promise({model:SectionModel,method:"get",params:{course_id:$scope.course_id},success:function(chapters){$scope.course.chapters=chapters.result}})},$scope.getComments=function(params){CommonProvider.promise({model:CommentModel,method:"get",params:{course_id:$scope.course_id,per_page:10,page:params?params.page||1:1},success:function(comments){$scope.course.comments=comments}})},$scope.getClassmates=function(page){CommonProvider.promise({model:CourseModel,method:"classmates",params:{course_id:$scope.course_id,page:page||1,per_page:12},success:function(classmates){$scope.course.classmates=classmates}})},$scope.initLiveRoomUsers=function(){$scope.$on("chatRoomUserChanged",function(event,uids){var nowLiveUserIds=uids;$scope.course.info.teacher=$scope.course.info.teacher||{};var teacher_id=$scope.course.info.teacher.id||!1;teacher_id&&nowLiveUserIds.remove(teacher_id),CommonProvider.promise({model:CourseModel,method:"getUsersInfo",params:{user_ids:nowLiveUserIds},success:function(live_users){$scope.course.live_users=live_users.result}})})},$scope.refreshClassmates=function(){if(!$scope.course.classmates)return!1;var pagination=$scope.course.classmates.pagination;return pagination.total>pagination.per_page&&(pagination.current_page<pagination.total_page?$scope.getClassmates(pagination.current_page+1):pagination.current_page==pagination.total_page&&1!=pagination.current_page&&$scope.getClassmates(1)),!1},$scope.getRelation=function(callback){return $localStorage.token?void CommonProvider.promise({model:CourseModel,method:"relation",params:$scope.course_id,success:function(relation){$scope.course.relation=relation.result,callback&&"function"==typeof callback&&callback()}}):!1},$scope.loginGetRelation=function(callback){$rootScope.modal.login(function(){callback?$scope.getRelation(function(){callback()}):$scope.getRelation()})},$scope.pushSections=function(section){$scope.sections.last=section,$scope.sections.all.push(section),section.is_free&&$scope.sections.free.push(section),section.id&&$scope.section_id&&section.id==$scope.section_id&&($scope.sections.current=$scope.sections.all.length-1,$scope.sections.free.length&&($scope.sections.current_free=$scope.sections.free.length-1))},$scope.buy=function(params){if(!$scope.course.chapters.length||!$scope.course.chapters[0].children)return $modal.warning({message:"没有有效章节，无法购买"});if(!$scope.course.chapters[0].children.length)return $modal.warning({message:"没有有效章节，无法购买"});var section_id=params.section_id||$scope.course.chapters[0].children[0].id,course_id=params.course_id||$scope.course_id;CommonProvider.promise({model:CourseModel,method:"operation",params:{method:"buy",course_id:course_id},success:function(buy){params.is_free?$location.path("/course/"+course_id+"/learn/"+section_id):$location.path("/payment/"+course_id)},error:function(buy){$modal.error({message:buy.message})}})},$scope.addFav=function(course_id){var course_id=course_id||$scope.course.info.id,doAddFav=function(){return $scope.course.relation.follow?!1:void CommonProvider.promise({model:FavoriteModel,method:"add",params:{type:"course",target_id:course_id},success:function(fav){$scope.course.relation.follow=!0,$scope.course.info.follow_count+=1},error:function(fav){$modal.error({message:fav.message})}})};$rootScope.user?doAddFav():$scope.loginGetRelation(function(){$scope.addFav()})},$scope.postStudyRecord=function(){$scope.section.player.current&&CommonProvider.promise({model:SectionModel,method:"postStudyRecord",params:{section_id:$scope.section_id,record_time:$scope.section.player.current}})},$scope.getSectionNotes=function(params){CommonProvider.promise({model:NoteModel,method:"get",params:{role:"student",section_id:$scope.section_id,per_page:10,page:params?params.page||1:1},success:function(notes){$scope.section.notes=notes}})},$scope.getSectionQuestions=function(params){CommonProvider.promise({model:QuestionModel,method:"get",params:{role:"student",section_id:$scope.section_id,per_page:10,page:params?params.page||1:1},success:function(questions){$scope.section.questions=questions}})},$scope.getSectionInfo=function(){CommonProvider.promise({model:SectionModel,method:"item",params:{role:"student",section_id:$scope.section_id},success:function(section){$scope.section.info=section.result}}),$scope.getSectionNotes(),$scope.getSectionQuestions()},$scope.postComment=function(comment){CommonProvider.promise({model:CommentModel,method:"post",params:{role:"student",body:{course_id:$scope.course_id,content:comment.content,description_score:comment.score.description,quality_score:comment.score.quality,satisfaction_score:comment.score.satisfaction}},success:function(_comment){comment.content=null,_comment.result.user={},_comment.result.user.id=$rootScope.user.id,_comment.result.user.name=$rootScope.user.name,_comment.result.user.gravatar=$rootScope.user.gravatar,$scope.course.comments.result.unshift(_comment.result),$scope.course.comments.pagination.total+=1,$scope.course.relation.trade_status=3},error:function(_comment){$modal.error({message:_comment.message})}})},$scope.postQuestion=function(question){CommonProvider.promise({model:QuestionModel,method:"post",params:{section_id:Number($scope.section_id),content:question.content,pid:0},success:function(_question){question.content=null,_question.result.user={},_question.result.user.id=$rootScope.user.id,_question.result.user.gravatar=$rootScope.user.gravatar,_question.result.user.name=$rootScope.user.name,$scope.section.questions.result.unshift(_question.result),$scope.section.questions.pagination.total+=1},error:function(_question){$modal.error({message:_question.message})}})},$scope.replyQuestion=function(params){params.modal?($rootScope.questions=$scope.section.questions,$rootScope.reply_question=params.question,$modal.custom({title:"添加回答",template_url:"/partials/home/user/question/reply-question.html",callback:function(){$rootScope.questions=null,delete $rootScope.reply_question}})):CommonProvider.promise({model:QuestionModel,method:"post",params:{section_id:Number($scope.section_id),content:params.content,pid:$rootScope.reply_question.id,to_user_id:$rootScope.reply_question.user.id},success:function(_answer){_answer.result.user={},_answer.result.user.id=$rootScope.user.id,_answer.result.user.gravatar=$rootScope.user.gravatar,_answer.result.user.name=$rootScope.user.name;var replys=$rootScope.questions.result.find($rootScope.reply_question);replys.children=replys.children||[],replys.children.unshift(_answer.result),
$rootScope.modal.close(),$modal.success({message:"回复成功"})},error:function(_answer){$modal.error({message:_answer.message})}})},$scope.postNote=function(note){CommonProvider.promise({model:NoteModel,method:"post",params:{section_id:$scope.section_id,content:note.content,is_publish:Number(note.publish),is_capture:Number(note.capture),key:"c"+$scope.course_id+"s"+$scope.section_id,record_time:$scope.section.player.current},success:function(_note){_note=_note.result,_note.capture_url=null,_note.user={},_note.user.gravatar=$rootScope.user.gravatar,_note.user.name=$rootScope.user.name,_note.user.id=$rootScope.user.id,_note.section=$scope.section.info,$scope.section.notes.result.unshift(_note),$scope.section.notes.pagination.total+=1,note.content=null},error:function(_note){$modal.error({message:_note.message})}})},$scope.addFavNote=function(note){var doAddFav=function(){CommonProvider.promise({model:FavoriteModel,method:"add",params:{type:"note",target_id:note.id},success:function(fav){note.followed=!0},error:function(fav){$modal.error({message:fav.message})}})};$rootScope.user?doAddFav():$scope.loginGetRelation(function(){doAddFav()})},$scope.postDataFocus=function(){$rootScope.goTo("player-container"),!$scope.section.player.ended&&$scope.playerPause&&$scope.playerPause()},$scope.playEndedCheck=function(params){var params=params||{},click=params.click||!1,playback=params.playback||!1;if($scope.section.player.mask.show=!0,$scope.section.player.mask.refresh=!0,$scope.section.player.mask.btn.show=!0,$scope.section.player.mask.btn.click=function(){$scope.playEndedCheck({click:!0})},$scope.course.relation.trade_status&&$scope.course.relation.trade_status<2)if($scope.sections.free[$scope.sections.current_free+1]){var next_section=$scope.sections.free[$scope.sections.current_free+1];click?$location.path("/course/"+$scope.course_id+"/learn/"+next_section.id):($scope.section.player.mask.title="下一节课程："+next_section.name+"（"+$filter("toHHMMSS")(next_section.duration,"MMSS")+"）",$scope.section.player.mask.btn.text="试听下一节",$scope.section.player.mask.btn.style=1)}else $scope.course.relation.trade_status<=0?click?$scope.buy($scope.course_id,!$scope.course.info.rel_price):($scope.section.player.mask.title="本课程免费章节已试听完毕，如需学习更多章节，请您购买本课程",$scope.section.player.mask.btn.text="购买课程",$scope.section.player.mask.btn.style=2):1==$scope.course.relation.trade_status&&(click?$location.path("/payment/"+$scope.course_id):($scope.section.player.mask.title="本课程免费章节已试听完毕，如需学习更多章节，请您付款",$scope.section.player.mask.btn.text="立即付款",$scope.section.player.mask.btn.style=2));else{var next_section=$scope.sections.all[$scope.sections.current+1];next_section?click?$location.path("/course/"+$scope.course_id+"/learn/"+next_section.id):(playback&&($scope.section.player.mask.title="回放已结束，下一节课程："+next_section.name+"（"+$filter("toHHMMSS")(next_section.duration,"MMSS")+"）"),playback||($scope.section.player.mask.title="下一节课程："+next_section.name+"（"+$filter("toHHMMSS")(next_section.duration,"MMSS")+"）"),$scope.section.player.mask.btn.text="下一节",$scope.section.player.mask.btn.style=1):2==$scope.course.relation.trade_status?click?($rootScope.goTo("player-container"),$rootScope.setTabActive(angular.element("#J_learn_tab ul").scope(),3)):($scope.section.player.mask.title="恭喜您，已完成本章课程的学习！快去评价一下吧~",$scope.section.player.mask.btn.text="评价课程",$scope.section.player.mask.btn.style=1):3==$scope.course.relation.trade_status&&(click?$location.path("/course/"+$scope.course_id):($scope.section.player.mask.title="恭喜您，已完成本章课程的学习！",$scope.section.player.mask.btn.text="返回课程",$scope.section.player.mask.btn.style=1))}params.callback&&params.callback()},$scope.checkNextSection=function(params){var params=params||{},click=params.click||!1,title=params.title||!1;$scope.section.player.mask.btn.show=!0,$scope.section.player.mask.btn.click=function(){$scope.checkNextSection({click:!0})};var next_section=$scope.sections.all[$scope.sections.current+1];next_section?click?$location.path("/course/"+$scope.course_id+"/learn/"+next_section.id):(title&&(playback&&($scope.section.player.mask.title="回放已结束，下一节课程："+next_section.name+"（"+$filter("toHHMMSS")(next_section.duration,"MMSS")+"）"),playback||($scope.section.player.mask.title="下一节课程："+next_section.name+"（"+$filter("toHHMMSS")(next_section.duration,"MMSS")+"）")),$scope.section.player.mask.btn.text="下一节",$scope.section.player.mask.btn.style=1):2==$scope.course.relation.trade_status?click?($rootScope.goTo("player-container"),$rootScope.setTabActive(angular.element("#J_learn_tab ul").scope(),3)):(title&&($scope.section.player.mask.title="恭喜您，已完成本章课程的学习！快去评价一下吧~"),$scope.section.player.mask.btn.text="评价课程",$scope.section.player.mask.btn.style=1):3!=$scope.course.relation.trade_status&&$scope.course.relation||(click?$location.path("/course/"+$scope.course_id):(title&&($scope.section.player.mask.title="恭喜您，已完成本章课程的学习！"),$scope.section.player.mask.btn.text="返回课程",$scope.section.player.mask.btn.style=1))},$scope.initVideoAndChat=function(){$scope.section.player.mask.show=!0,$scope.section.player.mask.refresh=!1,$scope.section.player.mask.title="课程资源加载中...",$scope.section.player.mask.btn.show=!1,$scope.course_id&&$scope.section_id&&CommonProvider.promise({model:SectionModel,method:"getVideos",params:{section_id:$scope.section_id,role:"student"},success:function(video){$scope.section.player.mask.show=!1,$scope.section.player.mask.refresh=!1;var video=video.result,player={};if(player.modal=0,player.urls=video.urls,player.is_live=video.is_live,player.live_status=video.live_status,player.is_live)switch(player.live_status){case 0:case 1:case 10:case 11:case 12:player.live_at=video.live_at,$scope.section.player.mask.show=!0,$scope.section.player.mask.title="本节课程直播将在 "+player.live_at+" 开始，请等待~",$scope.checkNextSection({title:!1});break;case 2:player.room_id=video.room_id,$scope.player=player;break;case 3:case 4:$scope.section.player.mask.show=!0,$scope.section.player.mask.title="直播已结束，暂无有效回放资源",$scope.checkNextSection({title:!1});break;case 5:$scope.section.player.mask.show=!1,player.room_id=0}if(!player.is_live||player.is_live&&5==player.live_status){$scope.section.player.current=null!=video.record?video.record.record_time:0,$localStorage.play_record=$localStorage.play_record||{},$localStorage.play_record[$rootScope.user.id]=$localStorage.play_record[$rootScope.user.id]||{};var playerStartTime=function(){return $stateParams.record_time?$stateParams.record_time:$localStorage.play_record[$rootScope.user.id][$scope.section.info.id]?$localStorage.play_record[$rootScope.user.id][$scope.section.info.id]==Number($scope.section.info.duration).toFixed(0)?0:$localStorage.play_record[$rootScope.user.id][$scope.section.info.id]:null!=video.record&&video.record.record_time!=Number($scope.section.info.duration).toFixed(0)?video.record.record_time:0};player.start=playerStartTime(),$scope.player=player,$scope.$on("videoPlayerTimeUpdate",function(event,current_time){return current_time?$scope.section.player.current==Number(Math.floor(current_time))?!1:($scope.section.player.current=Number(Math.floor(current_time)),void($localStorage.play_record[$rootScope.user.id][$scope.section.info.id]=Number(Math.floor(current_time)))):!1}),$scope.$on("videoPlayerPlaying",function(event,playing){$scope.$apply(function(){$scope.section.player.mask.show=!1})}),$scope.$on("videoPlayerPause",function(event,pause){$scope.postStudyRecord()}),$scope.$on("videoPlayerEnded",function(event,ended){$scope.postStudyRecord();var playback=!!player.is_live;$scope.playEndedCheck({playback:playback})}),$scope.$on("videoPlayerLoadeddata",function(event,preload){$scope.section.player.mask.show=!1}),$scope.$on("videoPlayerResolution",function(event,new_src){}),$scope.playerPause=function(){$scope.$broadcast("doVideoPlayerPause",!0)},$scope.playerPlay=function(){$scope.$broadcast("doVideoPlayerPlay",!0)},$scope.playerRefreshPlay=function(){$scope.$broadcast("doVideoPlayerRefreshPlay",!0)}}},error:function(video){if(600!=video.code||$scope.course.relation.author)$scope.section.player.mask.show=!0,$scope.section.player.mask.title=video.message,$scope.checkNextSection({title:!1});else{var trade_status=$scope.course.relation.trade_status;$modal.confirm({title:1>trade_status?"本课程需要购买":"本课程尚未付款",message:"无法播放付费课程，请前往"+(1>trade_status?"购买":"付款"),info:1>trade_status?"是否购买本课程？":"是否付款本课程？",button:{confirm:1>trade_status?"立即购买":"立即付款",cancel:1>trade_status?"暂不购买":"暂不付款"},onsubmit:function(){1>trade_status&&$scope.buy($scope.course_id,!$scope.course.info.rel_price),1==trade_status&&$location.path("/payment/"+$scope.course_id)},oncancel:function(){$location.path("/course/"+$scope.course_id)},callback:function(){$location.path("/course/"+$scope.course_id)}})}}})},$scope.initLearn=function(){return $localStorage.token?($rootScope.navBarHide=!0,$rootScope.learnActive=!0,$scope.getBasicInfo(),$scope.getSections(),$scope.getComments(),$scope.getClassmates(),$scope.getRelation(),$scope.getSectionInfo(),$scope.$on("$locationChangeStart",function(){$scope.postStudyRecord(),$rootScope.navBarHide=!1,$rootScope.learnActive=!1}),$window.onbeforeunload=function(){$scope.postStudyRecord()},void $scope.initVideoAndChat()):($modal.warning({message:"请先登录",callback:function(){$location.path("auth/login")}}),!1)},$scope.$watch("course.relation.trade_status",function(){})}]),angular.module("PaymentController",["PaymentModel"]).controller("PaymentController",["$rootScope","$scope","$stateParams","$state","$window","$location","$localStorage","$interval","$timeout","$modal","CommonProvider","PaymentModel","CommonModel",function($rootScope,$scope,$stateParams,$state,$window,$location,$localStorage,$interval,$timeout,$modal,CommonProvider,PaymentModel,CommonModel){$scope.course_ids=$stateParams.course_ids,$scope.course_id=parseInt($stateParams.course_ids),$scope.banks={ICBC:{name:"中国工商银行",value:"ICBCB2C"},CCB:{name:"中国建设银行",value:"CCB"},ABC:{name:"中国农业银行",value:"ABC"},CMB:{name:"招商银行",value:"CMB"},BOC:{name:"中国银行",value:"BO"},COMM:{name:"交通银行",value:"COMM"},PSBC:{name:"中国邮政储蓄银行",value:"PSBC-DEBIT"},GDB:{name:"广发银行",value:"GDB"},SPDB:{name:"浦发银行",value:"SPDB"},SPABANK:{name:"平安银行",value:"SPABANK"},CIB:{name:"兴业银行",value:"CIB"},CMBC:{name:"中国民生银行",value:"CMBC"},SHBANK:{name:"上海银行",value:"SHBANK"},BJRCB:{name:"北京农商银行",value:"BJRCB"},HZCB:{name:"杭州银行",value:"HZCBB2C"}},$scope.show_bankbox=!1,$scope.total_amount=0,$scope.account_remain=0,$scope.is_remain_avariable=!1,$scope.payment_model={is_use_remain:!1,is_use_thirdparty:!1,thirdparty_disabled:!1,warning_slug:!1,verify_status:!1,payment_id:"",payment_type:"",bank_code:"",payment_success:!1,payment_warning:!1},$scope.verifyCodeCheck=function(value){$scope.payment_verify_code=null==value?"":value.replace(/\W/g,"")},$scope.paymentSuccess=function(){$rootScope.modal.close(),$scope.payment_model.payment_success=!0,$scope.path_seconds=3,$interval(function(){$scope.path_seconds-=1,0==$scope.path_seconds&&$location.path("/user/course")},1e3,$scope.path_seconds)},$scope.getPrepay=function(){CommonProvider.promise({model:PaymentModel,method:"pay",params:{course_ids:$scope.course_ids},result:function(prepay){1==prepay.code&&($scope.trades=prepay.result.trades,$scope.total_amount=prepay.result.total_amount,$scope.account_remain=prepay.result.account_remain,$scope.payment_model.payment_id=prepay.result.payment_id,$scope.is_remain_avariable=!($scope.account_remain<=0),$scope.paymentCheck()),2==prepay.code&&$scope.paymentSuccess(),0==prepay.code&&$modal.error({message:prepay.message,lazytime:1,callback:function(){$location.path("/user/course")}})}})},$scope.paymentChange=function(){$scope.account_remain>=$scope.total_amount&&($scope.payment_model.is_use_remain?($scope.payment_model.is_use_thirdparty=!1,$scope.payment_model.thirdparty_disabled=!0):$scope.payment_model.thirdparty_disabled=!1),0==$scope.payment_model.is_use_thirdparty&&($scope.payment_model.bank_code="")},$scope.paymentCheck=function(){$scope.is_remain_avariable?($scope.payment_model.is_use_remain=!0,$scope.account_remain>=$scope.total_amount?($scope.payment_model.is_use_thirdparty=!1,$scope.payment_model.thirdparty_disabled=!0):$scope.payment_model.is_use_thirdparty=!0):($scope.payment_model.is_use_remain=!1,$scope.payment_model.is_use_thirdparty=!0)},$scope.getVerifyCode=function(phone){return $scope.payment_model.verify_status?!1:void CommonProvider.promise({model:CommonModel,method:"sms",params:{rule:"check_mobile_exists",phone:phone},success:function(sms){$scope.payment_model.verify_status=!0},error:function(){$scope.payment_model.verify_status=!0}})},$scope.getPaymentStatus=function(){return"payment"!=$state.current.name?!1:void CommonProvider.promise({model:PaymentModel,method:"getPayStatus",params:{payment_id:$scope.payment_model.payment_id},success:function(pay){var is_pay_success=1==pay.result.pay_status,is_pay_failed=-1==pay.result.pay_status,is_use_wx_pay="wxpay"==$scope.payment_model.payment_type;is_pay_success&&$scope.paymentSuccess(),is_pay_success||(is_use_wx_pay&&is_pay_failed&&($rootScope.modal.close(),$scope.getPrepay(),$modal.error({message:"支付失败，请重新支付"})),is_use_wx_pay&&!is_pay_failed&&$timeout($scope.getPaymentStatus,1500),is_use_wx_pay||$modal.error({message:"支付失败，请重新支付"}))},error:function(pay){return $modal.error({message:pay.message}),!1}})},$scope.submitPayment=function(){if($scope.payment_model.payment_warning=!1,!$scope.payment_model.is_use_thirdparty&&!$scope.payment_model.is_use_remain)return $scope.paymentCheck(),!1;if($scope.payment_model.is_use_thirdparty){if(""==$scope.payment_model.bank_code)return $rootScope.goTo("payment_thirdparty"),$scope.payment_model.warning_slug=!0,!1}else if($scope.payment_model.is_use_remain&&!$scope.payment_model.is_use_thirdparty){if($scope.account_remain<$scope.total_amount)return $scope.payment_model.is_use_thirdparty=!0,!1;if(!$scope.payment_model.verify_status)return $scope.getVerifyCode($rootScope.user.phone),!1;if(!$scope.payment_verify_code)return $scope.payment_verify_code_status=1,!1}"ALIPAY"==$scope.payment_model.bank_code?$scope.payment_model.payment_type="alipay":"WECHAT"==$scope.payment_model.bank_code?$scope.payment_model.payment_type="wxpay":$scope.payment_model.payment_type="bankpay";var payment_config={payment_type:this.payment_model.payment_type,bank_code:this.payment_model.bank_code,use_remain:1==this.payment_model.is_use_remain?1:0,use_thirdparty:1==this.payment_model.is_use_thirdparty?1:0,code:$scope.payment_verify_code};if($scope.payment_model.is_use_thirdparty&&"wxpay"!=$scope.payment_model.payment_type)var pay_window=window.open("","_blank");"wxpay"==$scope.payment_model.payment_type&&$modal.warning({title:"正在请求支付接口",message:"正在生成支付二维码，请勿刷新"}),CommonProvider.promise({model:PaymentModel,method:"payment",params:{body:payment_config,payment_id:this.payment_model.payment_id},result:function(pay){1==pay.code?$scope.payment_model.is_use_thirdparty&&"wxpay"!=$scope.payment_model.payment_type?(pay_window.location=pay.result,$modal.confirm({title:"请您在新打开的页面上完成付款",message:"付款完成前请不要关闭此窗口",button:{confirm:"付款成功",cancel:"遇到问题"},onsubmit:$scope.getPaymentStatus,oncancel:function(){$scope.payment_model.payment_warning=!0,$rootScope.goTo("payment")}})):"wxpay"==$scope.payment_model.payment_type?($rootScope.modal.close(),$modal.custom({title:"扫描二维码支付本课程",template:'<div><div class="col-xs-12"><div class="col-xs-offset-3 col-xs-6"><p class="text-center"><img class="img-thumbnail" src="/server/api/v1/qrcode?text='+pay.result.code_url+'"></p></div></div><div class="col-xs-12"><div class="col-xs-offset-3 col-xs-6"><p class="text-center"><img class="img-rounded" src="images/pay/PAY_WX_ PROMPT.png"></p></div></div></div>'}),$timeout($scope.getPaymentStatus,4e3)):$scope.paymentSuccess():$modal.error({message:pay.message})},error:function(err){$scope.payment_verify_code_status=2}})}}]),angular.module("OrganizationlController",["OrganizationModel","CourseModel","CategoryModel","SearchModel","StudentModel","AnnouncementModel","AuditModel"]).controller("OrganizationlController",["$rootScope","$scope","$stateParams","$location","$modal","CommonProvider","OrganizationModel","CourseModel","CategoryModel","SearchModel","StudentModel","AnnouncementModel","AuditModel",function($rootScope,$scope,$stateParams,$location,$modal,CommonProvider,OrganizationModel,CourseModel,CategoryModel,SearchModel,StudentModel,AnnouncementModel,AuditModel){$scope.organization_id=$stateParams.organization_id||!1,$scope.teacher_id=$stateParams.teacher_id||!1,$scope.teacher={},$scope.categorys={},$scope.organization={},$scope.organizations={},$scope.currrent_category={},$scope.organization.courses={},$scope.organization.courses.sort_id=0,$scope.organization.courses.is_live=0,$scope.getOrganizations=function(){CommonProvider.promise({model:CategoryModel,method:"get",params:{type:2,role:"student"},success:function(categorys){$scope.categorys=categorys.result},error:function(categorys){$modal.error({title:"请求异常",message:categorys.message})}})},$scope.getOrganizationLists=function(params){return CommonProvider.toTop(),$scope.organizations[params.cate.id]&&!params.page?!1:params.cate.id?void CommonProvider.promise({model:OrganizationModel,method:"get",params:{category_id:params.cate.id,role:"student",per_page:20,page:params.page||1},success:function(organizations){$scope.organizations[params.cate.id]=organizations},error:function(organizations){$modal.error({title:"请求异常",message:organizations.message})}}):!1},$scope.getOrganizationSearchList=function(params){$rootScope.toTop(),$scope.keyword=$stateParams.key,CommonProvider.promise({model:SearchModel,method:"get",params:{keyword:$stateParams.key||"",detail:1,only_name:1,search_type:"organization",per_page:20,page:params.page||1},success:function(organizations){$scope.organizations=organizations}})},$scope.changeCate=function(cate){$scope.currrent_category=cate,$scope.getOrganizationLists({cate:cate})},$scope.getIndex=function(){CommonProvider.promise({model:OrganizationModel,method:"item",params:{organization_id:$scope.organization_id},success:function(organization){$scope.organization.info=organization.result,$rootScope.title=$scope.organization.info.name,$rootScope.description=$scope.organization.info.introduction,$scope.getIndexCourses(),$scope.getIndexTeachers(),$scope.getIndexAnnouncements()},error:function(organization){$modal.error({title:"请求异常",message:organization.message})}})},$scope.getIndexCourses=function(){CommonProvider.promise({model:CourseModel,method:"get",params:{role:"student",page:1,per_page:12,organization_id:$scope.organization_id},success:function(courses){$scope.organization.info.courses=courses.result}})},$scope.getIndexTeachers=function(){CommonProvider.promise({model:OrganizationModel,method:"relation",params:{per_page:5,role:"student",organization_role:"teacher",page:1,organization_id:$scope.organization_id},success:function(teachers){$scope.organization.info.teachers=teachers.result}})},$scope.getIndexAnnouncements=function(){CommonProvider.promise({model:AnnouncementModel,method:"get",params:{per_page:10,role:"student",type:1,page:1,organization_id:$scope.organization_id},success:function(announcements){$scope.organization.info.announcements=announcements.result}})},$scope.announcementDetail=function(announcement){$modal.custom({title:"公告详情",template:'<h4 class="text-center">'+announcement.title+'</h4><hr><p class="text-height">'+announcement.content+"</p>"})},$scope.descriptionDetail=function(organization,length){return organization.introduction.length<=length?!1:void $modal.custom({title:organization.name+" - 学校详情",template:'<p class="text-height">'+organization.introduction+"</p>"})},$scope.teacherDetail=function(teacher,length){return teacher.introduction.length<=length?!1:void $modal.custom({title:teacher.user.real_name+" - 老师详情",template:'<p class="text-height">'+teacher.introduction+"</p>"})},$scope.getCourseLists=function(page){if($scope.organization.courses.pagination&&!page)return!1;var get_params={role:"student",page:page||1,per_page:12,sort_id:$scope.organization.courses.sort_id||0,organization_id:$scope.organization_id};1==$scope.organization.courses.is_live&&(get_params.is_live=1),CommonProvider.promise({model:CourseModel,method:"get",params:get_params,success:function(courses){courses.sort_id=$scope.organization.courses.sort_id,courses.is_live=$scope.organization.courses.is_live,$scope.organization.courses=courses}})},$scope.sortCourseLists=function(sort_id){return $scope.organization.courses.sort_id==sort_id?!1:($scope.organization.courses.sort_id=sort_id,void $scope.getCourseLists(1))},$scope.liveCourseLists=function(is_live){var is_live=Number(is_live);return $scope.organization.courses.is_live==is_live?!1:($scope.organization.courses.is_live=is_live,void $scope.getCourseLists(1))},$scope.getTeacherLists=function(params){return!params.page&&$scope.organization.teachers?!1:void CommonProvider.promise({model:OrganizationModel,method:"relation",params:{per_page:10,role:"student",organization_role:"teacher",page:params.page||1,organization_id:$scope.organization_id},success:function(teachers){$scope.organization.teachers=teachers}})},$scope.getTeacherIndex=function(){$scope.teacher.sort_id=0,$scope.teacher.is_live=0,CommonProvider.promise({model:OrganizationModel,method:"relation",params:{role:"student",organization_role:"teacher",organization_id:$scope.organization_id,user_id:$scope.teacher_id},success:function(teacher){$scope.teacher.info=teacher.result[0],$rootScope.title=$scope.teacher.info.user.profile.rel_name+"老师的主页"}})},$scope.getTeacherCourse=function(params){var params=params||{},get_params={role:"student",page:params.page||1,per_page:12,organization_id:$scope.organization_id,user_id:$scope.teacher_id,sort_id:$scope.teacher.sort_id};1==$scope.teacher.is_live&&(get_params.is_live=1),CommonProvider.promise({model:CourseModel,method:"get",params:get_params,success:function(courses){$scope.teacher.courses=courses}})},$scope.organizationIcon=function(cate){if(cate)switch(cate.name){case"大学":return"icon-university";case"中学":return"icon-high-school";case"培训机构":return"icon-entrance-tests";case"公益组织":return"icon-welfare"}}}]),angular.module("UserController",["angular.validation","angular.validation.rule","angular.modal","datePicker","StudentModel","TradeModel","CourseModel","CommentModel","FavoriteModel","NoteModel","QuestionModel","MsgModel","ScoreModel"]).controller("UserController",["$rootScope","$scope","$state","$stateParams","$location","$localStorage","$interval","$modal","dateFilter","QuploadProvider","CommonProvider","AuthProvider","StudentModel","TradeModel","CourseModel","CommentModel","CommonModel","FavoriteModel","NoteModel","QuestionModel","MsgModel","AuthModel","ScoreModel",function($rootScope,$scope,$state,$stateParams,$location,$localStorage,$interval,$modal,dateFilter,QuploadProvider,CommonProvider,AuthProvider,StudentModel,TradeModel,CourseModel,CommentModel,CommonModel,FavoriteModel,NoteModel,QuestionModel,MsgModel,AuthModel,ScoreModel){$rootScope.checkLogin(),$scope.$on("$locationChangeStart",function(){$rootScope.checkLogin()}),$scope.status={},$scope.user=$rootScope.user||{},$scope.$on("$stateChangeSuccess",function(event,next,current){$scope.status.current=$state.current.data.slug||!1,$scope.status.parent=$state.$current.parent&&$state.$current.parent.data?$state.$current.parent.data.slug:!1,$state.current.data.url=$state.current.data.url||$location.$$url,$scope.breadcrumb=$state,$rootScope.title=$state.current.data.title||$state.$current.parent.data.title||""}),$scope.getHistory=function(page){CommonProvider.promise({model:StudentModel,method:"get",params:{target_type:"study_record",per_page:10,page:page||1},success:function(history){$scope.history=history,$rootScope.toTop()}})},$scope.getIndex=function(){AuthProvider.init(function(user){$scope.user=user}),$scope.getHistory()},$scope.courseInit=function(){$scope.all_courses||($scope.all_courses=[{name:"全部课程",status:"all",sort:1},{name:"已试听",status:"0",sort:2},{name:"待付款",status:"1",sort:3},{name:"待评价",status:"2",sort:4},{name:"交易成功",status:"3",sort:5},{name:"已关闭",status:"-1",sort:6}])},$scope.getCourses=function(params){$rootScope.toTop();var get_params={role:"student",per_page:6,page:params.page||1};void 0!=params.status&&"all"!=params.status&&(get_params.status=params.status),CommonProvider.promise({model:TradeModel,method:"get",params:get_params,success:function(courses){$scope.all_courses.find(params.status,"status").courses=courses}})},$scope.batchCheck=function(params){var courses=$scope.all_courses.find(params.status,"status").courses.result;courses.forEach(function(course){1==course.trade_status&&(course.checked=params.check_all)})},$scope.batchPayment=function(status){var ids=$scope.all_courses.find(status,"status").courses.result.checked(!1,"course_id").join(",");return""==ids?($modal.error({message:"请选择多个课程进行操作"}),!1):void $location.path("payment/"+ids)},$scope.buy=function(course){CommonProvider.promise({model:CourseModel,method:"operation",params:{method:"buy",course_id:course.course_id},success:function(buy){course.rel_price&&$location.path("/payment/"+course.course_id),course.rel_price||$location.path("/course/"+course.course_id+"/learn/"+course.last_study_section_id)},error:function(buy){$modal.error({message:buy.message})}})},$scope.delCourseTrade=function(params){var doDelCourseTrade=function(){$scope.all_courses.find(params.status,"status").courses.pagination.current_page;CommonProvider.promise({model:TradeModel,method:"cancel",params:{trade_id:params.trade_id},success:function(result){$scope.getCourses({status:"all",page:$scope.all_courses.find("all","status").courses.pagination.current_page}),$scope.getCourses({status:"1",page:$scope.all_courses.find("1","status").courses.pagination.current_page}),$scope.getCourses({status:"-1",page:$scope.all_courses.find("-1","status").courses.pagination.current_page})}})};$modal.confirm({message:"你真的要取消订单吗？",onsubmit:doDelCourseTrade})},$scope.getFavorite=function(params){$rootScope.toTop(),AuthProvider.check(function(user){CommonProvider.promise({model:FavoriteModel,method:"get",params:{user_id:user.id,type:"course",page:params.page||1,per_page:12},success:function(favorites){$scope.favorites=favorites}})})},$scope.delFav=function(params){var doDelFav=function(){CommonProvider.promise({model:FavoriteModel,method:"del",params:{type:"course",target_id:params.id},success:function(favorites){$scope.getFavorite({page:$scope.favorites.pagination.current_page})}})};$modal.confirm({title:"确认删除",message:"确定要删除本条收藏吗？",info:"如果删除，该操作且不可恢复",onsubmit:doDelFav})},$scope.getNote=function(params){var target_page=params?params.page||1:1;AuthProvider.check(function(user){CommonProvider.promise({model:NoteModel,method:"get",params:{role:"student",user_id:user.id,per_page:10,page:target_page},success:function(notes){1==target_page?$scope.notes=notes:($scope.notes.pagination=notes.pagination,$scope.notes.result=$scope.notes.result.concat(notes.result))}})})},$scope.getFavoriteNote=function(params){var target_page=params?params.page||1:1;AuthProvider.check(function(user){CommonProvider.promise({model:FavoriteModel,method:"get",params:{user_id:user.id,type:"note",page:target_page,per_page:12},success:function(notes){1==target_page?$scope.fav_notes=notes:($scope.fav_notes.pagination=notes.pagination,$scope.fav_notes.result=$scope.fav_notes.result.concat(notes.result))}})})},$scope.delNote=function(note){var doDelNote=function(){CommonProvider.promise({model:NoteModel,method:"del",params:{note_id:note.id},success:function(_note){$scope.notes.result.remove(note)}})};$modal.confirm({title:"确认删除",message:"您确定要删除该笔记？",info:"删除后无法恢复，请您谨慎操作。",onsubmit:doDelNote})},$scope.delFavNote=function(note){var doDelFavNote=function(){CommonProvider.promise({model:FavoriteModel,method:"del",params:{target_id:note.note_id,type:"note"},success:function(_note){$scope.fav_notes.result.remove(note)}})};$modal.confirm({title:"确认删除",message:"您确定要删除该笔记收藏？",info:"删除后无法恢复，请谨慎操作",onsubmit:doDelFavNote})},$scope.editNote=function(note){$rootScope.note_local=note,$rootScope.note_edit=angular.copy(note.note),$modal.custom({title:"请在下方输入新的笔记内容",template_url:"/partials/home/user/note/edit.html",callback:function(){delete $rootScope.note_edit,$rootScope.note_local=null}})},$scope.saveNote=function(note){CommonProvider.promise({model:NoteModel,method:"put",params:{id:note.id,body:{section_id:note.section.id,content:note.content,is_publish:Number(note.is_publish),is_capture:Number(!!note.is_capture),record_time:note.record_time||0}},success:function(_note){$rootScope.note_local.note=note,$rootScope.modal.close()}})},$scope.getQuestion=function(params){var page=params?params.page||1:1;CommonProvider.promise({model:QuestionModel,method:"get",params:{role:"student",page:page,per_page:10},success:function(questions){1==page?$rootScope.questions=questions:($scope.questions.pagination=questions.pagination,$scope.questions.result=$scope.questions.result.concat(questions.result))}})},$scope.editQuestion=function(question){$rootScope.question_local=question,$rootScope.question_edit=angular.copy(question.question),$modal.custom({title:"修改问题",template_url:"/partials/home/user/question/edit.html",callback:function(){delete $rootScope.question_edit,$rootScope.question_local=null}})},$scope.saveQuestion=function(question){CommonProvider.promise({model:QuestionModel,method:"put",params:{id:question.id,body:{content:question.content,pid:question.pid}},success:function(_question){$rootScope.question_local.question=question,$rootScope.modal.close()}})},$scope.delQuestion=function(question){var doDelQuestion=function(){CommonProvider.promise({model:QuestionModel,method:"del",params:{question_id:question.id},success:function(_question){$scope.questions.result.remove(question),$scope.questions.pagination.total-=1}})};$modal.confirm({title:"确认删除",message:"确定要删除本条问题吗？",info:"如果删除，则该问题下包含的回答均会被删除，且不可恢复",onsubmit:doDelQuestion})},$scope.getAnswer=function(params){var page=params?params.page||1:1;CommonProvider.promise({model:QuestionModel,method:"get",params:{role:"student",page:page,per_page:10,type:"answer"},success:function(answers){1==page?$rootScope.answers=answers:($scope.answers.pagination=answers.pagination,$scope.answers.result=$scope.answers.result.concat(answers.result))}})},$scope.delAnswer=function(answer){$modal.confirm({title:"确认删除",message:"确定要删除本条回答吗？",info:"如果删除，则该回答将不再可见，且不可恢复",onsubmit:function(){CommonProvider.promise({model:QuestionModel,method:"del",params:{question_id:answer.id,role:"student"},success:function(_note){$scope.answers.result.remove(answer),$scope.answers.pagination.total-=1}})}})},$scope.getQAdetail=function(params){CommonProvider.promise({model:QuestionModel,method:"item",params:{question_id:$stateParams.question_id},success:function(questionAnswer){$scope.questionAnswer=questionAnswer.result}})},$scope.getQuestionAnswer=function(){CommonProvider.promise({model:QuestionModel,method:"get",params:{role:"student",page:$scope.questionAnswer.next_page,type:"answer"},success:function(answers){$scope.questionAnswer.answers.push(answers.result)}})},$scope.replyAnswer=function(answer){$rootScope.reply_edit=answer,$rootScope.questionAnswer=$scope.questionAnswer,$modal.custom({title:"回复答案",template_url:"/partials/home/user/question/reply-answer.html",callback:function(){delete $rootScope.reply_edit,$rootScope.questionAnswer=null}})},$scope.saveReplyAnswer=function(answer){CommonProvider.promise({model:QuestionModel,method:"post",params:{section_id:Number($rootScope.reply_edit.section_id),content:answer,pid:$rootScope.reply_edit.id,to_user_id:$rootScope.reply_edit.user.id},success:function(_answer){_answer.result.user={},_answer.result.user.name=$rootScope.user.name,_answer.result.user.id=$rootScope.user.id,_answer.result.user.gravatar=$rootScope.user.gravatar;var current=$rootScope.questionAnswer.answers.find($rootScope.reply_edit);current.children=current.children||[],current.children.unshift(_answer.result),$rootScope.modal.close();
}})},$scope.getBill=function(params){return $scope.bill_start_date=params.start?dateFilter(params.start,"yyyy-MM-dd"):$scope.bill_start_date,$scope.bill_end_date=params.end?dateFilter(params.end,"yyyy-MM-dd"):$scope.bill_end_date||dateFilter($scope.billDates.today._d,"yyyy-MM-dd"),$scope.bill_start_date&&$scope.bill_end_date?void CommonProvider.promise({model:StudentModel,method:"get",params:{target_type:"bill",role:"student",start_date:$scope.bill_start_date,end_date:$scope.bill_end_date,page:params.page||1,per_page:13},success:function(bills){$scope.bills=bills}}):!1},$scope.getScopeBill=function(dateUnit){$scope.getBill({start:new Date(moment().subtract(1,dateUnit)._d),end:$scope.billDates.today._d})},$scope.billInit=function(){$scope.billDates={today:moment(),min:moment().subtract(3,"y"),max:moment(),start:moment().subtract(7,"d"),end:moment()},$scope.getScopeBill("w")},$scope.getMsgs=function(params){$rootScope.toTop();var get_params={role:"user",per_page:14,page:params.page||1};void 0!=params.type&&"all"!=params.type&&(get_params.type=params.type),CommonProvider.promise({model:MsgModel,method:"get",params:get_params,success:function(messages){$scope.all_msgs.find(params.type,"type").messages=messages}})},$scope.msgInit=function(){$scope.all_msgs||($scope.all_msgs=[{name:"全部消息",type:"all",active:!0,sort:1},{name:"系统消息",type:"0",active:!1,sort:2},{name:"笔记消息",type:"1",active:!1,sort:3},{name:"问答消息",type:"2",active:!1,sort:4},{name:"课程消息",type:"3",active:!1,sort:5},{name:"机构消息",type:"4",active:!1,sort:6}])},$scope.postMsgRead=function(msgs){var ids,act;return msgs.all?(act=$scope.all_msgs.find(!0,"active"),ids=$scope.all_msgs.find(!0,"active").messages.result.ids().join(",")):(act=msgs.msg,ids=msgs.msg.msg.id),ids?void CommonProvider.promise({model:MsgModel,method:"batch",params:{role:"user",act_type:"disable",ids:ids},success:function(res){msgs.all?act.messages.result.setAttr("x_status",0):act.msg.x_status=0}}):!1},$scope.getAreaData=function(){$localStorage.area?$scope.area=$localStorage.area:CommonProvider.promise({model:CommonModel,method:"area",success:function(area){$scope.area=area.result,$localStorage.area=area.result}})},$scope.getUserInfo=function(){AuthProvider.init(function(user){$scope.user=user}),$scope.update_info_status=0,$scope.getAreaData()},$scope.updateInfo=function(){CommonProvider.promise({model:StudentModel,method:"put",params:{gravatar:$scope.user.gravatar,name:$scope.user.name,rel_name:$scope.user.profile.rel_name,gender:$scope.user.profile.gender,city:$scope.user.profile.city,province:$scope.user.profile.province,district:$scope.user.profile.district,email:$scope.user.profile.email,slogan:$scope.user.profile.slogan,id_card_pic:$scope.user.profile.id_card_pic},success:function(user){$rootScope.toTop(),$scope.user=user,$rootScope.user=user,$localStorage.user=user,$scope.update_info_status=1}})},$scope.backUp=function(){$location.path($state.$current.parent.url.sourcePath+"/index")},$scope.getlogoUpload=function(data){data&&($scope.user.gravatar=data.key)},$scope.getIdentityUpload=function(data){data&&($scope.user.profile.id_card_pic=data.key)},$scope.resetPassword=function(password){CommonProvider.promise({model:AuthModel,method:"reset",params:{old_password:password.old,password:password["new"]},success:function(pwd){console.log(pwd),$scope.reset_pwd_status=1},error:function(pwd){$modal.error({message:pwd.message})}})},$scope.userScoreInit=function(){$scope.score={},$scope.score.lists={},$scope.score.levels={},$scope.score.rules={},$scope.getScore({}),$scope.getScoreLevel({}),$scope.getScoreRule({})},$scope.getScore=function(params){CommonProvider.promise({model:ScoreModel,method:"get",params:{role:"user",per_page:14,page:params.page||1},success:function(lists){$scope.score.lists=lists}})},$scope.getScoreRule=function(params){CommonProvider.promise({model:ScoreModel,method:"getRules",params:{role:"user",per_page:14,page:params.page||1},success:function(rules){$scope.score.rules=rules}})},$scope.getScoreLevel=function(params){CommonProvider.promise({model:ScoreModel,method:"getLevels",params:{role:"user",per_page:14,page:params.page||1},success:function(levels){$scope.score.levels=levels}})}}]),angular.module("LessonController",["angular.validation","angular.validation.rule","Qupload","Umeditor","angular-sortable-view","angular-related-select","SectionModel","CategoryModel"]).controller("LessonController",["$rootScope","$scope","$stateParams","$location","$localStorage","$modal","CommonProvider","AuthProvider","SectionModel","CategoryModel","CourseModel","OrganizationModel",function($rootScope,$scope,$stateParams,$location,$localStorage,$modal,CommonProvider,AuthProvider,SectionModel,CategoryModel,CourseModel,OrganizationModel){$rootScope.checkLogin(),$scope.$on("$locationChangeStart",function(){$rootScope.checkLogin()}),$scope.course={},$scope.course_id=$stateParams.course_id||!1,$scope.categories=[],$scope.course.category_id=0,$scope.selectChange=function(select){$scope.course.category_id=select.ckdSelectId},window.onbeforeunload=function(event){$rootScope.uploading&&(event.returnValue="当前存在正在上传的视频，确定要退出吗？")},$scope.courseInit=function(){AuthProvider.check(function(user){$scope.user=user})},$scope.editCourse=function(){$scope.course_id?CommonProvider.promise({model:CourseModel,method:"item",params:{course_id:$scope.course_id,role:"teacher"},success:function(course){$scope.course=course.result,$scope.course.organization_id=$scope.course.organization_id||void 0,$scope.getCategorys(),$scope.getOrganizations()}}):($scope.course.category_id=0,$scope.course.thumb="",$scope.getCategorys(),$scope.getOrganizations())},$scope.getCategorys=function(callback){CommonProvider.promise({model:CategoryModel,method:"get",params:{category_id:0,type:1},success:function(categories){$scope.categories=categories.result,callback&&"function"==typeof callback&&callback($scope.categories)}})},$scope.getOrganizations=function(){CommonProvider.promise({model:OrganizationModel,method:"relation",params:{role:"teacher",status:"2,3,4,5",page:1,per_page:100},success:function(organizations){$scope.organizations=organizations.result}})},$scope.updateCourse=function(){var course={name:$scope.course.name,thumb:$scope.course.thumb,rel_price:$scope.course.rel_price,description:$scope.course.description,introduction:$scope.course.introduction,category_id:$scope.course.category_id,organization_id:$scope.course.organization_id,role:"teacher"};$scope.course_id&&(course.id=$scope.course_id),CommonProvider.promise({model:CourseModel,method:$scope.course_id?"put":"add",params:$scope.course_id?{"new":course}:course,success:function(course){$scope.course_id?$modal.success({message:"课程编辑成功",callback:function(){$location.path("teacher/course/list")}}):$modal.success({message:"课程发布成功",callback:function(){$location.path("teacher/course/section/edit/"+course.result.id)}})},error:function(course){$modal.error({message:course.message})}})},$scope.getUploadThumb=function(data){data&&($scope.course.thumb=data.key)},$scope.courseInit=function(){AuthProvider.check(function(user){$scope.user=user,user.is_teacher&&($scope.all_courses||($scope.all_courses=[{name:"全部课程",x_status:"all",sort:1},{name:"上架中",x_status:"1",sort:2},{name:"已下架",x_status:"0",sort:3}]))})},$scope.getCourses=function(params){$rootScope.toTop();var get_params={role:"teacher",user_id:1,per_page:6,sort_id:1,page:params.page||1};void 0!=params.x_status&&"all"!=params.x_status&&(get_params.x_status=params.x_status),CommonProvider.promise({model:CourseModel,method:"get",params:get_params,success:function(courses){$scope.all_courses.find(params.x_status,"x_status").courses=courses}})},$scope.courseEvent=function(callback){var ids=$scope.all_courses.find(!0,"active").courses.result.checked();return ids.length?void callback(ids):($modal.error({message:"无有效选中课程用于操作"}),!1)},$scope.refreshCourses=function(){$scope.getCourses({x_status:"all",page:$scope.all_courses.find("all","x_status").courses.pagination.current_page}),$scope.getCourses({x_status:"0",page:$scope.all_courses.find("0","x_status").courses.pagination.current_page}),$scope.getCourses({x_status:"1",page:$scope.all_courses.find("1","x_status").courses.pagination.current_page})},$scope.sellCourse=function(){$scope.courseEvent(function(ids){$modal.confirm({title:"确认操作",message:"确定要上架这些课程吗？",onsubmit:function(){CommonProvider.promise({model:CourseModel,method:"enable",params:ids,success:function(course){$modal.success({message:"成功上架"+course.result+"个课程"}),$scope.all_courses.setAttr("check_all",!1),$scope.refreshCourses()},error:function(course){$modal.error({message:course.message})}})}})})},$scope.delistingCourse=function(){$scope.courseEvent(function(ids){$modal.confirm({title:"确认操作",message:"确定要下架这些课程吗？",onsubmit:function(){CommonProvider.promise({model:CourseModel,method:"disable",params:ids,success:function(course){$modal.success({message:"成功下架"+course.result+"个课程"}),$scope.all_courses.setAttr("check_all",!1),$scope.refreshCourses()},error:function(course){$modal.error({message:course.message})}})}})})},$scope.delCourse=function(){$scope.courseEvent(function(ids){$modal.confirm({title:"确认操作",message:"确定要删除这些课程吗？",info:"删除后该课程所有相关信息将不复存在",onsubmit:function(){CommonProvider.promise({model:CourseModel,method:"delete",params:ids,success:function(course){$modal.success({message:"成功删除"+course.result+"个课程"}),$scope.all_courses.setAttr("check_all",!1),$scope.refreshCourses()},error:function(course){$modal.error({message:course.message})}})}})})},$scope.editSection=function(){return $scope.course_id?(CommonProvider.promise({model:CourseModel,method:"item",params:{course_id:$scope.course_id,role:"teacher"},success:function(course){$scope.course=course.result,$scope.course.rel_price||$scope.chapters.setAttr("is_free",1,"children")}}),void CommonProvider.promise({model:SectionModel,method:"get",params:{role:"teacher",course_id:$scope.course_id},success:function(chapters){$scope.chapters=chapters.result,$scope.chapters.length||$scope.addChapter()},error:function(chapters){$modal.error({message:chapters.message})}})):($modal.error({message:"请您选择课程添加章节"}),$location.path("teacher/course/list"),!1)},$scope.addChapter=function(){var chapter={name:"",course_id:$scope.course_id,pid:0,is_free:Number(!$scope.course.rel_price),sort:$scope.chapters.length+1};$scope.chapters.push(chapter)},$scope.addSection=function(chapter){var section={name:"",course_id:$scope.course_id,description:"",pid:chapter.chapter.id,is_free:!!chapter.chapter.is_free||0,status:0,sort:chapter.chapter.children?chapter.chapter.children.length+1:1};return section.pid?(chapter.chapter.children=chapter.chapter.children||[],chapter.chapter.children.push(section),void(chapter.chapter.open=!0)):($modal.error({message:"请先完善该章内容"}),!1)},$scope.updateChapter=function(chapter){var _chapter={pid:0,name:chapter.name,sort:chapter.sort,is_free:Number(chapter.is_free),course_id:$scope.course_id};chapter.id&&(_chapter.id=chapter.id),CommonProvider.promise({model:SectionModel,method:_chapter.id?"put":"add",params:_chapter,success:function(__chapter){var index=$scope.chapters.indexOf(chapter);angular.extend($scope.chapters[index],__chapter.result),$scope.chapters[index].tooltit=_chapter.id?"章节信息更新成功":"章节添加成功"},error:function(__chapter){$modal.error({message:__chapter.message})}})},$scope.updateSection=function(section){var _section={pid:section.section.pid,name:section.section.name,sort:section.section.sort,is_free:section.section.is_free,is_live:section.section.is_live,course_id:$scope.course_id};_section.is_live&&(_section.live_at=section.section.live_at,_section.live_duration=section.section.live_duration),section.section.id&&(_section.id=section.section.id),CommonProvider.promise({model:SectionModel,method:_section.id?"put":"add",params:_section,success:function(__section){var index=section.$parent.$parent.chapter.children.indexOf(section.section);angular.extend(section.$parent.$parent.chapter.children[index],__section.result),section.section.status=section.section.status||0,section.section.live_status=0,section.section.tooltit=_section.id?"本节信息更新成功":"成功添加本节"},error:function(__section){$modal.error({message:__section.message})}})},$scope.setSectionFree=function(section){return $scope.course.rel_price<=0?!1:section.name&&section.id?void CommonProvider.promise({model:SectionModel,method:"put",params:{id:section.id,name:section.name,is_free:section.is_free}}):(section.is_free=0,$modal.error({message:"请先完善本节内容"}),!1)},$scope.setSectionLive=function(section){if(!section.section.is_live)return!1;var is_add=void 0==section.section.id,live_at=section.section.live_at,live_duration=section.section.live_duration;!is_add||live_at&&live_duration&&moment(live_at)>moment()||$scope.updateSectionLiveInfo({modal:!1,section:section})},$scope.delChapter=function(chapter){$modal.confirm({title:"是否真的要删除",message:"确定要删除本章吗？",info:"如果删除，章所属课程及视频也同时将被删除",onsubmit:function(){return chapter.id?void CommonProvider.promise({model:SectionModel,method:"del",params:{section_id:chapter.id},success:function(_chapter){$scope.chapters.remove(chapter)}}):($scope.chapters.remove(chapter),!1)}})},$scope.delSection=function(section){$modal.confirm({title:"是否真的要删除",message:"确定要删除本节吗？",info:"如果删除，删除后本节视频也将会被删除",onsubmit:function(){return section.section.id?void CommonProvider.promise({model:SectionModel,method:"del",params:{section_id:section.section.id},success:function(_chapter){section.$parent.$parent.chapter.children.remove(section.section)}}):(section.$parent.$parent.chapter.children.remove(section.section),!1)}})},$scope.sectionPreview=function(section){return section.id?void CommonProvider.promise({model:SectionModel,method:"getVideos",params:{section_id:section.id},success:function(videos){var video=videos.result,player={};player.modal=1,player.urls=video.urls,player.is_live=video.is_live,player.live_status=video.live_status,$rootScope.player=player,$modal.custom({title:"课程预览",template:'<style>.modal-body{overflow:hidden;}.video-player .video-js{width:100%;height:320px;}</style><div video-player data="$root.player"></div>',callback:function(){$rootScope.player=null,delete $rootScope.player}})},error:function(videos){$modal.warning({message:videos.message})}}):($modal.error({message:"参数异常"}),!1)},$scope.sectionSort=function($item,$partFrom,$partTo,$indexFrom,$indexTo){for(var sort,sorts=[],i=0;i<$partTo.length;i++)sort={},sort.data={},sort.id=$partTo[i].id,sort.data.sort=i,sorts.push(sort);SectionModel.sort(sorts)},$scope.updateSectionInit=function(){var duration=$rootScope.section_local.live_duration,live_at=$rootScope.section_local.live_at;$scope.live={},$scope.live.at=live_at?moment(live_at):moment(),$scope.live.duration={},$scope.live.duration.hours=parseInt(duration/60),$scope.live.duration.moments=duration%60,$scope.minDate=moment(),$scope.maxDate=moment().add(30,"days")},$scope.updateSectionLiveInfo=function(params){if(params.modal){if($rootScope.section_local.live_at=params.live.at.format("YYYY-MM-DD HH:mm:ss"),$rootScope.section_local.live_duration=60*params.live.duration.hours+params.live.duration.moments,!$rootScope.section_edit.section.id)return $rootScope.section_edit.section.live_at=$rootScope.section_local.live_at,$rootScope.section_edit.section.live_duration=$rootScope.section_local.live_duration,$rootScope.modal.close(),!1;CommonProvider.promise({model:SectionModel,method:"put",params:$rootScope.section_local,success:function(section){$rootScope.section_edit.section.live_at=$rootScope.section_local.live_at,$rootScope.section_edit.section.live_duration=$rootScope.section_local.live_duration,$rootScope.section_edit.section.live_status=0,$rootScope.modal.close()},error:function(section){$modal.error({message:section.message})}})}else $rootScope.section_edit=params.section,$rootScope.section_local=angular.copy(params.section.section),$modal.custom({title:(params.edit?"修改":"完善")+"直播信息 - 《"+(params.section.section.name||"新发布课程")+"》",template_url:"/partials/home/teacher/course/section-live-info.html",callback:function(){var section=$rootScope.section_edit,is_add=void 0==section.section.id,live_at=section.section.live_at,live_duration=section.section.live_duration;return!is_add||live_at&&live_duration&&moment(live_at)>moment()?($rootScope.section_edit=null,void delete $rootScope.section_local):($rootScope.section_edit.section.is_live=0,!1)}})},$scope.liveSectionAction=function(params){var section=params.section,is_init=params.init,live_ok=moment(section.live_at)>moment();return!is_init||section.name&&section.id&&section.live_duration&&live_ok?void $modal.confirm({title:"确认操作",message:is_init?"确定要初始化本节吗？":"确定要结束本节直播吗？",info:is_init?"本操作将立即创建直播间及聊天室，且不可撤销":"本操作将关闭直播间及聊天室，且不可撤销",onsubmit:function(){CommonProvider.promise({model:SectionModel,method:is_init?"initLiveSection":"closeLiveSection",params:{section_id:section.id},result:function(status){1==status.code?(is_init&&(section.live_status=1.1),is_init||(section.live_status=3),$modal.success({message:status.message})):$modal.error({message:status.message})}})}}):$modal.error({message:"请先完善本节信息"})},$scope.sectionVerifyFailed=function(section){$modal.custom({title:"《"+section.name+"》 - 审核失败",template:'<div><div class="col-xs-offset-1 col-xs-10"><h4>本节审核失败，失败原因：<span class="text-danger">'+(section.remark||"暂无")+'</span></h4><h4 class="text-muted">建议更正本节信息或重新上传视频，会重新发起审核</h4></div><div class="col-xs-12"><br></div></div>'})},$scope.toLiveSectionLearn=function(section){$location.path("course/"+$scope.course_id+"/learn/"+section.id)},$scope.getLiveSectionRtmp=function(section){CommonProvider.promise({model:SectionModel,method:"getLiveUpstream",params:{section_id:section.id},result:function(rtmp){1==rtmp.code?$modal.custom({title:"章节 - 《"+section.name+"》推流地址",template:'<div><div class="col-xs-12"><br></div><div class="col-xs-12"><div class="col-xs-offset-1 col-xs-6"><h4>推流地址：<a href="" ng-click="$root.copyLink(\''+rtmp.result.publish_url+"')\">( 点击复制 )</a></h4><p>"+rtmp.result.publish_url+'</p></div></div><div class="col-xs-12"><div class="col-xs-offset-1 col-xs-6"><h4>推流秘钥：<a href="" ng-click="$root.copyLink(\''+rtmp.result.publish_key+"')\">( 点击复制 )</a></h4><p>"+rtmp.result.publish_key+'</p></div></div><div class="col-xs-12"><div class="col-xs-offset-1 col-xs-6"><h4>RoomId：<a href="" ng-click="$root.copyLink(\''+rtmp.result.room_id+"')\">( 点击复制 )</a></h4><p>"+rtmp.result.room_id+'</p></div></div><div class="col-xs-12"><div class="col-xs-offset-1 col-xs-6"><h4 class="text-danger">推流教程：</h4><p>官方客户端：OBS</p></div></div><div class="col-xs-12"><br></div></div>'}):$modal.error({message:rtmp.message})}})},$rootScope.copyLink=function(link){window.prompt("按下Ctrl+C, 复制地址",link)}}]),angular.module("IncomeController",["angular.validation","angular.modal","TeacherModel","WithdrawModel","BankModel"]).controller("IncomeController",["$rootScope","$scope","$stateParams","$location","$localStorage","$interval","$modal","dateFilter","AuthProvider","CommonProvider","CommonModel","TeacherModel","WithdrawModel","BankModel",function($rootScope,$scope,$stateParams,$location,$localStorage,$interval,$modal,dateFilter,AuthProvider,CommonProvider,CommonModel,TeacherModel,WithdrawModel,BankModel){$scope.income={},$scope.income.lists={},$scope.income.charts={},$scope.withdraw={},$scope.withdraw.status=0,$scope.bankAcount={},$scope.bankAcount.bank={},$scope.bankAcount.alipay={},AuthProvider.init(function(user){$scope.user=user}),$scope.getIncomeLists=function(params){CommonProvider.promise({model:TeacherModel,method:"incomeDetail",params:{per_page:7,page:params.page||1},success:function(lists){$scope.income.lists=lists}})},$scope.getIncomeCharts=function(dateUnit){if($scope.income.charts[dateUnit])return!1;$scope.income.charts[dateUnit]=$scope.income.charts[dateUnit]||{};var charts_config={grid:{height:170,left:"5%",right:"5%",top:"18%"},title:{text:"近"+("w"==dateUnit?"7天":"M"==dateUnit?"一个月":"三个月")+"收入"},tooltip:{trigger:"axis",formatter:"日期: {b0}<br/>收入: {c0} 元"},legend:{data:["收入金额（元）"]},xAxis:{type:"category",boundaryGap:!1,data:[],nameGap:50,axisLabel:{margin:15}},dataZoom:[{xAxisIndex:0,type:"slider",start:0,end:100,dataBackgroundColor:"#eee",fillerColor:"rgba(221,221,221,0.2)",handleColor:"#ddd",handleSize:8,filterMode:"filter"},{yAxisIndex:0,type:"slider",start:0,end:100,dataBackgroundColor:"#eee",fillerColor:"rgba(221,221,221,0.2)",handleColor:"#ddd",handleSize:8,filterMode:"filter"}],yAxis:{},series:[{name:"收入金额（元）",type:"line",data:[],symbolSize:10,legendHoverLink:!0,smooth:!0,clipOverflow:!0,lineStyle:{normal:{width:2}}}],color:["#1dba9c"]},chartsBuild=function(dateUnit){$scope.income.charts[dateUnit].chart={};var x_axis_data=function(){for(var date_item,before=moment().subtract(1,dateUnit),today=moment().startOf("day"),days=Math.ceil(moment.duration(today-before).asDays()),date_array=[],i=1;days>=i;i++)date_item=dateFilter(new Date(moment().subtract(i,"d")._d),"MM-dd"),date_array.unshift(date_item);return date_array};$scope.income.charts[dateUnit].chart=echarts.init(document.getElementById("J_chart_"+dateUnit)),$scope.income.charts[dateUnit].config=charts_config,$scope.income.charts[dateUnit].config.xAxis.data=x_axis_data(),$scope.income.charts[dateUnit].config.title.text+="（共"+eval($scope.income.charts[dateUnit].data.join("+"))+"元）",$scope.income.charts[dateUnit].config.series[0].data=$scope.income.charts[dateUnit].data,$scope.income.charts[dateUnit].chart.setOption($scope.income.charts[dateUnit].config)};CommonProvider.promise({model:TeacherModel,method:"incomeDaily",params:{start_date:dateFilter(new Date(moment().subtract(1,dateUnit)._d),"yyyy-MM-dd")},success:function(charts){$scope.income.charts[dateUnit].data=charts.result,chartsBuild(dateUnit)}})},$scope.getWithdrawRecord=function(params){CommonProvider.promise({model:WithdrawModel,method:"get",params:{per_page:15,page:params.page||1},success:function(records){$scope.withdraw.records=records}})},$scope.getBankAccount=function(){CommonProvider.promise({model:BankModel,method:"get",params:{role:"user",per_page:100,page:1},success:function(banks){$scope.withdraw.banks=banks}})},$scope.postWithDraw=function(withdraw){return withdraw.amount>$scope.user.profile.income_remain?($modal.error({title:"错误",message:"提现金额不能大于总余额"}),!1):void CommonProvider.promise({model:WithdrawModel,method:"apply",params:{amount:withdraw.amount,bank_account_id:withdraw.bank_account_id},success:function(_withdraw){$scope.withdraw.status=1,$scope.user.profile.income_remain=_withdraw.result,$rootScope.user.profile.income_remain=_withdraw.result,$localStorage.user.profile.income_remain=_withdraw.result}})},$scope.delAccount=function(bank){$modal.confirm({title:"确认操作",message:"确认要删除吗?",info:"确定要删除本账户吗？如果删除，则该账户将不可恢复，但不影响已申请的提现",onsubmit:function(){CommonProvider.promise({model:BankModel,method:"del",params:{bank_id:bank.id},success:function(_bank){console.log(_bank),$scope.withdraw.banks.result.remove(bank),$scope.withdraw.banks.pagination.total-=1}})}})},$scope.alipayIdFormat=function(account){$scope.bankAcount.alipay.account=account?account.replace(/[\u4E00-\u9FA5\uf900-\ufa2d]/g,""):""},$scope.$watch("bankAcount.bank.account",function(account){$scope.bankAcount.bank.account=null==account?"":account.replace(/\D/g,"").replace(/....(?!$)/g,"$& ")}),$scope.identityIdFormat=function(identity){$scope.bankAcount.bank.identity=null==identity?"":identity.replace(/[^(0-9|x|X)]/g,"")},$scope.getBankInfo=function(bank_id){if(null==bank_id)return!1;var card_id=bank_id.replace(/\s/g,"");return card_id.length<16||card_id.length>19?!1:void CommonProvider.promise({model:BankModel,method:"getInfo",params:{card_num:card_id},success:function(bank_info){$scope.bankAcount.bank.info=bank_info.result}})},$scope.getVerifyCode=function(phone){if(!phone)return $modal.error({message:"手机号码不能为空"}),!1;if(1==$scope.verify_status)return!1;var timePromise,verifyTimimg=function(){return timePromise=$interval(function(){$scope.verify_seconds-=1,$scope.verify_status=!0,0==$scope.verify_seconds&&($scope.verify_status=!1)},1e3,$scope.verify_seconds)};CommonProvider.promise({model:CommonModel,method:"sms",params:{rule:"check_mobile_exists",phone:phone},success:function(_bank){$scope.verify_seconds=60,verifyTimimg()},error:function(_bank){$modal.error({message:_bank.message})}})},$scope.addBankAccount=function(bankAcount){var account={code:bankAcount.v_code,account_type:$scope.bankAcount.type,account_num:bankAcount.account.replace(/\s/g,""),account_code:bankAcount.account_code||bankAcount.info.bank_code,account_name:bankAcount.account_name||bankAcount.info.bank_name};return 2==account.account_type&&(account.bank_user_ID=bankAcount.identity,account.bank_user_phone=bankAcount.phone,1!=$scope.bankAcount.bank.info.card_type)?($scope.bankAcount.bank.status=0,$scope.bankAcount.bank.msg=-1==$scope.bankAcount.bank.info.card_type?"不支持信用卡提现":0==$scope.bankAcount.bank.info.card_type?"您提供的银行信息无效":"网络故障，请刷新重试",!1):void CommonProvider.promise({model:BankModel,method:"add",params:account,result:function(_bank_account){$scope.bankAcount.status=_bank_account.code},error:function(_bank_account){$modal.error({message:_bank_account.message})}})}}]),angular.module("StudentController",["StudentModel","TradeModel","NoteModel","QuestionModel","FavoriteModel"]).controller("StudentController",["$rootScope","$scope","$stateParams","$state","$localStorage","CommonProvider","StudentModel","TradeModel","NoteModel","QuestionModel","FavoriteModel",function($rootScope,$scope,$stateParams,$state,$localStorage,CommonProvider,StudentModel,TradeModel,NoteModel,QuestionModel,FavoriteModel){$scope.student={},$scope.student_id=$stateParams.student_id||!1,$scope.course_sort_id=2,$scope.getStudentInfo=function(target_page){CommonProvider.promise({model:StudentModel,method:"get",params:{target_type:$scope.student_id},success:function(student){$scope.student.info=student.result,$rootScope.title=$scope.student.info.name+"的个人主页"}})},$scope.getStudentCourses=function(params){CommonProvider.promise({model:TradeModel,method:"get",params:{role:"student",user_id:$scope.student_id,page:params.page||1,per_page:20},success:function(courses){$scope.student.courses=courses,$rootScope.toTop()}})},$scope.getNoteFavStatus=function(){CommonProvider.promise({model:FavoriteModel,method:"getStatus",params:{type:"note",target_ids:$scope.student.notes.result.ids().join(","),per_page:100},success:function(status){var followeds=status.result,notes=$scope.student.notes.result;followeds.forEach(function(id){notes.forEach(function(note){note.id==id&&(note.is_followed=1)})})}})},$scope.getStudentNotes=function(params){CommonProvider.promise({model:NoteModel,method:"get",params:{role:"student",user_id:$scope.student_id,page:params.page||1,per_page:20},success:function(notes){$scope.student.notes=notes,$scope.getNoteFavStatus(),$rootScope.toTop()}})},$scope.getStudentQuestions=function(params){CommonProvider.promise({model:QuestionModel,method:"get",params:{role:"student",user_id:$scope.student_id,type:"question",page:params.page||1,per_page:20},success:function(questions){$scope.student.questions=questions,$rootScope.toTop()}})},$scope.getStudentAnswers=function(params){CommonProvider.promise({model:QuestionModel,method:"get",params:{role:"student",user_id:$scope.student_id,type:"answer",page:params.page||1,per_page:20},success:function(answers){$scope.student.answers=answers,$rootScope.toTop()}})},$scope.addFavNote=function(note){var doFav=function(){CommonProvider.promise({model:FavoriteModel,method:"add",params:{type:"note",target_id:note.id},success:function(fav){note.is_followed=1},error:function(fav){$modal.error({message:fav.message})}})};$localStorage.token?doFav():$rootScope.modal.login(function(){doFav()})}}]),angular.module("TeacherController",["angular.validation","angular.bootstrap.rating","angular.modal","TeacherModel","TradeModel","AnnouncementModel","CommentModel"]).controller("TeacherController",["$rootScope","$scope","$state","$stateParams","$location","$timeout","$modal","$localStorage","AuthProvider","CommonProvider","TeacherModel","TradeModel","AnnouncementModel","CommentModel",function($rootScope,$scope,$state,$stateParams,$location,$timeout,$modal,$localStorage,AuthProvider,CommonProvider,TeacherModel,TradeModel,AnnouncementModel,CommentModel){$rootScope.checkLogin(),$scope.$on("$locationChangeStart",function(){$rootScope.checkLogin()}),$scope.status={},$scope.organization_id=$stateParams.organization_id,$scope.$on("$stateChangeSuccess",function(event,next,current){$scope.status.current=$state.current.data.slug||!1,$scope.status.parent=$state.$current.parent&&$state.$current.parent.data?$state.$current.parent.data.slug:!1,$state.current.data.url=$state.current.data.url||$location.$$url,$scope.breadcrumb=$state,$rootScope.title=$state.current.data.title||$state.$current.parent.data.title||""}),$scope.getIndex=function(){AuthProvider.init(function(user){$scope.teacher=user})},$scope.getNotices=function(){CommonProvider.promise({model:AnnouncementModel,method:"get",params:{role:"teacher",type:2,page:1,per_page:5},success:function(notices){$scope.notices=notices}})},$scope.getToDoList=function(){CommonProvider.promise({model:TeacherModel,method:"get",params:{target_type:"todo"},success:function(to_do_list){$scope.to_do_list=to_do_list.result}})},$scope.tradeInit=function(){AuthProvider.check(function(user){$scope.user=user,user.is_teacher&&($scope.all_courses||($scope.all_courses=[{name:"全部课程",status:"all",sort:1},{name:"待付款",status:"1",sort:3},{name:"交易成功",status:"2",sort:4},{name:"已评价",status:"3",sort:5},{name:"关闭的订单",status:"-1",sort:6}]))})},$scope.getTrades=function(params){$rootScope.toTop();var get_params={role:"teacher",per_page:6,page:params.page||1};void 0!=params.status&&"all"!=params.status&&(get_params.status=params.status),CommonProvider.promise({model:TradeModel,method:"get",params:get_params,success:function(courses){$scope.all_courses.find(params.status,"status").courses=courses},result:function(courses){if(courses.status&&0==courses.data.code){var current=$scope.all_courses.find(params.status,"status");current.courses={pagination:{total:0},result:[]}}}})},$scope.delCourseTrade=function(params){var doDelCourseTrade=function(){$scope.all_courses.find(params.status,"status").courses.pagination.current_page;CommonProvider.promise({model:TradeModel,method:"cancel",params:{trade_id:params.trade_id},success:function(result){$scope.getTrades({status:"all",page:$scope.all_courses.find("all","status").courses.pagination.current_page}),$scope.getTrades({status:"1",page:$scope.all_courses.find("1","status").courses.pagination.current_page}),$scope.getTrades({status:"-1",page:$scope.all_courses.find("-1","status").courses.pagination.current_page})}})};$modal.confirm({message:"你真的要取消订单吗？",onsubmit:doDelCourseTrade})},$scope.rateInit=function(){AuthProvider.check(function(user){$scope.user=user,user.is_teacher&&($scope.rates=$scope.rates||{})})},$scope.getRates=function(params){$rootScope.toTop();var get_params={role:"teacher",type:"comment",per_page:6,page:params.page||1};params.x_status&&(get_params.x_status=params.x_status),params.is_replied&&(get_params.is_replied=params.is_replied),CommonProvider.promise({model:CommentModel,method:"get",params:get_params,success:function(rates){$scope.rates[params.type]=rates},result:function(rates){if(rates.status&&0==rates.data.code){var current=$scope.rates[params.type];current={pagination:{total:0},result:[]}}}})},$scope.replyRate=function(params){params.modal?($rootScope.rate_local=params.rate,$rootScope.rate_edit=angular.copy(params.rate.$parent.rate),$modal.custom({title:"回复评价",template_url:"/partials/home/teacher/rate/reply.html",callback:function(){delete $rootScope.rate_edit,$rootScope.rate_local=null}})):CommonProvider.promise({model:CommentModel,method:"post",params:{role:"teacher",body:{course_id:$rootScope.rate_edit.course_id,content:$rootScope.rate_edit.new_reply,pid:$rootScope.rate_edit.id}},success:function(_reply){$rootScope.rate_local.$parent.rate.reply_info=_reply.result,
$rootScope.rate_local.$parent.rate.is_replied=1,$rootScope.modal.close(),$scope.getRates({type:"replied",is_replied:1})},error:function(err){$modal.error({message:err.message})}})},$scope.delReply=function(comment){$modal.confirm({title:"确认操作",message:"您确定要删除该回复吗？",info:"用户评价仅可以回复一次，删除后无法再恢复",button:{confirm:"确定",cancel:"取消"},onsubmit:function(){CommonProvider.promise({model:CommentModel,method:"del",params:{comment_id:comment.rate.reply[0].id},success:function(rates){comment.rate.reply=[]},error:function(res){$modal.error({message:res.message})}})}})}}]),angular.module("SchoolController",["angular.modal","TypeaheadDirective","ScrolledDirective","TeacherModel","AuditModel","CategoryModel","SearchModel","SearchService","StudentModel"]).controller("SchoolController",["$rootScope","$scope","$state","$http","$stateParams","$location","$timeout","$modal","$localStorage","AuthProvider","CommonProvider","AnnouncementModel","OrganizationModel","AuditModel","CommonModel","CategoryModel","SearchModel","SearchService","StudentModel",function($rootScope,$scope,$state,$http,$stateParams,$location,$timeout,$modal,$localStorage,AuthProvider,CommonProvider,AnnouncementModel,OrganizationModel,AuditModel,CommonModel,CategoryModel,SearchModel,SearchService,StudentModel){$rootScope.checkLogin(),$scope.$on("$locationChangeStart",function(){$rootScope.checkLogin()}),$scope.organization={},$scope.organization_id=$stateParams.organization_id||!1,$scope.$on("$stateChangeSuccess",function(event,next,current){$scope.status.current=$state.current.data.slug||!1,$scope.status.parent=$state.$current.parent&&$state.$current.parent.data?$state.$current.parent.data.slug:!1,$state.current.data.url=$state.current.data.url||$location.$$url,$scope.breadcrumb=$state,$rootScope.title=$state.current.data.title||$state.$current.parent.data.title||""}),$scope.schoolManageInit=function(){$scope.organization.info={},$scope.organization.audit={},$scope.organization.theme={},$scope.organization.teacher={},$scope.organization.announcements={},$scope.organization.info_can_edit=!1,$scope.organization.audit_can_edit=!1,$scope.getOrganizationInfo(),$scope.getOrganizationAudit(),$scope.initOrganizationTeachers(),$scope.getAnnouncement({}),$scope.getThemeTemplate()},$scope.schoolInit=function(){$scope.all_schools||($scope.all_schools=[{name:"我创建的",type:"creator",status:"5",sort:0},{name:"我管理的",type:"manage",status:"4",sort:1},{name:"我申请的",type:"apply",status:"1,2,-2",from:"2",sort:2},{name:"邀请我的",type:"invite",status:"0,-1,2",from:"1",sort:3}])},$scope.getOrganizationList=function(params){params.page||1!=params.from||$rootScope.setDomPosition(angular.element("#J_school_list ul").scope());var current_relations=$scope.all_schools.find(params.status,"status").relations;if(current_relations&&!params.page)return!1;$rootScope.toTop();var get_config={role:"teacher",status:params.status,page:params.page||1,per_page:8};params.from&&(get_config.from=params.from),CommonProvider.promise({model:OrganizationModel,method:"relation",params:get_config,result:function(relations){$scope.all_schools.find(get_config.status,"status").relations=relations}})},$scope.quitOrganization=function(relation){$modal.confirm({title:"确认操作",message:"你确定要退出这个学校吗？",info:"确定要退出吗？退出后不可再次加入",button:{confirm:"确定",cancel:"放弃"},onsubmit:function(){console.log(relation),CommonProvider.promise({model:OrganizationModel,method:"delRelation",params:{role:"user",relation_id:relation.relation.id},success:function(_teacher){$scope.all_schools.find(relation.type,"type").relations.result.remove(relation.relation),$modal.success({message:"操作成功"})}})}})},$scope.agreeInviteJoin=function(relation){$modal.confirm({title:"确认操作",message:"你确定要加入此机构吗？",info:"确定要加入吗？加入后将成为此机构老师",button:{confirm:"确定",cancel:"放弃"},onsubmit:function(){console.log(relation),CommonProvider.promise({model:OrganizationModel,method:"putRelation",params:{role:"user",id:relation.relation.id,organization_role:"teacher",body:{status:2}},success:function(_teacher){$modal.success({message:"操作成功"}),$scope.all_schools.find(relation.type,"type").relations.result.find(relation.relation).status=2}})}})},$scope.refuseInviteJoin=function(relation){$modal.confirm({title:"确认操作",message:"你确定要拒绝此机构吗？",info:"确定要拒绝吗？拒绝后再次加入需主动申请",button:{confirm:"确定",cancel:"放弃"},onsubmit:function(){CommonProvider.promise({model:OrganizationModel,method:"putRelation",params:{role:"user",id:relation.relation.id,organization_role:"teacher",body:{status:-1}},success:function(_teacher){$modal.success({message:"操作成功"}),$scope.all_schools.find(relation.type,"type").relations.result.find(relation.relation).status=-1}})}})},$scope.getOrganizationInfo=function(){CommonProvider.promise({model:OrganizationModel,method:"item",params:{organization_id:$scope.organization_id},success:function(organization){$scope.organization.info=organization.result,$scope.organization.audit=$scope.organization.info.audit_info}})},$scope.updateOrganizationInfo=function(){CommonProvider.promise({model:OrganizationModel,method:"put",params:{role:"user","new":$scope.organization.info},success:function(organization){$scope.organization.info=organization.result,$scope.organization.info_can_edit=!1,$modal.success({message:"更新成功"}),$rootScope.toTop()},error:function(err){console.log(err)}})},$scope.getLogoUpload=function(data){data&&($scope.organization.info.logo=data.key)},$scope.getSceneryUpload=function(data){data&&($scope.organization.info.scenery=data.key)},$scope.getLicenseUpload=function(data){data&&($scope.organization.audit.business_license=data.key)},$scope.getIdCardUpload=function(data){data&&($scope.organization.audit.id_card=data.key)},$scope.getQualificationUpload=function(data){data&&($scope.organization.audit.education_qualification=data.key)},$scope.getOrganizationAudit=function(){CommonProvider.promise({model:AuditModel,method:"get",params:{role:"teacher",organization_id:$scope.organization_id},success:function(audit){$scope.organization.audit=audit.result},error:function(err){}})},$scope.updateOrganizationAudit=function(callback){CommonProvider.promise({model:AuditModel,method:"put",params:{role:"user",organization_id:$scope.organization_id,body:callback?$scope.organization:$scope.organization.audit},success:function(audit){return callback?(callback(audit),!1):($scope.organization.audit=audit.result,$scope.organization.audit.status=0,$scope.organization.audit_can_edit=!1,$modal.success({message:"提交成功"}),void $rootScope.toTop())},error:function(err){console.log(err)}})},$scope.initOrganizationTeachers=function(){$scope.organization.teacher.types=[{name:"全部",sort:0},{name:"管理员",status:"4",sort:1},{name:"普通老师",status:"2,3",sort:2},{name:"待审核",status:"1",from:"2",sort:3},{name:"我已拒绝",status:"-2",from:"2",sort:4},{name:"已邀请",status:"0",sort:5},{name:"邀请失败",status:"-1",from:"1",sort:6}],$scope.organization.teacher.act_get=$scope.organization.teacher.types[0],$scope.getOrganizationTeachers($scope.organization.teacher.act_get)},$scope.getOrganizationTeachers=function(params){$scope.organization.teacher.act_get=params;var get_config={per_page:8,role:"teacher",organization_role:"admin",page:params.page||1,organization_id:$scope.organization_id};params.from&&(get_config.form=params.from),void 0!=params.status&&(get_config.status=params.status),CommonProvider.promise({model:OrganizationModel,method:"relation",params:get_config,success:function(teachers){$scope.organization.teacher.lists=teachers},error:function(err){console.log(err)}})},$scope.refreshOrganizationTeachers=function(){$scope.getOrganizationTeachers({sort:$scope.organization.teacher.act_get.sort,form:$scope.organization.teacher.act_get.form,status:$scope.organization.teacher.act_get.status,page:$scope.organization.teacher.lists.pagination.current_page})},$scope.checkTeacherInfo=function(params){params.modal?($rootScope.organization=$scope.organization,$rootScope.teacher_local=params.teacher,$rootScope.teacher_check=angular.copy(params.teacher.$parent.teacher),$modal.custom({title:"查看资料",template_url:"/partials/home/teacher/organization/teacher-check.html",callback:function(){$rootScope.teacher_check=null,delete $rootScope.organization,delete $rootScope.teacher_local}})):CommonProvider.promise({model:OrganizationModel,method:"putRelation",params:{role:"user",id:$rootScope.teacher_check.id,organization_role:$rootScope.organization.info.user.id==$rootScope.user.id?"founder":"admin",body:{status:params.action?2:-2,memo:params.action?"":$rootScope.teacher_check.memo||""}},success:function(_teacher){$rootScope.teacher_local.$parent.teacher.status=params.action?2:-2,$rootScope.teacher_local.$parent.teacher.memo=$rootScope.teacher_check.memo,$rootScope.modal.close()}})},$scope.editTeacherInfo=function(params){params.modal?($rootScope.organization=$scope.organization,$rootScope.teacher_local=params.teacher,$rootScope.teacher_edit=angular.copy(params.teacher.$parent.teacher),$modal.custom({title:"查看资料",template_url:"/partials/home/teacher/organization/teacher-edit.html",callback:function(){$rootScope.teacher_edit=null,delete $rootScope.organization,delete $rootScope.teacher_local}})):CommonProvider.promise({model:OrganizationModel,method:"putRelation",params:{role:"user",id:$rootScope.teacher_edit.id,organization_role:$rootScope.organization.info.user.id==$rootScope.user.id?"founder":"admin",body:{title:$rootScope.teacher_edit.title,introduction:$rootScope.teacher_edit.introduction}},success:function(teacher){$rootScope.teacher_local.$parent.teacher=teacher.result,$rootScope.modal.close()}})},$scope.addTeacherAdmin=function(teacher){$modal.confirm({title:"确认操作",message:"你确定要设置“"+teacher.user.rel_name+"”为管理员吗？",info:"设置后“"+teacher.user.rel_name+"”即拥有操作普通老师的权限",button:{confirm:"确定",cancel:"取消"},onsubmit:function(){CommonProvider.promise({model:OrganizationModel,method:"putRelation",params:{role:"user",id:teacher.id,organization_role:$scope.organization.info.user.id==$rootScope.user.id?"founder":"admin",body:{status:4}},success:function(_teacher){$scope.organization.teacher.lists.result.find(teacher).status=4}})}})},$scope.delTeacherAdmin=function(teacher){$modal.confirm({title:"确认操作",message:"你确定要取消“"+teacher.user.rel_name+"”管理员吗？",info:"取消后“"+teacher.user.rel_name+"”将仅拥有普通老师的身份",button:{confirm:"确定",cancel:"取消"},onsubmit:function(){CommonProvider.promise({model:OrganizationModel,method:"putRelation",params:{role:"user",id:teacher.id,organization_role:$scope.organization.info.user.id==$rootScope.user.id?"founder":"admin",body:{status:2}},success:function(_teacher){$scope.organization.teacher.lists.result.find(teacher).status=2}})}})},$scope.attornFounder=function(teacher){$modal.confirm({title:"确认操作",message:"确定要转让身份吗？",info:"确定要转让创始人给“"+teacher.user.rel_name+"”吗？转让后您将成为普通老师（无管理权限），且无法回退操作",button:{confirm:"确定",cancel:"放弃"},onsubmit:function(){CommonProvider.promise({model:OrganizationModel,method:"putRelation",params:{role:"user",id:teacher.id,organization_role:$scope.organization.info.user.id==$rootScope.user.id?"founder":"admin",body:{status:5}},success:function(_teacher){$scope.getOrganizationInfo(),$scope.refreshOrganizationTeachers()}})}})},$scope.delTeacher=function(teacher){$modal.confirm({title:"确认操作",message:"你确定要删除老师吗？",info:"你确定要删除老师"+teacher.user.rel_name+"吗？删除后老师即不再与本机构有任何关系",button:{confirm:"确定",cancel:"放弃"},onsubmit:function(){CommonProvider.promise({model:OrganizationModel,method:"delRelation",params:{role:"user",relation_id:teacher.id,organization_role:$scope.organization.info.user.id==$rootScope.user.id?"founder":"admin"},success:function(_teacher){$scope.refreshOrganizationTeachers()}})}})},$scope.inviteTeacher=function(params){params.modal?($rootScope.organization=$scope.organization,$modal.custom({title:"邀请老师",template_url:"/partials/home/teacher/organization/teacher-invite.html",callback:function(){$rootScope.organization=null}})):CommonProvider.promise({model:OrganizationModel,method:"addRelation",params:{type:"invite",body:{organization_id:$scope.organization_id,phone:params.phone}},success:function(_teacher){$rootScope.modal.close(),$modal.success({message:"邀请成功"})},error:function(result){$rootScope.modal.close(),$modal.error({message:result.message})}})},$scope.againInviteTeacher=function(teacher){$modal.confirm({title:"确认操作",message:"确定要邀请老师"+teacher.user.rel_name+"吗？",button:{confirm:"确定",cancel:"放弃"},onsubmit:function(){CommonProvider.promise({model:OrganizationModel,method:"putRelation",params:{role:"user",id:teacher.id,organization_role:$scope.organization.info.user.id==$rootScope.user.id?"founder":"admin",body:{status:0}},success:function(_teacher){$scope.organization.teacher.lists.result.find(teacher).status=0}})}})},$scope.getAnnouncement=function(params){CommonProvider.promise({model:AnnouncementModel,method:"get",params:{role:"teacher",organization_id:$scope.organization_id,type:1,per_page:12,page:params.page||1},success:function(announcements){$rootScope.toTop(),$scope.organization.announcements=announcements}})},$scope.delAnnouncement=function(announcement){$modal.confirm({title:"确认操作",message:"你确定要删除公告吗？",info:"你确定要删除公告“"+announcement.title+"”吗？删除后不可恢复",button:{confirm:"确定",cancel:"放弃"},onsubmit:function(){CommonProvider.promise({model:AnnouncementModel,method:"del",params:{role:"user",announcement_id:announcement.id},success:function(announcements){$scope.organization.announcements.result.remove(announcement),$scope.organization.announcements.pagination.total-=1}})}})},$scope.editAnnouncement=function(params){params.modal?($rootScope.announcement_local=params.announcement,$rootScope.announcement_edit=angular.copy(params.announcement.announcement),$modal.custom({title:"编辑公告",template_url:"/partials/home/teacher/organization/announcement-edit.html",callback:function(){$rootScope.announcement_edit=null,delete $rootScope.announcement_local}})):CommonProvider.promise({model:AnnouncementModel,method:"put",params:{role:"user",body:$rootScope.announcement_edit},success:function(_announcement){$rootScope.announcement_local.announcement=_announcement.result,$rootScope.modal.close(),$modal.success({message:"更新成功"})}})},$scope.addAnnouncement=function(params){params.modal?($rootScope.organization=$scope.organization,$rootScope.announcement_edit={},$modal.custom({title:"编辑公告",template_url:"/partials/home/teacher/organization/announcement-edit.html",callback:function(){$rootScope.announcement_edit=null,delete $rootScope.organization}})):CommonProvider.promise({model:AnnouncementModel,method:"add",params:{role:"user",body:{organization_id:$scope.organization_id,type:1,title:$rootScope.announcement_edit.title,content:$rootScope.announcement_edit.content}},success:function(_announcement){$rootScope.organization.announcements.result.unshift(_announcement.result),$rootScope.organization.announcements.pagination.total+=1,$rootScope.modal.close(),$modal.success({message:"添加成功"})}})},$scope.getThemeTemplate=function(){$rootScope.getConfig({name:"ORGANIZATION_THEME",success:function(theme){$scope.organization.theme=theme.result}})},$scope.setThemeTemplate=function(){CommonProvider.promise({model:OrganizationModel,method:"putProfile",params:{role:"user",organization_id:$scope.organization_id,body:{index_template:$scope.organization.info.profile.index_template,big_banner:$scope.organization.info.profile.big_banner,is_blur:Number($scope.organization.info.profile.is_blur)||0}},success:function(_theme){$modal.success({message:"更新成功"})}})},$scope.getBigBannerUpload=function(data){data&&($scope.organization.info.profile.big_banner=data.key)},$scope.initCreateOrganization=function(){$scope.createOrganization={},$scope.createOrganization.step={is_read:!1,is_agree:!1,is_submit:!1,can_audit:1,is_audit:!1,current:1,success:!1},$scope.getLicense(),$scope.getOrganizationCate()},$scope.getOrganizationCate=function(){CommonProvider.promise({model:CategoryModel,method:"get",params:{role:"student",type:2},success:function(cates){$scope.createOrganization.cates=cates.result}})},$scope.changeOrganizationCate=function(){var current_cate=$scope.createOrganization.cates.find($scope.organization.category_id,"id");$scope.createOrganization.step.can_audit=current_cate.can_audit,current_cate.can_audit||($scope.createOrganization.step.is_audit=!1)},$scope.getLicense=function(){$rootScope.getConfig({name:"CREATE_ORGANIZATION_LICENSE",success:function(license){$scope.createOrganization.license=license.result.value}})},$scope.createOrganizationNext=function(){var current_step=$scope.createOrganization.step.current;1==current_step&&($scope.organization.url="http://",$scope.createOrganization.step.current=2,$scope.createOrganization.step.is_agree=!0),2==current_step&&$scope.postOrganization()},$scope.addLogoUpload=function(data){data&&($scope.organization.logo=data.key)},$scope.addSceneryUpload=function(data){data&&($scope.organization.scenery=data.key)},$scope.addLicenseUpload=function(data){data&&($scope.organization.business_license=data.key)},$scope.addIdCardUpload=function(data){data&&($scope.organization.id_card=data.key)},$scope.addIdentityUpload=function(data){data&&($scope.organization.id_card=data.key)},$scope.addQualificationUpload=function(data){data&&($scope.organization.education_qualification=data.key)},$scope.checkNameValid=function(name){return name?void CommonProvider.promise({model:SearchModel,method:"get",params:{keyword:name,detail:1,only_name:1,search_type:"organization",per_page:200,page:1},success:function(organizations){var orgs=organizations.result;orgs.length||($scope.organization.name_is_valid=!0),orgs.length&&($scope.organization.name_is_valid=!0,orgs.forEach(function(org){name==org.name&&($scope.organization.name_is_valid=!1)}))}}):!1},$scope.postOrganization=function(){CommonProvider.promise({model:OrganizationModel,method:"add",params:$scope.organization,success:function(organization){$scope.organization_id=organization.result.id;var success=function(){$scope.createOrganization.step.is_submit=!0,$scope.createOrganization.step.current=3,$rootScope.toTop()};$scope.createOrganization.step.is_audit?$scope.updateOrganizationAudit(function(){success()}):success()},result:function(res){0==res.code&&$modal.error({message:err.message})}})},$scope.searchBoxInit=function(){$scope.organization.keyword="",$scope.organization.lists={}},$scope.searchFormat=function(keyword){$scope.organization.keyword=null==keyword?"":keyword.replace(/[^\u4E00-\u9FA5\uf900-\ufa2d]/g,"").replace(/\s+/g,"").replace(/(^\s+)|(\s+$)/g,"")},$scope.searchSuggest=function(keyword){return CommonProvider.request({method:"get",service:new SearchService,params:{keyword:keyword,only_name:1,search_type:"organization"}}).then(function(res){return res.result})},$scope.searchOrganiztion=function(params){return $scope.organization.keyword?void CommonProvider.promise({model:SearchModel,method:"get",params:{keyword:$scope.organization.keyword,only_name:1,search_type:"organization",per_page:8,page:params.page||1},success:function(orgs){$scope.organization.lists=orgs}}):!1},$scope.joinOrganizationInit=function(){$scope.teacher||($scope.teacher={}),$scope.getOrganizationInfo(),AuthProvider.init(function(user){$scope.teacher.rel_name=user.profile.rel_name,$scope.teacher.phone=user.phone,$scope.teacher.id_card_pic=user.profile.id_card_pic})},$scope.getIdentityUpload=function(data){data&&($scope.teacher.id_card_pic=data.key),CommonProvider.promise({model:StudentModel,method:"put",params:{id_card_pic:$scope.teacher.id_card_pic},success:function(user){$rootScope.user.profile.id_card_pic=$scope.teacher.id_card_pic,$localStorage.user.profile.id_card_pic=$scope.teacher.id_card_pic}})},$scope.joinOrganization=function(){CommonProvider.promise({model:OrganizationModel,method:"addRelation",params:{type:"apply",body:{organization_id:$scope.organization_id,phone:$scope.teacher.phone,title:$scope.teacher.title,introduction:$scope.teacher.introduction,status:1}},success:function(_teacher){$modal.success({message:"申请成功"}),$location.path("teacher/organization/list").search({tab:3})},error:function(result){$modal.error({message:result.message})}})}}]),angular.module("AdvertiseService",[]).service("AdvertiseService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/advertise",{},{item:{method:"GET",url:appConfig.apiUrl+"/advertise/:advertise_id"},del:{method:"DELETE",url:appConfig.apiUrl+"/advertise/:advertise_id"},put:{method:"PUT",url:appConfig.apiUrl+"/advertise/:advertise_id"}})}]),angular.module("AnnouncementService",[]).service("AnnouncementService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/announcement",{},{put:{method:"PUT",url:appConfig.apiUrl+"/announcement/:announcement_id"},del:{method:"DELETE",url:appConfig.apiUrl+"/announcement/:announcement_id"}})}]),angular.module("ArticleService",[]).service("ArticleService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/article",{},{item:{method:"GET",url:appConfig.apiUrl+"/article/:article_id"},put:{method:"PUT",url:appConfig.apiUrl+"/article/:article_id"},search:{method:"GET",url:appConfig.apiUrl+"/article/search"},disable:{method:"PUT",url:appConfig.apiUrl+"/article/disable"},enable:{method:"PUT",url:appConfig.apiUrl+"/article/enable"}})}]),angular.module("AuditService",[]).service("AuditService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/organization/audit_infos",{},{put:{method:"PUT",url:appConfig.apiUrl+"/organization/:organization_id/audit_info"},item:{method:"GET",url:appConfig.apiUrl+"/organization/:organization_id/audit_info"},put:{method:"PUT",url:appConfig.apiUrl+"/organization/:organization_id/audit_info"}})}]),angular.module("AuthService",[]).service("AuthService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/account/login",{},{login:{method:"POST",url:appConfig.apiUrl+"/account/login"},logout:{method:"GET",url:appConfig.apiUrl+"/account/logout"},register:{method:"POST",url:appConfig.apiUrl+"/account/register"},forgot:{method:"PUT",url:appConfig.apiUrl+"/account/password/forget"},reset:{method:"PUT",url:appConfig.apiUrl+"/account/password/reset"},check:{method:"GET",url:appConfig.apiUrl+"/account/probe_login"},menu:{method:"GET",url:appConfig.apiUrl+"/account/menu"},getThirds:{method:"GET",url:appConfig.apiUrl+"/account/social"},thirdLogin:{method:"GET",url:appConfig.apiUrl+"/account/social/login/:type"},thirdBind:{method:"POST",url:appConfig.apiUrl+"/account/social/:type"},thirdUnbind:{method:"DELETE",url:appConfig.apiUrl+"/account/social/:id"}})}]),angular.module("BankService",[]).service("BankService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/bank_account",{},{del:{method:"DELETE",url:appConfig.apiUrl+"/bank_account/:bank_id"},getInfo:{method:"GET",url:appConfig.apiUrl+"/card_info"}})}]),angular.module("CategoryService",[]).service("CategoryService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/category",{per_page:"@per_page",page:"@page"},{getChildrens:{method:"GET",url:appConfig.apiUrl+"/category/:category_id"},put:{method:"PUT",url:appConfig.apiUrl+"/category/:category_id"},del:{method:"DELETE",url:appConfig.apiUrl+"/category/:category_id"},disable:{method:"PUT",url:appConfig.apiUrl+"/category/disable"},enable:{method:"PUT",url:appConfig.apiUrl+"/category/enable"},sort:{method:"PUT",url:appConfig.apiUrl+"/category"}})}]),angular.module("ChatService",[]).service("ChatService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/chat/record/:section_id",{},{})}]),angular.module("CommentService",[]).service("CommentService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/course_comment",{},{del:{method:"DELETE",url:appConfig.apiUrl+"/course_comment/:comment_id"}})}]),angular.module("CommonService",[]).service("CommonService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/",{},{sms:{method:"GET",url:appConfig.apiUrl+"/sms/verify_code/:rule/:phone"},area:{method:"GET",url:appConfig.apiUrl+"/area"},config:{method:"GET",url:appConfig.apiUrl+"/config"},configByName:{method:"GET",url:appConfig.apiUrl+"/config/name/:name"}})}]),angular.module("ConfigService",[]).service("SystemService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/config",{},{putGroup:{method:"PUT",url:appConfig.apiUrl+"/config"},putItem:{method:"PUT",url:appConfig.apiUrl+"/config/:config_id"},del:{method:"DELETE",url:appConfig.apiUrl+"/config/:config_id"}})}]).service("LogService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/log",{},{clear:{method:"DELETE",url:appConfig.apiUrl+"/log/all"}})}]),angular.module("CourseService",[]).service("CourseService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/course",{per_page:"@per_page",page:"@page"},{getUsersInfo:{method:"POST",url:appConfig.apiUrl+"/user/info"},item:{method:"GET",url:appConfig.apiUrl+"/course/:course_id"},search:{method:"GET",url:appConfig.apiUrl+"/course/search/"},del:{method:"DELETE",url:appConfig.apiUrl+"/course/:course_id"},put:{method:"PUT",url:appConfig.apiUrl+"/course/:course_id"},disable:{method:"PUT",url:appConfig.apiUrl+"/course/disable"},enable:{method:"PUT",url:appConfig.apiUrl+"/course/enable"},others:{method:"GET",url:appConfig.apiUrl+"/course/:course_id/others"},classmates:{method:"GET",url:appConfig.apiUrl+"/course/:course_id/classmates"},relation:{method:"GET",url:appConfig.apiUrl+"/course/:course_id/with/user"},operation:{method:"POST",url:appConfig.apiUrl+"/course/:course_id/operation"}})}]),angular.module("FavoriteService",[]).service("FavoriteService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/favorite/:type/:target_id",{},{get:{method:"GET",url:appConfig.apiUrl+"/favorite/:type"},getStatus:{method:"GET",url:appConfig.apiUrl+"/favorite/:type/status"}})}]),angular.module("FeedbackService",[]).service("FeedbackService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/feedback",{},{item:{method:"GET",url:appConfig.apiUrl+"/feedback/:feedback_id"},put:{method:"PUT",url:appConfig.apiUrl+"/feedback/:feedback_id"},del:{method:"DELETE",url:appConfig.apiUrl+"/feedback/:feedback_id"}})}]),angular.module("FileService",[]).service("FileService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/file/:type",{type:"@type"},{getFileUptoken:{method:"GET",params:{token:"@token"},url:appConfig.apiUrl+"/file/file_uptoken"},getVideoUptoken:{method:"GET",params:{token:"@token"},url:appConfig.apiUrl+"/file/video_uptoken/:key"}})}]),angular.module("IndexService",[]).service("IndexService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/index",{},{partners:{method:"GET",url:appConfig.apiUrl+"/partner"},put:{method:"PUT",url:appConfig.apiUrl+"/index/:config_id"}})}]),angular.module("LinkService",[]).service("LinkService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/link",{},{item:{method:"GET",url:appConfig.apiUrl+"/link/:link_id"},put:{method:"PUT",url:appConfig.apiUrl+"/link/:link_id"},del:{method:"DELETE",url:appConfig.apiUrl+"/link/:link_id"}})}]),angular.module("MsgService",[]).service("MsgService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/message",{per_page:"@per_page",page:"@page"},{batch:{method:"PUT",url:appConfig.apiUrl+"/message/:act_type"}})}]),angular.module("NoteService",[]).service("NoteService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/note",{},{item:{method:"GET",url:appConfig.apiUrl+"/note/:note_id"},search:{method:"GET",url:appConfig.apiUrl+"/note/search"},del:{method:"DELETE",url:appConfig.apiUrl+"/note/:note_id"},put:{method:"PUT",url:appConfig.apiUrl+"/note/:note_id"}})}]),angular.module("OrganizationService",[]).service("OrganizationService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/organization",{per_page:"@per_page",page:"@page"},{relation:{method:"GET",url:appConfig.apiUrl+"/organization_user"},itemRelation:{method:"GET",url:appConfig.apiUrl+"/organization_user/:relation_id"},addRelation:{method:"POST",url:appConfig.apiUrl+"/organization_user"},putRelation:{method:"PUT",url:appConfig.apiUrl+"/organization_user/:relation_id"},delRelation:{method:"DELETE",url:appConfig.apiUrl+"/organization_user/:relation_id"},item:{method:"GET",url:appConfig.apiUrl+"/organization/:organization_id"},search:{method:"GET",url:appConfig.apiUrl+"/organization/search"},getProfile:{method:"GET",url:appConfig.apiUrl+"/organization/:organization_id/profile"},putProfile:{method:"PUT",url:appConfig.apiUrl+"/organization/:organization_id/profile"},put:{method:"PUT",url:appConfig.apiUrl+"/organization/:organization_id"},del:{method:"DELETE",url:appConfig.apiUrl+"/organization/:organization_id"}})}]),angular.module("PartnerService",[]).service("PartnerService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/partner",{},{put:{method:"PUT",url:appConfig.apiUrl+"/partner/:partner_id"},del:{method:"DELETE",url:appConfig.apiUrl+"/partner/:partner_id"}})}]),angular.module("PaymentService",[]).service("PaymentService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/payment",{},{pay:{method:"POST",url:appConfig.apiUrl+"/payment"},getStatus:{method:"GET",url:appConfig.apiUrl+"/payment/:payment_id"},payment:{method:"PUT",url:appConfig.apiUrl+"/payment/:payment_id"},item:{method:"GET",url:appConfig.apiUrl+"/payment/:payment_id"},del:{method:"DELETE",url:appConfig.apiUrl+"/payment/:payment_id"}})}]),angular.module("PublicService",[]).service("PublicService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/",{},{clearcache:{method:"DELETE",url:appConfig.apiUrl+"/cache/:tag"}})}]),angular.module("QuestionService",[]).service("QuestionService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/question",{},{item:{method:"GET",url:appConfig.apiUrl+"/question/:question_id"},search:{method:"GET",url:appConfig.apiUrl+"/question/search"},del:{method:"DELETE",url:appConfig.apiUrl+"/question/:question_id"},put:{method:"PUT",url:appConfig.apiUrl+"/question/:question_id"}})}]),angular.module("ScoreService",[]).service("ScoreService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/score",{},{getLevels:{method:"GET",url:appConfig.apiUrl+"/score_level"},getRules:{method:"GET",url:appConfig.apiUrl+"/score_rule"}})}]),angular.module("SearchService",[]).service("SearchService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/search/:search_type",{key:"@search_type"},{get:{method:"GET",params:{page:"@page",detail:"@detail",keyword:"@keyword",per_page:"@per_page",category_id:"@category_id",sort_id:"@sort_id",labels:"@labels"},headers:{"Content-Type":"application/x-www-form-encoded;charset=UTF-8"}},getHotWords:{method:"GET",url:appConfig.apiUrl+"/search/hot"},putHotWords:{method:"PUT",url:appConfig.apiUrl+"/search/hot"},searchInit:{method:"GET",url:appConfig.apiUrl+"/search/:type/init"},searchClean:{method:"GET",url:appConfig.apiUrl+"/search/:type/clean"}})}]),angular.module("SectionService",[]).service("SectionService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/section",{},{update:{method:"PUT",url:appConfig.apiUrl+"/section"},item:{method:"GET",url:appConfig.apiUrl+"/section/:section_id"},put:{method:"PUT",url:appConfig.apiUrl+"/section/:section_id"},del:{method:"DELETE",url:appConfig.apiUrl+"/section/:section_id"},postStudyRecord:{
method:"POST",url:appConfig.apiUrl+"/section/:section_id/study_record"},getVideos:{method:"GET",url:appConfig.apiUrl+"/section/:section_id/videos"},getQuestions:{method:"GET",url:appConfig.apiUrl+"/section/:section_id/questions"},initLiveSection:{method:"GET",url:appConfig.apiUrl+"/section/:section_id/live_init"},closeLiveSection:{method:"GET",url:appConfig.apiUrl+"/section/:section_id/live_finish"},getLiveUpstream:{method:"GET",url:appConfig.apiUrl+"/section/:section_id/live_upstream"}})}]),angular.module("SmsService",[]).service("SmsService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/sms",{},{item:{method:"GET",url:appConfig.apiUrl+"/sms/:sms_id"},del:{method:"DELETE",url:appConfig.apiUrl+"/sms/:sms_id"}})}]),angular.module("StudentService",[]).service("StudentService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/user/:target_type",{},{put:{method:"PUT",url:appConfig.apiUrl+"/account/info"}})}]),angular.module("TeacherService",[]).service("TeacherService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/teacher/:target_type",{},{incomeDetail:{method:"GET",url:appConfig.apiUrl+"/teacher/income/detail"},incomeDaily:{method:"GET",url:appConfig.apiUrl+"/teacher/income/daily"}})}]),angular.module("TradeService",[]).service("TradeService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/trade",{per_page:"@per_page",page:"@page"},{item:{method:"GET",url:appConfig.apiUrl+"/trade/:trade_id"},search:{method:"GET",url:appConfig.apiUrl+"/trade/search"},cancel:{method:"PUT",url:appConfig.apiUrl+"/trade/:trade_id/cancel"},del:{method:"DELETE",url:appConfig.apiUrl+"/trade/:trade_id"}})}]),angular.module("WithdrawService",[]).service("WithdrawService",["$resource","appConfig",function($resource,appConfig){return $resource(appConfig.apiUrl+"/withdraw",{per_page:"@per_page",page:"@page"},{item:{method:"GET",url:appConfig.apiUrl+"/withdraw/:withdraw_id"},cancel:{method:"PUT",url:appConfig.apiUrl+"/withdraw/:withdraw_id/cancel"},put:{method:"PUT",url:appConfig.apiUrl+"/withdraw/:withdraw_id"},del:{method:"DELETE",url:appConfig.apiUrl+"/withdraw/:withdraw_id"}})}]),angular.module("AdvertiseModel",["AdvertiseService"]).factory("AdvertiseModel",["AdvertiseService","CommonProvider",function(AdvertiseService,CommonProvider){var _advertise_list,_advertise_item,_advertise_model={};return _advertise_model={get:function(params){return params.page=params.page||1,params.per_page=params.per_page||20,CommonProvider.request({method:"get",service:new AdvertiseService,params:params,success:function(advertise_lists){_advertise_list=advertise_lists}})},item:function(params){return CommonProvider.request({method:"item",service:new AdvertiseService,params:params,success:function(advertise_item){_advertise_item=advertise_item}})},add:function(advertise){return CommonProvider.request({method:"save",service:new AdvertiseService(advertise)})},put:function(advertise){return CommonProvider.request({method:"put",service:new AdvertiseService(advertise),params:{advertise_id:advertise.id},success:function(_advertise){return _advertise}})},del:function(advertise){return CommonProvider.request({method:"del",service:new AdvertiseService,params:{advertise_id:advertise.id},success:function(_advertise){_advertise_list.result.remove(advertise),_advertise_list.pagination.total-=1}})}}}]),angular.module("AnnouncementModel",["AnnouncementService"]).factory("AnnouncementModel",["AnnouncementService","CommonProvider",function(AnnouncementService,CommonProvider){var _announcement_list,_announcement_model={get:function(params){return CommonProvider.request({method:"get",service:new AnnouncementService,params:params,success:function(announcement_list){_announcement_list=announcement_list}})},del:function(params){return CommonProvider.request({method:"del",service:new AnnouncementService,params:params,success:function(_announcement){var remove_item=_announcement_list.result.find(params.announcement_id,"id");_announcement_list.result.remove(remove_item),_announcement_list.pagination.total-=1}})},"delete":function(ids){return CommonProvider.request({method:"delete",service:new AnnouncementService,params:{ids:ids.join(",")},success:function(_feedback){_announcement_model.get({page:_announcement_list.pagination.current_page})}})},put:function(params){return CommonProvider.request({method:"put",service:new AnnouncementService(params.body),params:{role:params.role,announcement_id:params.body.id}})},add:function(params){return CommonProvider.request({method:"save",service:new AnnouncementService(params.body),params:{role:params.role}})}};return _announcement_model}]),angular.module("ArticleModel",["ArticleService"]).factory("ArticleModel",["ArticleService","CommonProvider",function(ArticleService,CommonProvider){var _article_list,_article={},_article_model={};return _article_model={get:function(params){return params.page=params.page||1,params.per_page=params.per_page||20,CommonProvider.request({method:"get",service:new ArticleService,params:params,success:function(_article_lists){_article_list=_article_lists}})},add:function(article){return CommonProvider.request({method:"save",service:new ArticleService(article)})},item:function(params){return CommonProvider.request({method:"item",service:new ArticleService,params:params,success:function(_article_item){_article.info=_article_item}})},put:function(article){return CommonProvider.request({method:"put",service:new ArticleService(article),params:{article_id:article.id},success:function(_article){return _article}})},del:function(article){return CommonProvider.request({method:"del",service:new ArticleService,params:{article_id:article.article.id},success:function(_article){_article_list.result.remove(article.article),_article_list.pagination.total-=1}})},disable:function(params){var ids=params.length?params.join(","):params.article.id;return CommonProvider.request({method:"disable",service:new ArticleService({ids:ids}),success:function(_article){params.length?_article_model.get({page:_article_list.pagination.current_page}):params.article.x_status=0}})},enable:function(params){var ids=params.length?params.join(","):params.article.id;return CommonProvider.request({method:"enable",service:new ArticleService({ids:ids}),success:function(_article){params.length?_article_model.get({page:_article_list.pagination.current_page}):params.article.x_status=1}})}}}]),angular.module("AuditModel",["AuditService"]).factory("AuditModel",["AuditService","CommonProvider",function(AuditService,CommonProvider){var _audit_model={get:function(params){return CommonProvider.request({method:"get",service:new AuditService,params:params})},item:function(params){return CommonProvider.request({method:"item",service:new AuditService,params:params})},put:function(audit){return CommonProvider.request({method:"put",service:new AuditService(audit.body),params:{role:audit.role,organization_id:audit.organization_id}})}};return _audit_model}]),angular.module("AuthModel",["AuthService"]).factory("AuthModel",["AuthService","CommonProvider","$localStorage",function(AuthService,CommonProvider,$localStorage){var _auth_model={login:function(user){return CommonProvider.request({method:"login",service:new AuthService(user)})},logout:function(user){return CommonProvider.request({method:"logout",service:new AuthService})},register:function(user){return CommonProvider.request({method:"register",service:new AuthService(user)})},forgot:function(user){return CommonProvider.request({method:"forgot",service:new AuthService(user)})},check:function(){return CommonProvider.request({method:"check",service:new AuthService,error:function(err){401==err.status&&(delete $localStorage.user,delete $localStorage.token)}})},menu:function(){return CommonProvider.request({method:"menu",service:new AuthService})},reset:function(password){return CommonProvider.request({method:"reset",service:new AuthService(password)})},getThirds:function(){return CommonProvider.request({method:"getThirds",service:new AuthService})},thirdLogin:function(params){return CommonProvider.request({method:"thirdLogin",service:new AuthService,params:params})},thirdBind:function(params){return CommonProvider.request({method:"thirdBind",service:new AuthService(params.body),params:{type:params.type}})},thirdUnbind:function(params){return CommonProvider.request({method:"thirdUnbind",service:new AuthService,params:params})}};return _auth_model}]),angular.module("BankModel",["BankService"]).factory("BankModel",["BankService","CommonProvider",function(BankService,CommonProvider){var _bank_lists,_bank_model={get:function(params){return CommonProvider.request({method:"get",service:new BankService,params:params,success:function(_banks){_bank_lists=_banks}})},add:function(bank){return CommonProvider.request({method:"save",service:new BankService(bank)})},del:function(params){return CommonProvider.request({method:"del",service:new BankService,params:params})},getInfo:function(params){return CommonProvider.request({method:"getInfo",service:new BankService,params:params})}};return _bank_model}]),angular.module("CategoryModel",["CategoryService"]).factory("CategoryModel",["CategoryService","CommonProvider",function(CategoryService,CommonProvider){var _category_list,_category_model={},_category_service=new CategoryService;return _category_model={get:function(params){return params.page=params.page||1,params.per_page=params.per_page||20,CommonProvider.request({method:"get",service:new CategoryService,params:params,success:function(_lists){_category_list=_lists}})},childrens:function(params){return params.category_id=params.category_id||0,params.children=params.children||1,params.crumbs=params.crumbs||1,CommonProvider.request({method:"getChildrens",service:_category_service,params:params,success:function(_lists){_category_list=_lists}})},add:function(category){return CommonProvider.request({method:"save",service:new CategoryService(category),success:function(_category){_category_model.childrens({category_id:_category_list.result.id})}})},put:function(category){return CommonProvider.request({method:"put",service:new CategoryService(category["new"]),params:{category_id:category["new"].id}})},del:function(category){return CommonProvider.request({method:"del",service:new CategoryService,params:{category_id:category.category.id},success:function(_category){_category_list.result.children.remove(category.category)}})},"delete":function(ids){return CommonProvider.request({method:"delete",service:new CategoryService,params:{ids:ids.join(",")},success:function(_category){_category_model.childrens({category_id:_category_list.result.id})}})},disable:function(params){var ids=params.length?params.join(","):params.category.id;return CommonProvider.request({method:"disable",service:new CategoryService({ids:ids}),success:function(_category){params.length?_category_model.childrens({category_id:_category_list.result.id}):params.category.x_status=0}})},enable:function(params){var ids=params.length?params.join(","):params.category.id;return CommonProvider.request({method:"enable",service:new CategoryService({ids:ids}),success:function(_category){params.length?_category_model.childrens({category_id:_category_list.result.id}):params.category.x_status=1}})},sort:function(params){return CommonProvider.request({method:"sort",service:new CategoryService,body:{data:params}})}}}]),angular.module("ChatModel",["ChatService"]).factory("ChatModel",["ChatService","CommonProvider",function(ChatService,CommonProvider){var _chat_model={message:function(params){return CommonProvider.request({method:"get",service:new ChatService,params:params})}};return _chat_model}]),angular.module("CommentModel",["CommentService"]).factory("CommentModel",["CommentService","CommonProvider",function(CommentService,CommonProvider){var _comment_list,_comment_model={};return _comment_model={get:function(config){return config.page=config.page||1,config.per_page=config.per_page||20,CommonProvider.request({method:"get",service:new CommentService,params:config,success:function(_comment_lists){_comment_list=_comment_lists}})},post:function(params){return CommonProvider.request({method:"save",service:new CommentService(params.body),params:{role:params.role}})},del:function(params){return CommonProvider.request({method:"del",service:new CommentService,params:params})}}}]),angular.module("CommonModel",["CommonService"]).factory("CommonModel",["CommonService","CommonProvider",function(CommonService,CommonProvider){return _common_model={sms:function(config){return CommonProvider.request({method:"sms",service:new CommonService,params:config})},area:function(){return CommonProvider.request({method:"area",service:new CommonService})},config:function(params){return CommonProvider.request({method:"config",service:new CommonService,params:params})},configByName:function(params){return CommonProvider.request({method:"configByName",service:new CommonService,params:params})}},_common_model}]),angular.module("ConfigModel",["ConfigService"]).factory("SystemModel",["SystemService","CommonProvider",function(SystemService,CommonProvider){var _system_list,_system_group={},_system_model={},_system_service=new SystemService;return _system_model.get=function(params){return CommonProvider.request({method:"get",service:_system_service,params:params,success:function(config_list){void 0!=params.group?_system_group[params.group]=config_list.result.toObject("name"):_system_list=config_list}})},_system_model.putGroup=function(groups){for(key in groups)"object"==typeof groups[key].value&&(groups[key].value=groups[key].value.toString());return CommonProvider.request({method:"putGroup",service:new SystemService({data:Obj.toArray(groups)})})},_system_model.add=function(config){return CommonProvider.request({method:"save",service:new SystemService(config),success:function(_config){_system_list.result.push(_config.result)}})},_system_model.put=function(config){return CommonProvider.request({method:"putItem",service:new SystemService(config["new"]),params:{config_id:config.old.config.id},success:function(_config){config.old.config=_config.result}})},_system_model.del=function(config){return CommonProvider.request({method:"del",service:new SystemService,params:{config_id:config.config.id},success:function(_config){_system_list.result.remove(config.config)}})},_system_model["delete"]=function(ids){return CommonProvider.request({method:"delete",service:_system_service,params:{ids:ids.join(",")},success:function(_config){_system_model.get({page:_system_list.pagination.current_page})}})},_system_model}]).factory("LogModel",["LogService","CommonProvider",function(LogService,CommonProvider){var _log_list,_log_model={},_log_service=new LogService;return _log_model.get=function(params){return CommonProvider.request({method:"get",params:params,service:_log_service,success:function(logs){_log_list=logs}})},_log_model.del=function(log){var ids=log.length?log.join(","):log.log.id;return CommonProvider.request({method:"delete",service:new LogService,params:{ids:ids},success:function(_log){log.length?_log_model.get({page:_log_list.pagination.current_page}):(_log_list.result.remove(log.log),_log_list.pagination.total-=1)}})},_log_model.clear=function(log){return CommonProvider.request({method:"clear",service:_log_service,success:function(_log){_log_list.result=[],_log_list.pagination.total=0}})},_log_model}]),angular.module("CourseModel",["CourseService"]).factory("CourseModel",["CourseService","CommonProvider",function(CourseService,CommonProvider){var _course_list,_course={},_course_model={},_course_service=new CourseService;return _course_model={getUsersInfo:function(params){return CommonProvider.request({method:"getUsersInfo",service:new CourseService({user_ids:params.user_ids})})},get:function(params){return params.page=params.page||1,params.per_page=params.per_page||20,CommonProvider.request({method:"get",service:new CourseService,params:params,success:function(_course_lists){_course_list=_course_lists}})},item:function(params){return CommonProvider.request({method:"item",service:_course_service,params:params,success:function(_course_item){_course.info=_course_item}})},put:function(course){return CommonProvider.request({method:"put",service:new CourseService(course["new"]),params:{course_id:course["new"].id},success:function(_course){return _course}})},add:function(course){return CommonProvider.request({method:"save",service:new CourseService(course),success:function(_course){return _course}})},del:function(course){return CommonProvider.request({method:"del",service:new CourseService,params:{course_id:course.course.id},success:function(_course){_course_list.result.remove(course.course),_course_list.pagination.total-=1}})},"delete":function(ids){return CommonProvider.request({method:"delete",service:new CourseService,params:{ids:ids.join(",")},success:function(_course){_course_model.get({page:_course_list.pagination.current_page})}})},disable:function(params){var ids=params.length?params.join(","):params.course.id;return CommonProvider.request({method:"disable",service:new CourseService({ids:ids}),success:function(_course){params.length?_course_model.get({page:_course_list.pagination.current_page}):params.course.x_status=0}})},enable:function(params){var ids=params.length?params.join(","):params.course.id;return CommonProvider.request({method:"enable",service:new CourseService({ids:ids}),success:function(_course){params.length?_course_model.get({page:_course_list.pagination.current_page}):params.course.x_status=1}})},relation:function(course_id){return CommonProvider.request({method:"relation",service:new CourseService,params:{course_id:course_id},success:function(_relation){_course.relation=_relation}})},others:function(params){return CommonProvider.request({method:"others",service:new CourseService,params:params,success:function(_others){_course.others=_others}})},classmates:function(params){return CommonProvider.request({method:"classmates",service:new CourseService,params:params,success:function(_classmates){_course.classmates=_classmates}})},operation:function(params){return CommonProvider.request({method:"operation",service:new CourseService,params:{method:params.method,course_id:params.course_id}})}}}]),angular.module("FavoriteModel",["FavoriteService"]).factory("FavoriteModel",["FavoriteService","CommonProvider",function(FavoriteService,CommonProvider){var _favorite_lists,_favorite_model={get:function(params){return CommonProvider.request({method:"get",service:new FavoriteService,params:params,success:function(_favorites){_favorite_lists=_favorites}})},getStatus:function(params){return CommonProvider.request({method:"getStatus",service:new FavoriteService,params:params})},add:function(config){return CommonProvider.request({method:"save",service:new FavoriteService,params:config})},del:function(params){return CommonProvider.request({method:"remove",service:new FavoriteService,params:params,success:function(){_favorite_lists.pagination.total-=1}})}};return _favorite_model}]),angular.module("FeedbackModel",["FeedbackService"]).factory("FeedbackModel",["FeedbackService","CommonProvider",function(FeedbackService,CommonProvider){var _feedback_list,_feedback_model={get:function(params){return CommonProvider.request({method:"get",service:new FeedbackService,params:params,success:function(feedback_list){_feedback_list=feedback_list}})},item:function(feedback){return CommonProvider.request({method:"item",service:new FeedbackService,params:feedback})},add:function(feedback){return CommonProvider.request({method:"save",service:new FeedbackService(feedback)})},put:function(feedback){return CommonProvider.request({method:"put",service:new FeedbackService(feedback),params:{feedback_id:feedback.id}})},del:function(feedback){return CommonProvider.request({method:"del",service:new FeedbackService,params:{feedback_id:feedback.feedback.id},success:function(_feedback){_feedback_list.result.remove(feedback.feedback),_feedback_list.pagination.total-=1}})},"delete":function(ids){return CommonProvider.request({method:"delete",service:new FeedbackService,params:{ids:ids.join(",")},success:function(_feedback){_feedback_model.get({page:_feedback_list.pagination.current_page})}})}};return _feedback_model}]),angular.module("IndexModel",["IndexService"]).factory("IndexModel",["IndexService","CommonProvider",function(IndexService,CommonProvider){return _index_model={get:function(params){return CommonProvider.request({method:"get",service:new IndexService,params:params})},partners:function(params){return CommonProvider.request({method:"partners",service:new IndexService,params:params})},put:function(config){return console.log(config),CommonProvider.request({method:"put",service:new IndexService(config),params:{config_id:config.id},success:function(_config){}})}},_index_model}]),angular.module("LinkModel",["LinkService"]).factory("LinkModel",["LinkService","CommonProvider",function(LinkService,CommonProvider){var _link_list,_link_model={get:function(params){return CommonProvider.request({method:"get",service:new LinkService,params:params,success:function(_links){_link_list=_links}})},add:function(link){return CommonProvider.request({method:"save",service:new LinkService(link),success:function(_link){_link_list.result.unshift(_link.result),_link_list.pagination.total+=1}})},put:function(link){return CommonProvider.request({method:"put",service:new LinkService(link),params:{link_id:link.id}})},del:function(link){return CommonProvider.request({method:"del",service:new LinkService,params:{link_id:link.link.id},success:function(_link){_link_list.result.remove(link.link),_link_list.pagination.total-=1}})},"delete":function(ids){return CommonProvider.request({method:"delete",service:new LinkService,params:{ids:ids.join(",")},success:function(_link){_link_model.get({page:_link_list.pagination.current_page})}})}};return _link_model}]),angular.module("MsgModel",["MsgService"]).factory("MsgModel",["MsgService","CommonProvider",function(MsgService,CommonProvider){var _msg_model={get:function(params){return CommonProvider.request({method:"get",service:new MsgService,params:params})},batch:function(params){return CommonProvider.request({method:"batch",service:new MsgService,params:params})}};return _msg_model}]),angular.module("NoteModel",["NoteService"]).factory("NoteModel",["NoteService","CommonProvider",function(NoteService,CommonProvider){var _note_list,_note_model={get:function(params){return params.page=params.page||1,params.per_page=params.per_page||20,CommonProvider.request({method:"get",service:new NoteService,params:params,success:function(note_list){_note_list=note_list}})},post:function(note){return CommonProvider.request({method:"save",service:new NoteService(note)})},del:function(note){return CommonProvider.request({method:"del",service:new NoteService,params:{note_id:note.note.id},success:function(_note){_note_list.result.remove(note.note),_note_list.pagination.total-=1}})},"delete":function(ids){return CommonProvider.request({method:"delete",service:new NoteService,params:{ids:ids.join(",")},success:function(_note){_note_model.get({page:_note_list.pagination.current_page})}})},item:function(note){return CommonProvider.request({method:"item",service:new NoteService,params:note})},put:function(note){return CommonProvider.request({method:"put",service:new NoteService(note.body),params:{note_id:note.id}})}};return _note_model}]),angular.module("OrganizationModel",["OrganizationService"]).factory("OrganizationModel",["OrganizationService","CommonProvider",function(OrganizationService,CommonProvider){var _organization_list,_organization_relation,_organization_model={};return _organization_model={get:function(params){return params.page=params.page||1,params.per_page=params.per_page||20,CommonProvider.request({method:"get",service:new OrganizationService,params:params,success:function(_organization_lists){_organization_list=_organization_lists}})},relation:function(params){return params.page=params.page||1,params.per_page=params.per_page||20,CommonProvider.request({method:"relation",service:new OrganizationService,params:params,success:function(_organization_relations){_organization_relation=_organization_relations}})},itemRelation:function(params){return CommonProvider.request({method:"itemRelation",service:new OrganizationService(params),params:params})},putRelation:function(relation){return CommonProvider.request({method:"putRelation",service:new OrganizationService(relation.body),params:{role:relation.role,relation_id:relation.id,organization_role:relation.organization_role}})},addRelation:function(relation){return CommonProvider.request({method:"addRelation",service:new OrganizationService(relation.body),params:{type:relation.type}})},delRelation:function(relation){return CommonProvider.request({method:"delRelation",service:new OrganizationService,params:relation,success:function(_relation){_organization_relation.result.remove(relation),_organization_relation.pagination.total-=1}})},item:function(params){return CommonProvider.request({method:"item",service:new OrganizationService,params:params,success:function(_organization_item){return _organization_item}})},getProfile:function(params){return CommonProvider.request({method:"getProfile",service:new OrganizationService(params),params:params})},putProfile:function(params){return CommonProvider.request({method:"putProfile",service:new OrganizationService(params.body),params:{role:params.role,organization_id:params.organization_id}})},add:function(organization){return CommonProvider.request({method:"save",service:new OrganizationService(organization),success:function(_organization){return _organization}})},put:function(organization){return CommonProvider.request({method:"put",service:new OrganizationService(organization["new"]),params:{role:organization.role||"user",organization_id:organization["new"].id},success:function(_organization){void 0!=organization.old&&(_organization_list.result[organization.old.$parent.$index]=_organization.result)}})},del:function(organization){return CommonProvider.request({method:"del",service:new OrganizationService,params:{organization_id:organization.organization.id},success:function(_organization){_organization_list.result.remove(organization.organization),_organization_list.pagination.total-=1}})},"delete":function(ids){return CommonProvider.request({method:"delete",service:new OrganizationService,params:{ids:ids.join(",")},success:function(_organization){_organization_model.get({page:_organization_list.pagination.current_page})}})}}}]),angular.module("PartnerModel",["PartnerService"]).factory("PartnerModel",["PartnerService","CommonProvider",function(PartnerService,CommonProvider){var _partner_lists,_partner_model={get:function(params){return CommonProvider.request({method:"get",service:new PartnerService,params:params,success:function(_partners){_partner_lists=_partners}})},add:function(partner){return CommonProvider.request({method:"save",service:new PartnerService(partner)})},del:function(params){return CommonProvider.request({method:"remove",service:new PartnerService,params:params,success:function(){_partner_lists.pagination.total-=1}})}};return _partner_model}]),angular.module("PaymentModel",["PaymentService"]).factory("PaymentModel",["PaymentService","CommonProvider",function(PaymentService,CommonProvider){var _payment_list,_payment={},_payment_service=new PaymentService;return _payment_model={pay:function(config){return CommonProvider.request({method:"pay",service:new PaymentService({course_ids:config.course_ids})})},getPayStatus:function(config){return CommonProvider.request({method:"getStatus",service:_payment_service,params:config})},payment:function(config){return CommonProvider.request({method:"payment",service:new PaymentService(config.body),params:{payment_id:config.payment_id}})},get:function(params){return params.page=params.page||1,params.per_page=params.per_page||20,CommonProvider.request({method:"get",service:new PaymentService,params:params,success:function(_payment_lists){_payment_list=_payment_lists}})},item:function(params){return CommonProvider.request({method:"item",service:new PaymentService,params:params,success:function(_payment_item){_payment.info=_payment_item}})},del:function(payment){return CommonProvider.request({method:"del",service:new PaymentService,params:{payment_id:payment.payment.id},success:function(_payment){_payment_list.result.remove(payment.payment),_payment_list.pagination.total-=1}})},"delete":function(ids){return CommonProvider.request({method:"delete",service:new PaymentService,params:{ids:ids.join(",")},success:function(_payment){_payment_model.get({page:_payment_list.pagination.current_page})}})}},_payment_model}]),angular.module("PublicModel",["PublicService"]).factory("PublicModel",["PublicService","CommonProvider",function(PublicService,CommonProvider){var _public_model={clearcache:function(params){return CommonProvider.request({method:"clearcache",service:new PublicService,params:params})},get:function(params){return CommonProvider.request({method:"get",service:new PublicService,params:params,success:function(_publics){_public_lists=_publics}})}};return _public_model}]),angular.module("QuestionModel",["QuestionService"]).factory("QuestionModel",["QuestionService","CommonProvider",function(QuestionService,CommonProvider){var _question_model={get:function(params){return CommonProvider.request({method:"get",service:new QuestionService,params:params})},post:function(question){return CommonProvider.request({method:"save",service:new QuestionService(question)})},del:function(params){return CommonProvider.request({method:"del",service:new QuestionService,params:params,success:function(_question){}})},"delete":function(ids){return CommonProvider.request({method:"delete",service:new QuestionService,params:{ids:ids.join(",")},success:function(_question){_question_model.get({page:_question_list.pagination.current_page})}})},item:function(question){return CommonProvider.request({method:"item",service:new QuestionService,params:question})},put:function(question){return CommonProvider.request({method:"put",service:new QuestionService(question.body),params:{question_id:question.id}})}};return _question_model}]),angular.module("ScoreModel",["ScoreService"]).factory("ScoreModel",["ScoreService","CommonProvider",function(ScoreService,CommonProvider){var _score_model={get:function(params){return CommonProvider.request({method:"get",service:new ScoreService,params:params})},getLevels:function(params){return CommonProvider.request({method:"getLevels",service:new ScoreService,params:params})},getRules:function(params){return CommonProvider.request({method:"getRules",service:new ScoreService,params:params})}};return _score_model}]),angular.module("SearchModel",["SearchService"]).factory("SearchModel",["SearchService","CommonProvider",function(SearchService,CommonProvider){var _search_model={get:function(params){return CommonProvider.request({method:"get",service:new SearchService,params:params})},getHotWords:function(params){return CommonProvider.request({method:"getHotWords",service:new SearchService,params:params})},putHotWords:function(hot_words){return CommonProvider.request({method:"putHotWords",service:new SearchService(hot_words)})},searchInit:function(params){return CommonProvider.request({method:"searchInit",service:new SearchService,params:{type:params.type}})},searchClean:function(params){return CommonProvider.request({method:"searchClean",service:new SearchService,params:{type:params.type}})}};return _search_model}]),angular.module("SectionModel",["SectionService"]).factory("SectionModel",["SectionService","CommonProvider",function(SectionService,CommonProvider){var _section_list,_section_item,_section_model={};return _section_model={get:function(params){
return params.page=params.page||1,params.per_page=params.per_page||20,CommonProvider.request({method:"get",service:new SectionService,params:params,success:function(_section_lists){_section_list=_section_lists}})},add:function(section){return CommonProvider.request({method:"save",service:new SectionService(section)})},put:function(section){return CommonProvider.request({method:"put",service:new SectionService(section),params:{section_id:section.id,role:section.role}})},del:function(params){return CommonProvider.request({method:"del",service:new SectionService,params:params})},"delete":function(ids){return CommonProvider.request({method:"delete",service:new SectionService,params:{ids:ids.join(",")}})},item:function(params){return CommonProvider.request({method:"item",service:new SectionService,params:params,success:function(section_item){_section_item=section_item.result}})},sort:function(sorts){return CommonProvider.request({method:"update",service:new SectionService,body:{data:sorts}})},postStudyRecord:function(params){return CommonProvider.request({method:"postStudyRecord",service:new SectionService,params:params})},getVideos:function(params){return CommonProvider.request({method:"getVideos",service:new SectionService,params:params})},getQuestions:function(params){return CommonProvider.request({method:"getQuestions",service:new SectionService,params:params})},initLiveSection:function(params){return CommonProvider.request({method:"initLiveSection",service:new SectionService,params:params})},closeLiveSection:function(params){return CommonProvider.request({method:"closeLiveSection",service:new SectionService,params:params})},getLiveUpstream:function(params){return CommonProvider.request({method:"getLiveUpstream",service:new SectionService,params:params})}}}]),angular.module("SmsModel",["SmsService"]).factory("SmsModel",["SmsService","CommonProvider",function(SmsService,CommonProvider){var _sms_list,_sms_item,_sms_model={};return _sms_model={get:function(params){return params.page=params.page||1,params.per_page=params.per_page||20,CommonProvider.request({method:"get",service:new SmsService,params:params,success:function(sms_lists){_sms_list=sms_lists}})},item:function(params){return CommonProvider.request({method:"item",service:new SmsService,params:params,success:function(sms_item){_sms_item=sms_item}})},del:function(sms){return CommonProvider.request({method:"del",service:new SmsService,params:{sms_id:sms.id},success:function(_sms){_sms_list.result.remove(sms),_sms_list.pagination.total-=1}})}}}]),angular.module("StudentModel",["StudentService"]).factory("StudentModel",["StudentService","CommonProvider",function(StudentService,CommonProvider){var _student_model={get:function(params){return CommonProvider.request({method:"get",service:new StudentService,params:params})},put:function(user){return CommonProvider.request({method:"put",service:new StudentService(user)})}};return _student_model}]),angular.module("TeacherModel",["TeacherService"]).factory("TeacherModel",["TeacherService","CommonProvider",function(TeacherService,CommonProvider){var _teacher_model={get:function(params){return CommonProvider.request({method:"get",service:new TeacherService,params:params})},incomeDetail:function(params){return CommonProvider.request({method:"incomeDetail",service:new TeacherService,params:params})},incomeDaily:function(params){return CommonProvider.request({method:"incomeDaily",service:new TeacherService,params:params})}};return _teacher_model}]),angular.module("TradeModel",["TradeService"]).factory("TradeModel",["TradeService","CommonProvider",function(TradeService,CommonProvider){var _trade_list,_trade_model={get:function(params){return params.page=params.page||1,params.per_page=params.per_page||20,CommonProvider.request({method:"get",service:new TradeService,params:params,success:function(_trade_list){_trade_list=_trade_list}})},item:function(params){return CommonProvider.request({method:"item",service:new TradeService,params:params,success:function(_trade_item){return _trade_item}})},cancel:function(trade){return CommonProvider.request({method:"cancel",service:new TradeService,params:trade,success:function(_trade){}})},del:function(trade){return CommonProvider.request({method:"del",service:new TradeService,params:{trade_id:trade.trade.id},success:function(_trade){_trade_list.result.remove(trade.trade),_trade_list.pagination.total-=1}})},"delete":function(ids){return CommonProvider.request({method:"delete",service:new TradeService,params:{ids:ids.join(",")},success:function(_trade){_trade_model.get({page:_trade_list.pagination.current_page})}})}};return _trade_model}]),angular.module("WithdrawModel",["WithdrawService"]).factory("WithdrawModel",["WithdrawService","CommonProvider",function(WithdrawService,CommonProvider){var _withdraw_list,_withdraw_model={get:function(params){return params.page=params.page||1,params.per_page=params.per_page||20,CommonProvider.request({method:"get",service:new WithdrawService,params:params,success:function(_withdraw_lists){_withdraw_list=_withdraw_lists}})},apply:function(bill){return CommonProvider.request({method:"save",service:new WithdrawService(bill)})},item:function(params){return CommonProvider.request({method:"item",service:new WithdrawService,params:params,success:function(_withdraw_item){return _withdraw_item}})},cancel:function(withdraw){return CommonProvider.request({method:"cancel",service:new WithdrawService,params:withdraw,success:function(_withdraw){}})},put:function(withdraw){return CommonProvider.request({method:"put",service:new WithdrawService(withdraw.body),params:{withdraw_id:withdraw.id}})},del:function(withdraw){return CommonProvider.request({method:"del",service:new WithdrawService,params:{withdraw_id:withdraw.withdraw.id},success:function(_withdraw){_withdraw_list.result.remove(withdraw.withdraw),_withdraw_list.pagination.total-=1}})},"delete":function(ids){return CommonProvider.request({method:"delete",service:new WithdrawService,params:{ids:ids.join(",")},success:function(_withdraw){_withdraw_model.get({page:_withdraw_list.pagination.current_page})}})}};return _withdraw_model}]),angular.module("AuthProvider",["AuthModel"]).factory("PermissionProvider",["$rootScope","$localStorage","$location","$state","CommonProvider","AuthModel",function($rootScope,$localStorage,$location,$state,CommonProvider,AuthModel){return{init:function(){$localStorage.token?CommonProvider.promise({model:AuthModel,method:"check",success:function(auth){$localStorage.user=auth.result,CommonProvider.promise({method:"menu",model:AuthModel,success:function(permissions){$rootScope.permissions=permissions.result,$rootScope.menus=$rootScope.permissions.menus,$rootScope.routes=$rootScope.permissions.grant_routes,$rootScope.admin_menu_show=!1,$rootScope.$broadcast("permissionsChanged"),$rootScope.routeCheck()}})},error:function(){$location.path("/login")}}):"/login"!=$location.$$url&&"/forgot"!=$location.$$url&&"/register"!=$location.$$url&&$location.path("/login")}}}]).factory("AuthProvider",["$rootScope","$localStorage","$location","$state","$window","CommonProvider","AuthModel",function($rootScope,$localStorage,$location,$state,$window,CommonProvider,AuthModel){var AuthProvider={init:function(callback){$localStorage.token?CommonProvider.promise({model:AuthModel,method:"check",success:function(auth){$localStorage.user=auth.result,$rootScope.user=auth.result,callback&&"function"==typeof callback&&callback(auth.result)},error:function(){delete $localStorage.token,$localStorage.user&&delete $localStorage.user}}):$localStorage.user&&delete $localStorage.user},login:function(config){CommonProvider.promise({model:AuthModel,method:"login",params:config.user,success:function(auth){return $localStorage.token=auth.result,$rootScope.setTokenLimit(config.user.auto_login),config.callback?(config.callback(auth),!1):(AuthProvider.init(),void(config.modal?$rootScope.modal.close():$location.path("/index")))},error:function(auth){$rootScope.modal.close(),$rootScope.modal.error({message:auth.message,info:auth.result})}})},logout:function(){CommonProvider.promise({model:AuthModel,method:"logout",success:function(){console.log("退出成功"),delete $rootScope.user,delete $rootScope.token,delete $localStorage.user,delete $localStorage.token,$window.location.href="/"}})},check:function(callback){var user=$rootScope.user||$localStorage.user||!1;user?callback(user):$rootScope.$watch("user",function(user){user&&callback(user)})}};return AuthProvider}]),angular.module("CommonProvider",[]).factory("CommonProvider",["$q","$rootScope","$window","$location","$anchorScroll","$modal",function($q,$rootScope,$window,$location,$anchorScroll,$modal){var commonProvider={request:function(config){if(config.method="$"+config.method,config.params=config.params||{},config.body)for(var key in config.body){var name=key,value=config.body[key];config.service[name]=config.body[key]}else config.body={};var deferred=$q.defer(),success_callback=function(result){deferred.resolve(result),1==result.code&&config.success&&"function"==typeof config.success&&eval(config.success(result))},error_callback=function(error){deferred.reject(error),config.error&&"function"==typeof config.error&&eval(config.error(error))};return config.service[config.method]&&config.service[config.method](config.params,function(result){success_callback(result)},function(error){error_callback(error)}),deferred.promise},promise:function(config){config.method=config.method,config.params=config.params||{};var success_callback=function(result){1==result.code?config.success&&"function"==typeof config.success&&eval(config.success(result)):config.error&&"function"==typeof config.error&&eval(config.error(result))},error_callback=function(error){config.error&&"function"==typeof config.error&&eval(config.error(error))},result_callback=function(result){config.result&&"function"==typeof config.result&&eval(config.result(result))};config.model[config.method]&&config.model[config.method](config.params).then(function(result){result_callback(result),success_callback(result)},function(error){result_callback(error)})},search:function(config){config.method=config.method,config.params=config.params||{},config.success=config.success,config.error=config.error;var params_length=config.params.length,params_search=[];params_length>0&&angular.forEach(config.params,function(value,key){angular.forEach(value,function(v,k){params_search["column["+key+"]["+k+"]"]=v})}),commonProvider.request({service:config.service,method:"search",params:params_search,success:config.success,error:config.error})},sort:function(config){if(config.method=config.method,config.params=config.params||{},config.data=config.data||{},config.params.partTo){for(var sorts=[],sort={},i=0;i<config.params.partTo.length;i++)sort={},sort.id=config.params.partTo[i].id,sort.data={sort:i},sorts.push(sort);config.model.sort&&config.model.sort(sorts).then(function(result){config.data.find(config.params.item).sort=config.params.indexTo})}},toTop:function(){var scrollTo=function(element,to,duration){if(!(0>=duration)){var difference=to-element.scrollTop,perTick=difference/duration*10;setTimeout(function(){element.scrollTop=element.scrollTop+perTick,element.scrollTop!=to&&scrollTo(element,to,duration-10)},10)}};scrollTo(document.body,0,30)},autoTop:function(){$rootScope.$on("$locationChangeSuccess",function(){commonProvider.toTop()})},goToDom:function(id){var old=$location.hash();$location.hash(id),$anchorScroll(),$location.hash(old)},setTabActive:function(scope,tab_index){return scope?!scope.tabs||scope.tabs&&!scope.tabs.length?!1:(scope.tabs.setAttr("active",!1),void(scope.tabs[tab_index-1].active=!0)):!1},getThumbnail:function(key,type,params){if(key){var blur,default_params={mode:1,width:500,height:300,format:"jpg",interlace:1,quality:100,blur:0},param=angular.extend(default_params,params||{});switch(param.blur){case 0:blur="";break;case 1:blur="|imageMogr2/blur/2x2";break;case 2:blur="|imageMogr2/blur/5x5";break;case 3:blur="|imageMogr2/blur/10x10"}return $rootScope.config.fileUrl+key+"?imageView2/"+param.mode+"/w/"+param.width+"/h/"+param.height+"/format/"+param.format+"/interlace/"+param.interlace+"/q/"+param.quality+blur}},share:function(type){var wb_parems="url="+$location.$$absUrl+"&title="+$rootScope.title+" - "+$rootScope.description+"&language=zh_cn&searchPic=true",qq_parems="url="+$location.$$absUrl+"&title="+$rootScope.title+"&summary="+$rootScope.description+"&site=学天下&desc=我发现了一个不错的学习网站哦，快来看看吧！&pics=",qr_parems="text="+$location.$$absUrl;switch(qr_parems=qr_parems.contain("www")?qr_parems.replace(/www/gi,"m"):qr_parems.add("m.","http://"),type){case"qq":$window.open("http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?"+qq_parems);break;case"weibo":$window.open("http://service.weibo.com/share/share.php?"+wb_parems);break;case"qrcode":$modal.image({url:"/server/api/v1/qrcode?"+qr_parems})}}};return commonProvider}]),angular.module("QuploadProvider",[]).factory("QuploadProvider",["$rootScope","appConfig",function($rootScope,appConfig){var quploadProvider={getThumbnail:function(key,type,params){if(key&&""!=key){var default_params={mode:1,width:500,height:300,format:"jpg",interlace:1,quality:100,blur:0};void 0==params&&(params={});var blur,param=angular.extend(default_params,params);0==param.blur?blur="":1==param.blur?blur="|imageMogr2/blur/2x2":2==param.blur?blur="|imageMogr2/blur/5x5":3==param.blur&&(blur="|imageMogr2/blur/10x10");var thumbnail_src=appConfig.fileUrl+key+"?imageView2/"+param.mode+"/w/"+param.width+"/h/"+param.height+"/format/"+param.format+"/interlace/"+param.interlace+"/q/"+param.quality+blur;return thumbnail_src}},getStatic:function(key,params){if(key&&""!=key){var default_params={mode:1,width:500,height:300,format:"jpg",interlace:1,quality:100,blur:0};void 0==params&&(params={});var blur,param=angular.extend(default_params,params);0==param.blur?blur="":1==param.blur?blur="|imageMogr2/blur/2x2":2==param.blur?blur="|imageMogr2/blur/5x5":3==param.blur&&(blur="|imageMogr2/blur/10x10");var thumbnail_src=appConfig.staticUrl+key+"?imageView2/"+param.mode+"/w/"+param.width+"/h/"+param.height+"/format/"+param.format+"/interlace/"+param.interlace+"/q/"+param.quality+blur;return thumbnail_src}}};return quploadProvider}]),angular.module("HtmlFilter",[]).filter("toHtml",["$sce",function($sce){return function(text){return $sce.trustAsHtml(text)}}]).filter("textOverflow",["$sce",function($sce){return function(text,length){return length&&text&&text.length>length?text.substr(0,length)+"...":text}}]).filter("priceFormat",[function(){return function(text){return isNaN(text)?text:text.toFixed(2)}}]).filter("readMore",function(){return function(content,length,text){var more_btn='...<a class="read-more">&nbsp;&nbsp;'+(text||"查看全部")+"&nbsp;>></a>";return 0!=content.length&&content.length<length?content:content.substr(0,length)+more_btn}}),angular.module("TimeFilter",[]).filter("dateFilter",["dateFilter",function(dateFilter){return function(text){return dateFilter(text,"yyyy-MM-dd")}}]).filter("toYMD",[function(){return function(date){return date?date.toString().substr(0,10):date}}]).filter("relativeTime",["$rootScope",function($rootScope){return function(time){return $rootScope.moment.from(time,!1)}}]).filter("toHHMMSS",function(){return function(sec,type,h_slug,m_slug,s_slug){var sec_num=parseInt(sec,10),hours=Math.floor(sec_num/3600),minutes=Math.floor((sec_num-3600*hours)/60),seconds=sec_num-3600*hours-60*minutes;10>hours&&(hours="0"+hours),10>minutes&&(minutes="0"+minutes),10>seconds&&(seconds="0"+seconds);var hour_display,minute_display,second_display;type?(hour_display=type.indexOf("H")>-1&&hours>0,minute_display=type.indexOf("M")>-1,second_display=type.indexOf("S")>-1):hour_display=minute_display=second_display=!0;var hour_slug=void 0!=h_slug?h_slug:":",minute_slug=void 0!=m_slug?m_slug:":",second_slug=void 0!=s_slug?s_slug:"",time=(hour_display?hours+hour_slug:"")+(minute_display?minutes+minute_slug:"")+(second_display?seconds+second_slug:"");return time}}),angular.module("AppRoutes",[]).config(["$stateProvider","$urlRouterProvider","$httpProvider","$locationProvider",function($stateProvider,$urlRouterProvider,$httpProvider,$locationProvider){$urlRouterProvider.otherwise("/"),$stateProvider.state("index",{url:"/",templateUrl:"/partials/home/index/index.html",controller:"IndexController",data:{title:"首页",url:"/"}}).state("ui",{url:"/ui",templateUrl:"/partials/home/index/ui.html",controller:"IndexController",data:{title:"UI",url:""}}).state("mobile",{url:"/mobile",templateUrl:"/partials/home/index/mobile.html",controller:"IndexController",data:{title:"APP客户端下载",url:""}}).state("auth",{"abstract":!0,url:"/auth",template:'<div ui-view class="no-animation"></div>',controller:"AuthController",data:{title:"授权模块",url:"/auth"}}).state("auth.login",{url:"/login",templateUrl:"/partials/home/auth/login.html",controller:"AuthController",data:{title:"用户登录",url:"/auth/login"}}).state("auth.register",{url:"/register",templateUrl:"/partials/home/auth/register.html",controller:"AuthController",data:{title:"用户注册",url:"/auth/register"}}).state("auth.login_welfare",{url:"/login/welfare",templateUrl:"/partials/home/auth/welfare.html",controller:"AuthController",data:{title:"公益用户登录",url:"/auth/login/welfare"}}).state("auth.forgot",{url:"/forgot",templateUrl:"/partials/home/auth/forgot.html",controller:"AuthController",data:{title:"找回密码",url:"/auth/login/forgot"}}).state("auth.bind",{url:"/bind",templateUrl:"/partials/home/auth/bind.html",controller:"AuthController",data:{title:"账户绑定",url:"/auth/bind"}}).state("article_license",{url:"/article/license",templateUrl:"/partials/home/article/license.html",controller:"ArticleController",data:{title:"学天下注册协议",url:"/article/license",slug:""}}).state("article",{url:"/article/list/:category_id",templateUrl:"/partials/home/article/index.html",controller:"ArticleController",data:{title:"文章列表",url:"",slug:""}}).state("course",{url:"/course",templateUrl:"/partials/home/course/lists.html",controller:"CourseController",data:{title:"课程列表",url:"/course"}}).state("course_search_error",{url:"/course/search",templateUrl:"/partials/home/course/lists.html",controller:"CourseController",data:{title:"课程列表",url:""}}).state("course_search",{url:"/course/search/:key",templateUrl:"/partials/home/course/lists.html",controller:"CourseController",data:{title:"课程搜索",url:""}}).state("course_list",{url:"/course/list/:category_id",templateUrl:"/partials/home/course/lists.html",controller:"CourseController",data:{title:"课程分类",url:""}}).state("course_detail",{url:"/course/:course_id",templateUrl:"/partials/home/course/detail.html",controller:"CourseController",data:{title:"课程详情",url:""}}).state("course_learn",{url:"/course/:course_id/learn/:section_id",templateUrl:"/partials/home/course/learn.html",controller:"LearnController",data:{title:"课程播放",url:""}}).state("course_learn_from_record",{url:"/course/:course_id/learn/:section_id/:record_time",templateUrl:"/partials/home/course/learn.html",controller:"LearnController",data:{title:"课程播放",url:""}}).state("course_buy",{url:"/course/:course_id/buy",templateUrl:"/partials/home/course/detail.html",controller:"CourseController",data:{title:"课程购买",url:""}}).state("payment_error",{url:"/payment/error",templateUrl:"/partials/home/course/buy-error.html",controller:"PaymentController",data:{title:"支付失败",url:"/payment/error"}}).state("payment",{url:"/payment/:course_ids",templateUrl:"/partials/home/course/payment.html",controller:"PaymentController",data:{title:"课程支付",url:""}}).state("payment_success",{url:"/payment/:course_ids/success",templateUrl:"/partials/home/course/buy-success.html",controller:"PaymentController",data:{title:"支付成功",url:"/payment/success"}}).state("organization_list",{url:"/organization",templateUrl:"/partials/home/organization/list.html",controller:"OrganizationlController",data:{title:"学校列表"}}).state("organization_search_error",{url:"/organization/search",templateUrl:"/partials/home/organization/list.html",controller:"OrganizationlController",data:{title:"学校列表"}}).state("organization_search",{url:"/organization/search/:key",templateUrl:"/partials/home/organization/search.html",controller:"OrganizationlController",data:{title:"学校列表"}}).state("organization",{url:"/organization/:organization_id",templateUrl:"/partials/home/organization/index.html",controller:"OrganizationlController",data:{title:"机构主页"}}).state("student_index",{url:"/space/student/:student_id",templateUrl:"/partials/home/student/index.html",controller:"StudentController",data:{title:"学生主页",url:""}}).state("teacher_index",{url:"/organization/:organization_id/teacher/:teacher_id",templateUrl:"/partials/home/organization/teacher.html",controller:"OrganizationlController",data:{title:"老师主页",url:""}}).state("user",{"abstract":!0,url:"/user",templateUrl:"/partials/home/user/sidebar.html",controller:"UserController",data:{title:"个人中心",url:"/user/index"}}).state("user.index",{url:"/index",templateUrl:"/partials/home/user/index.html",controller:"UserController",data:{title:"",url:"",slug:"index"}}).state("user.course",{url:"/course",templateUrl:"/partials/home/user/course.html",controller:"UserController",data:{title:"我的课程",url:"",slug:"course"}}).state("user.history",{url:"/history",templateUrl:"/partials/home/user/history.html",controller:"UserController",data:{title:"学习记录",url:"",slug:"history"}}).state("user.favorite",{url:"/favorite",templateUrl:"/partials/home/user/favorite.html",controller:"UserController",data:{title:"我的收藏",url:"",slug:"favorite"}}).state("user.question",{url:"/question",templateUrl:"/partials/home/user/question/list.html",controller:"UserController",data:{title:"我的问答",url:"",slug:"question"}}).state("user.question_detail",{url:"/question/:question_id",templateUrl:"/partials/home/user/question/detail.html",controller:"UserController",data:{title:"问答详情",url:"",slug:"question"}}).state("user.note",{url:"/note",templateUrl:"/partials/home/user/note/list.html",controller:"UserController",data:{title:"我的笔记",url:"",slug:"note"}}).state("user.profile",{url:"/profile",templateUrl:"/partials/home/user/profile.html",controller:"UserController",data:{title:"个人资料",url:"",slug:"profile"}}).state("user.password",{url:"/password",templateUrl:"/partials/home/user/password.html",controller:"UserController",data:{title:"修改密码",url:"",slug:"password"}}).state("user.account",{url:"/account",templateUrl:"/partials/home/user/account.html",controller:"AuthController",data:{title:"账户绑定",url:"",slug:"account"}}).state("user.bill",{url:"/bill",templateUrl:"/partials/home/user/bill.html",controller:"UserController",data:{title:"账单明细",url:"",slug:"bill"}}).state("user.score",{url:"/score",templateUrl:"/partials/home/user/score.html",controller:"UserController",data:{title:"积分明细",url:"",slug:"score"}}).state("user.msg",{url:"/msg",templateUrl:"/partials/home/user/msg.html",controller:"UserController",data:{title:"通知中心",url:"",slug:"msg"}}).state("user.medal",{url:"/medal",templateUrl:"/partials/home/user/medal.html",controller:"UserController",data:{title:"勋章中心",url:"",slug:"medal"}}).state("user.coupons",{url:"/coupons",templateUrl:"/partials/home/user/coupons.html",controller:"UserController",data:{title:"我的卡券",url:"",slug:"coupons"}}).state("teacher",{"abstract":!0,url:"/teacher",templateUrl:"/partials/home/teacher/sidebar.html",controller:"TeacherController",data:{title:"教师中心",url:"/teacher/index",slug:"index"}}).state("teacher.index",{url:"/index",templateUrl:"/partials/home/teacher/index.html",controller:"TeacherController",data:{title:"",url:"",slug:"index"}}).state("teacher.trade",{url:"/trade",templateUrl:"/partials/home/teacher/trade.html",controller:"TeacherController",data:{title:"已售课程",url:"/teacher/trade",slug:"trade"}}).state("teacher.rate",{url:"/rate",templateUrl:"/partials/home/teacher/rate/list.html",controller:"TeacherController",data:{title:"评价管理",url:"/teacher/rate",slug:"rate"}}).state("teacher.course",{"abstract":!0,url:"/course",template:'<div class="box lesson slide-top" ui-view></div>',controller:"LessonController",data:{title:"我的课程",url:"/teacher/course/list",slug:"course"}}).state("teacher.course.list",{url:"/list",templateUrl:"/partials/home/teacher/course/course-list.html",controller:"LessonController",data:{title:"已开课程",url:"",slug:"course"}}).state("teacher.course.add",{url:"/add",templateUrl:"/partials/home/teacher/course/course-edit.html",controller:"LessonController",data:{title:"发布课程",url:"",slug:"course-add"}}).state("teacher.course.edit",{url:"/edit/:course_id",templateUrl:"/partials/home/teacher/course/course-edit.html",controller:"LessonController",data:{title:"编辑课程",url:"",slug:"course"}}).state("teacher.course.section_edit",{url:"/section/edit/:course_id",templateUrl:"/partials/home/teacher/course/section-edit.html",controller:"LessonController",data:{title:"编辑章节",url:"",slug:"course"}}).state("teacher.organization",{"abstract":!0,url:"/organization",template:'<div class="box organization slide-top" ui-view></div>',controller:"SchoolController",data:{title:"我的学校",url:"/teacher/organization/list",slug:"organization"}}).state("teacher.organization.list",{url:"/list",templateUrl:"/partials/home/teacher/organization/list.html",controller:"SchoolController",data:{title:"",url:"/teacher/organization/index",slug:"organization"}}).state("teacher.organization.search",{url:"/search",templateUrl:"/partials/home/teacher/organization/search.html",controller:"SchoolController",data:{title:"搜索学校",url:""}}).state("teacher.organization.add",{url:"/add",templateUrl:"/partials/home/teacher/organization/add.html",controller:"SchoolController",data:{title:"创建学校",url:""}}).state("teacher.organization.join",{url:"/join/:organization_id",templateUrl:"/partials/home/teacher/organization/join.html",controller:"SchoolController",data:{title:"加入学校",url:""}}).state("teacher.organization.manage",{url:"/manage/:organization_id",templateUrl:"/partials/home/teacher/organization/manage.html",controller:"SchoolController",data:{title:"学校管理",url:""}}).state("teacher.income",{"abstract":!0,url:"/income",template:'<div class="income box slide-top" ui-view></div>',controller:"IncomeController",data:{title:"我的收入",url:"/teacher/income/index",slug:"income"}}).state("teacher.income.index",{url:"/index",templateUrl:"/partials/home/teacher/income/index.html",controller:"IncomeController",data:{title:"",url:"",slug:"income"}}).state("teacher.income.details",{url:"/details",templateUrl:"/partials/home/teacher/income/details.html",controller:"IncomeController",data:{title:"收入明细",url:""}}).state("teacher.income.apply",{url:"/apply",templateUrl:"/partials/home/teacher/income/apply.html",controller:"IncomeController",data:{title:"申请提现",url:"",slug:"apply"}}).state("teacher.income.record",{url:"/record",templateUrl:"/partials/home/teacher/income/record.html",controller:"IncomeController",data:{title:"提现记录",url:""}}).state("teacher.income.account_list",{url:"/account-list",templateUrl:"/partials/home/teacher/income/account-list.html",controller:"IncomeController",data:{title:"管理账户",url:""}}).state("teacher.income.account_add",{url:"/account-add",templateUrl:"/partials/home/teacher/income/account-add.html",controller:"IncomeController",data:{title:"添加账户",url:""}}).state("teacher.profile",{url:"/profile",templateUrl:"/partials/home/user/profile.html",controller:"UserController",data:{title:"个人资料",url:"",slug:"profile"}}).state("teacher.password",{url:"/password",templateUrl:"/partials/home/user/password.html",controller:"UserController",data:{title:"修改密码",url:"",slug:"password"}}).state("teacher.account",{url:"/account",templateUrl:"/partials/home/user/account.html",controller:"AuthController",data:{title:"账户绑定",url:"",slug:"account"}}),$locationProvider.html5Mode(!0),$httpProvider.interceptors.push(["$rootScope","$q","$localStorage",function($rootScope,$q,$localStorage){return{request:function(config){return config.url.contain("http://up.qiniu.com")||(config.headers=config.headers||{},$localStorage.token&&(config.headers.Authorization="Bearer "+$localStorage.token)),$rootScope.updateToken(),config},response:function(response){return $q.when(response)},responseError:function(response){switch($rootScope.modal.closeLoading(),response.status){case 401:delete $localStorage.token,$rootScope.user=null;break;case 403:break;case 404:break;case 422:break;case 500:$rootScope.modal.error({message:"500 ERROR!"})}return $q.reject(response)}}}])}]),angular.module("app",["ui.router","ngStorage","ngResource","ngSanitize","ngAnimate","AppRoutes","angular.modal","angular.loading","TabsDirective","TooltipDirective","PaginationDirective","LoadingDirective","CourseListDirective","MainController","ArticleController","HeaderController","AuthController","IndexController","CourseController","LearnController","PaymentController","OrganizationlController","UserController","StudentController","IncomeController","LessonController","TeacherController","SchoolController","HtmlFilter","TimeFilter","CommonProvider","AuthProvider","QuploadProvider","AuthService","CommonService","CommonModel"]).provider("appConfig",function(){var config={baseUrl:"http://xtx.com",fileUrl:"http://7xnbft.com2.z0.glb.qiniucdn.com/",staticUrl:"http://7xpb5v.com2.z0.glb.qiniucdn.com",apiUrl:"/server/api/v1"};return{config:config,$get:function(){return config}}}).run(["AuthProvider","CommonProvider",function(AuthProvider,CommonProvider){AuthProvider.init(),CommonProvider.autoTop()}]).config(["cfpLoadingBarProvider",function(cfpLoadingBarProvider){cfpLoadingBarProvider.includeSpinner=!1,cfpLoadingBarProvider.includeBar=!1,cfpLoadingBarProvider.latencyThreshold=10}]).config(function($validationProvider,appConfigProvider){angular.extend($validationProvider,{validCallback:function(element){$(element).parents(".form-group:first").removeClass("has-error").addClass("has-success")},invalidCallback:function(element){$(element).parents(".form-group:first").addClass("has-error")}}),$validationProvider.setErrorHTML(function(msg){return'<i class="icon icon-error"></i>'+msg}),$validationProvider.setSuccessHTML(function(msg){return'<i class="icon icon-success"></i>'+msg})});